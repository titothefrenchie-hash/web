<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Funded Trust</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,300;0,400;0,500;1,300&family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>
<script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d1117;--bg2:#111820;--bg3:#161e27;
  --surface:#1a2332;--surface2:#1f2b3d;--surface3:#243346;
  --border:rgba(148,180,220,0.1);--border2:rgba(148,180,220,0.2);
  --blue:#7aa8d4;--blue2:#a8c8e8;--blue3:#4a7fa8;--accent:#c8dff0;
  --text:#e8f0f8;--muted:#5a7a9a;--muted2:#4a6a8a;--white:#ffffff;
  --red:#e07070;--green:#70c090;--yellow:#d4b870;--purple:#9a80c8;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'IBM Plex Mono',monospace;overflow:hidden}
body::after{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:0.5}
.screen{position:fixed;inset:0;transition:opacity 0.6s ease,transform 0.6s ease}
.screen.hidden{display:none!important}
/* LOGIN */
#login{display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse 100% 100% at 50% 50%,#0d1e30 0%,var(--bg) 65%)}
.login-card{text-align:center}
.login-card{width:400px;padding:64px 52px;background:var(--surface);border:1px solid var(--border2);box-shadow:0 0 120px rgba(74,127,168,0.1),inset 0 1px 0 rgba(148,180,220,0.06);text-align:center}
.login-wordmark{font-family:'Playfair Display',serif;font-size:28px;letter-spacing:0.25em;text-transform:uppercase;color:var(--blue2);margin-bottom:8px}
.login-tagline{font-size:9px;letter-spacing:0.22em;text-transform:uppercase;color:var(--muted);margin-bottom:56px}
.form-label{font-size:9px;letter-spacing:0.2em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;display:block}
.form-input{width:100%;background:var(--bg2);border:1px solid var(--border);border-bottom:1px solid var(--blue3);color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:13px;padding:13px 14px;outline:none;transition:border-color 0.2s,background 0.2s;margin-bottom:20px}
.form-input:focus{border-color:var(--blue);background:var(--bg3)}
.form-input::placeholder{color:var(--muted2)}
.login-btn{width:100%;padding:15px;background:var(--blue3);color:var(--white);border:none;font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:0.25em;text-transform:uppercase;cursor:pointer;transition:background 0.2s}
.login-btn:hover{background:var(--blue)}
.login-err{font-size:10px;color:var(--red);margin-top:12px;text-align:center;height:16px}
/* APP SHELL */
#app{display:flex;flex-direction:column;height:100vh;overflow:hidden}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:0 20px 0 0;height:54px;background:var(--bg);border-bottom:1px solid var(--border);flex-shrink:0;z-index:100}
.topbar-logo{font-family:'Playfair Display',serif;font-size:11px;letter-spacing:0.3em;text-transform:uppercase;color:var(--blue2);padding:0 20px;height:100%;display:flex;align-items:center;cursor:pointer;border-right:1px solid var(--border);min-width:200px}
.topbar-logo:hover{color:var(--accent)}
.topbar-greeting{font-family:'Playfair Display',serif;font-size:16px;font-weight:300;color:var(--white);margin-left:20px}
.topbar-right{display:flex;align-items:center;gap:14px;margin-left:auto}
.topbar-date{font-size:9px;color:var(--muted);letter-spacing:0.1em}
.btn-sm{background:none;border:1px solid var(--border);color:var(--muted);font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:0.15em;text-transform:uppercase;padding:7px 14px;cursor:pointer;transition:all 0.2s}
.btn-sm:hover{color:var(--text);border-color:var(--border2)}
.btn-sm.lit{color:var(--blue2);border-color:var(--blue3)}
.app-body{flex:1;overflow:hidden;display:flex}
/* GLOBAL NAV SIDEBAR */
.global-nav{width:200px;flex-shrink:0;background:var(--bg);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;z-index:50}
.global-nav::-webkit-scrollbar{width:3px}
.global-nav::-webkit-scrollbar-thumb{background:var(--border2)}
.gnav-section{padding:12px 0 4px;border-bottom:1px solid var(--border)}
.gnav-section:last-child{border-bottom:none;flex:1}
.gnav-lbl{padding:6px 16px 4px;font-size:8px;letter-spacing:0.22em;text-transform:uppercase;color:var(--muted2)}
.gnav-item{padding:9px 16px;font-size:10px;letter-spacing:0.06em;color:var(--muted);cursor:pointer;transition:all 0.18s;display:flex;align-items:center;gap:9px;border-left:2px solid transparent;white-space:nowrap}
.gnav-item:hover{color:var(--text);background:var(--surface)}
.gnav-item.active{color:var(--blue2);background:var(--surface);border-left-color:var(--blue)}
.gnav-icon{font-size:13px;width:16px;text-align:center;flex-shrink:0}
/* MAIN AREA */
.main-content{flex:1;overflow:hidden;display:flex}
/* HOME / AI COMMAND CENTER */
#home-view{display:flex;flex:1;overflow:hidden;background:var(--bg2)}
.home-left{width:320px;flex-shrink:0;border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;background:var(--bg)}
.home-left-hdr{padding:16px 18px;border-bottom:1px solid var(--border);font-size:9px;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted)}
.watchlist-item{padding:10px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s;display:flex;align-items:center;justify-content:space-between}
.watchlist-item:hover{background:var(--surface)}
.wi-ticker{font-size:12px;color:var(--blue2);letter-spacing:0.08em;font-weight:500}
.wi-name{font-size:9px;color:var(--muted);margin-top:1px}
.wi-price{text-align:right}
.wi-p{font-size:12px;color:var(--white)}
.wi-chg{font-size:9px;margin-top:1px}
.home-chat{flex:1;display:flex;flex-direction:column;overflow:hidden}
.chat-messages{flex:1;overflow-y:auto;padding:20px 24px;display:flex;flex-direction:column;gap:14px}
.chat-messages::-webkit-scrollbar{width:4px}
.chat-messages::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.chat-msg{display:flex;gap:10px;animation:fadeUp 0.3s ease both}
.chat-msg.user{flex-direction:row-reverse}
.msg-bubble{max-width:75%;padding:11px 15px;font-size:12px;line-height:1.65;border-radius:0}
.chat-msg.ai .msg-bubble{background:var(--surface);border:1px solid var(--border);color:var(--text);border-left:2px solid var(--blue3)}
.chat-msg.user .msg-bubble{background:rgba(74,127,168,0.15);border:1px solid rgba(74,127,168,0.25);color:var(--text);border-right:2px solid var(--blue3)}
.msg-avatar{width:28px;height:28px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;background:var(--surface);border:1px solid var(--border);color:var(--muted)}
.chat-input-row{padding:14px 18px;border-top:1px solid var(--border);display:flex;gap:10px;background:var(--bg);flex-shrink:0}
.chat-input{flex:1;background:var(--bg2);border:1px solid var(--border);border-bottom:1px solid var(--blue3);color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:12px;padding:10px 12px;outline:none;resize:none;min-height:40px;max-height:120px;transition:border-color 0.2s}
.chat-input:focus{border-color:var(--blue);background:var(--bg3)}
.chat-send{padding:10px 18px;background:var(--blue3);border:none;color:white;font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:0.15em;text-transform:uppercase;cursor:pointer;transition:background 0.2s;flex-shrink:0;align-self:flex-end}
.chat-send:hover{background:var(--blue)}
.chat-typing{display:flex;gap:4px;align-items:center;padding:4px 0}
.chat-typing span{width:5px;height:5px;background:var(--blue3);border-radius:50%;animation:blink 1.2s infinite}
.chat-typing span:nth-child(2){animation-delay:0.2s}
.chat-typing span:nth-child(3){animation-delay:0.4s}
@keyframes blink{0%,80%,100%{opacity:0.2}40%{opacity:1}}
/* SCANNER */
#scanner-view{display:none;flex:1;overflow:hidden;flex-direction:column;background:var(--bg2)}
.scanner-top{display:flex;gap:0;border-bottom:1px solid var(--border);background:var(--bg);flex-shrink:0;flex-wrap:wrap}
.scan-tab{padding:12px 20px;font-size:9px;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.2s;white-space:nowrap}
.scan-tab:hover{color:var(--text)}
.scan-tab.active{color:var(--blue2);border-bottom-color:var(--blue)}
.scanner-body{flex:1;display:flex;overflow:hidden}
.scanner-filters{width:220px;flex-shrink:0;background:var(--bg);border-right:1px solid var(--border);overflow-y:auto;padding:14px}
.scanner-filters::-webkit-scrollbar{width:3px}
.sf-section{margin-bottom:18px}
.sf-title{font-size:8px;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid var(--border)}
.sf-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;font-size:10px;color:var(--muted)}
.sf-toggle{width:32px;height:17px;background:var(--surface3);border:1px solid var(--border);border-radius:8px;cursor:pointer;position:relative;transition:background 0.2s;flex-shrink:0}
.sf-toggle.on{background:var(--blue3);border-color:var(--blue3)}
.sf-toggle::after{content:'';position:absolute;top:2px;left:2px;width:11px;height:11px;background:white;border-radius:50%;transition:transform 0.2s}
.sf-toggle.on::after{transform:translateX(15px)}
.sf-input{width:70px;background:var(--bg2);border:1px solid var(--border);color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:10px;padding:3px 6px;outline:none}
.sf-input:focus{border-color:var(--blue3)}
.scan-btn{width:100%;padding:9px;background:var(--blue3);border:none;color:white;font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:0.18em;text-transform:uppercase;cursor:pointer;transition:background 0.2s;margin-top:4px}
.scan-btn:hover{background:var(--blue)}
.scanner-results{flex:1;display:flex;flex-direction:column;overflow:hidden}
.scanner-results-top{padding:12px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;background:var(--bg)}
.scanner-chart{flex:1;overflow:hidden;position:relative}
.scanner-list{width:300px;flex-shrink:0;border-left:1px solid var(--border);overflow-y:auto;background:var(--bg)}
.scan-result-item{padding:10px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s;display:flex;align-items:center;justify-content:space-between}
.scan-result-item:hover{background:var(--surface)}
.scan-result-item.selected{background:var(--surface2);border-left:2px solid var(--blue)}
.sri-ticker{font-size:12px;color:var(--blue2);font-weight:500;letter-spacing:0.05em}
.sri-signal{font-size:8px;letter-spacing:0.1em;text-transform:uppercase;padding:2px 6px;border-radius:2px}
.sri-signal.long{background:rgba(112,192,144,0.15);color:var(--green);border:1px solid rgba(112,192,144,0.3)}
.sri-signal.short{background:rgba(224,112,112,0.15);color:var(--red);border:1px solid rgba(224,112,112,0.3)}
.sri-signal.neutral{background:rgba(90,122,154,0.15);color:var(--muted);border:1px solid var(--border)}
.alert-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.alert-dot.live{background:var(--green);box-shadow:0 0 6px var(--green);animation:pulse-dot 1.5s infinite}
@keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:0.4}}
/* RE MODULE */
#re-view{flex:1;overflow:hidden;flex-direction:row}
.re-sidebar{width:210px;flex-shrink:0;background:var(--bg);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.sidebar-hdr{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.sidebar-title{font-size:9px;letter-spacing:0.2em;text-transform:uppercase;color:var(--muted)}
.sidebar-add{width:22px;height:22px;background:var(--blue3);border:none;color:white;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;padding-bottom:1px;line-height:1}
.sidebar-add:hover{background:var(--blue)}
.sidebar-nav{padding:6px 0;border-bottom:1px solid var(--border)}
.snav-item{padding:9px 16px;font-size:10px;letter-spacing:0.08em;color:var(--muted);cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:8px;border-left:2px solid transparent}
.snav-item:hover{color:var(--text);background:var(--surface)}
.snav-item.active{color:var(--blue2);background:var(--surface);border-left-color:var(--blue3)}
.snav-item .ni{font-size:12px;width:16px;text-align:center;opacity:0.7}
.sidebar-sec-lbl{padding:10px 16px 4px;font-size:8px;letter-spacing:0.2em;text-transform:uppercase;color:var(--muted2)}
.prop-list{flex:1;overflow-y:auto;padding:4px 0}
.prop-item{padding:9px 16px;cursor:pointer;transition:all 0.2s;border-left:2px solid transparent}
.prop-item:hover{background:var(--surface)}
.prop-item.active{background:var(--surface);border-left-color:var(--blue)}
.prop-item-name{font-size:10px;color:var(--text);margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.prop-item-sub{font-size:9px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.prop-list::-webkit-scrollbar{width:3px}
.prop-list::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
/* RE MAIN */
.re-main{flex:1;overflow-y:auto;background:var(--bg2)}
.re-main::-webkit-scrollbar{width:5px}
.re-main::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
.re-summary{display:grid;gap:0;border-bottom:1px solid var(--border);background:var(--bg)}
.sum-cell{padding:18px 24px;border-right:1px solid var(--border)}
.sum-cell:last-child{border-right:none}
.sum-lbl{font-size:8px;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);margin-bottom:5px}
.sum-val{font-family:'Playfair Display',serif;font-size:24px;font-weight:300;color:var(--white)}
.sum-sub{font-size:9px;color:var(--muted);margin-top:3px}
.re-content{padding:24px 28px}
.page-title{font-family:'Playfair Display',serif;font-size:22px;font-weight:400;color:var(--white);margin-bottom:4px}
.page-sub{font-size:9px;color:var(--muted);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:22px}
/* TABS */
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:22px;overflow-x:auto}
.tab{padding:10px 18px;font-size:9px;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);cursor:pointer;transition:all 0.2s;border-bottom:2px solid transparent;margin-bottom:-1px;white-space:nowrap}
.tab:hover{color:var(--text)}
.tab.active{color:var(--blue2);border-bottom-color:var(--blue3)}
/* FORMS */
.fs{background:var(--surface);border:1px solid var(--border);padding:22px;margin-bottom:18px}
.fs-title{font-size:9px;letter-spacing:0.2em;text-transform:uppercase;color:var(--blue2);margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.fg{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.fg.g3{grid-template-columns:repeat(3,1fr)}
.fg.g4{grid-template-columns:repeat(4,1fr)}
.fgrp{display:flex;flex-direction:column;gap:5px}
.fgrp.full{grid-column:1/-1}
.fl{font-size:9px;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted)}
.fi,.fsl,.fta{background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:12px;padding:9px 11px;outline:none;transition:border-color 0.2s;width:100%}
.fi:focus,.fsl:focus,.fta:focus{border-color:var(--blue3)}
.fsl{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%235a7a9a'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center}
.fsl option{background:var(--bg2)}
.fta{resize:vertical;min-height:68px}
.btn-p{padding:10px 20px;background:var(--blue3);color:var(--white);border:none;font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:0.2em;text-transform:uppercase;cursor:pointer;transition:background 0.2s}
.btn-p:hover{background:var(--blue)}
.btn-s{padding:10px 20px;background:transparent;color:var(--muted);border:1px solid var(--border);font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:0.2em;text-transform:uppercase;cursor:pointer;transition:all 0.2s}
.btn-s:hover{color:var(--text);border-color:var(--border2)}
.btn-d{padding:6px 12px;background:transparent;color:var(--red);border:1px solid rgba(224,112,112,0.3);font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;transition:all 0.2s}
.btn-d:hover{background:rgba(224,112,112,0.1)}
.btn-a{padding:7px 14px;background:var(--surface);border:1px solid var(--border);color:var(--blue2);font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:0.12em;text-transform:uppercase;cursor:pointer;transition:all 0.2s}
.btn-a:hover{background:var(--surface2);border-color:var(--blue3)}
.brow{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
/* TABLES */
.tw{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:11px}
th{font-size:8px;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);padding:9px 11px;text-align:left;border-bottom:1px solid var(--border);background:var(--bg);white-space:nowrap}
td{padding:9px 11px;border-bottom:1px solid rgba(148,180,220,0.05);vertical-align:middle}
tr:hover td{background:rgba(26,35,50,0.6)}
.tde{background:var(--bg);border:none;color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:11px;padding:3px 5px;outline:none;width:100%;border-bottom:1px solid transparent;transition:border-color 0.2s}
.tde:focus{border-bottom-color:var(--blue3)}
.tds{background:var(--bg);border:none;color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:10px;padding:3px 5px;outline:none;cursor:pointer;width:100%;border-bottom:1px solid transparent;appearance:none}
.tds option{background:var(--bg2)}
.tr-tot td{background:var(--surface2)!important;font-weight:500;color:var(--white);border-top:1px solid var(--border)}
.pos{color:var(--green)}.neg{color:var(--red)}.neu{color:var(--blue2)}
.xbtn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:13px;padding:2px 5px;transition:color 0.2s;line-height:1}
.xbtn:hover{color:var(--red)}
/* STATS */
.stat-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:22px}
.stat-box{background:var(--surface);border:1px solid var(--border);padding:14px;text-align:center}
.stat-lbl{font-size:8px;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);margin-bottom:5px}
.stat-val{font-family:'Playfair Display',serif;font-size:19px;font-weight:300;color:var(--white)}
/* NET BAR */
.net-bar{display:flex;gap:28px;padding:14px 18px;background:var(--surface);border:1px solid var(--border);margin-top:14px;flex-wrap:wrap}
.net-item{display:flex;flex-direction:column;gap:3px}
.net-lbl{font-size:8px;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted)}
.net-val{font-family:'Playfair Display',serif;font-size:19px;font-weight:300}
/* FINANCE CONTROLS */
.fctrls{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:10px;flex-wrap:wrap}
.frow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.fsel{background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:9px;padding:6px 10px;outline:none;cursor:pointer;appearance:none}
.fsel option{background:var(--bg2)}
/* DEPRECIATION */
.macrs-cur td{background:rgba(74,127,168,0.12)!important;border-left:2px solid var(--blue3)}
.badge{display:inline-block;padding:2px 7px;font-size:8px;letter-spacing:0.1em;border-radius:2px;text-transform:uppercase}
.bg-blue{background:rgba(74,127,168,0.15);border:1px solid rgba(74,127,168,0.3);color:var(--blue2)}
.bg-green{background:rgba(112,192,144,0.12);border:1px solid rgba(112,192,144,0.25);color:var(--green)}
.bg-yellow{background:rgba(212,184,112,0.12);border:1px solid rgba(212,184,112,0.25);color:var(--yellow)}
.bg-red{background:rgba(224,112,112,0.12);border:1px solid rgba(224,112,112,0.25);color:var(--red)}
/* STATEMENTS */
.stmt-sec{background:var(--surface);border:1px solid var(--border);margin-bottom:16px}
.stmt-sec-hdr{padding:12px 18px;background:var(--bg);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.stmt-sec-hdr-title{font-size:9px;letter-spacing:0.15em;text-transform:uppercase;color:var(--blue2)}
.stmt-sec-body{padding:16px 18px}
/* TENANT */
.tenant-card{background:var(--surface);border:1px solid var(--border);padding:18px;margin-bottom:12px}
.tenant-card:hover{border-color:var(--border2)}
.tenant-name{font-family:'Playfair Display',serif;font-size:16px;color:var(--white);margin-bottom:3px}
.tenant-meta{font-size:9px;color:var(--muted);margin-bottom:12px}
.tig{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px}
.ti-item{display:flex;flex-direction:column;gap:2px}
.ti-lbl{font-size:8px;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted)}
.ti-val{font-size:11px;color:var(--text)}
/* MODAL */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:500;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.2s}
.modal-ov.open{opacity:1;pointer-events:all}
.modal{background:var(--surface);border:1px solid var(--border2);width:560px;max-height:85vh;overflow-y:auto;padding:30px;position:relative}
.modal::-webkit-scrollbar{width:4px}
.modal::-webkit-scrollbar-thumb{background:var(--border2)}
.modal-title{font-family:'Playfair Display',serif;font-size:20px;color:var(--white);margin-bottom:20px}
.modal-x{position:absolute;top:16px;right:16px;background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;transition:color 0.2s;line-height:1}
.modal-x:hover{color:var(--text)}
/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;background:var(--surface2);border:1px solid var(--blue3);color:var(--blue2);font-size:10px;letter-spacing:0.1em;padding:11px 18px;z-index:9000;opacity:0;transition:opacity 0.3s;pointer-events:none}
.toast.show{opacity:1}
/* EMPTY */
.empty{text-align:center;padding:48px 20px;color:var(--muted);font-size:11px;line-height:2}
.empty-icon{font-size:40px;opacity:0.2;display:block;margin-bottom:10px}
/* SCANNER PILLS + SIGNAL BUTTONS */
.sector-pill{background:var(--surface);border:1px solid var(--border);color:var(--muted);font-family:'IBM Plex Mono',monospace;font-size:9px;padding:4px 10px;cursor:pointer;white-space:nowrap;transition:all 0.15s;letter-spacing:0.06em}
.sector-pill:hover{color:var(--text);border-color:var(--border2)}
.sector-pill.active{background:var(--blue3);border-color:var(--blue3);color:white}
.sig-filter-btn{background:var(--surface);border:1px solid var(--border);color:var(--muted);font-family:'IBM Plex Mono',monospace;font-size:8px;padding:4px 6px;cursor:pointer;transition:all 0.15s;flex:1;letter-spacing:0.02em;text-align:center}
.sig-filter-btn:hover{color:var(--text)}
.sig-filter-btn.active{border-color:var(--blue3);color:var(--blue2);background:rgba(74,127,168,0.1)}
.scan-item{padding:9px 12px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.12s;display:flex;align-items:center;gap:8px}
.scan-item:hover{background:var(--surface)}
.scan-item.selected{background:var(--surface2);border-left:2px solid var(--blue3)}
.scan-item-ticker{font-size:11px;font-weight:500;letter-spacing:0.06em;min-width:68px;color:var(--blue2)}
.scan-item-name{font-size:9px;color:var(--muted);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.scan-item-right{text-align:right;flex-shrink:0}
.scan-item-price{font-size:10px;color:var(--white)}
.scan-item-chg{font-size:8px}
.sig-badge{display:inline-block;padding:2px 6px;font-size:7px;letter-spacing:0.1em;text-transform:uppercase;font-weight:500}
.sig-long{background:rgba(112,192,144,0.15);color:var(--green);border:1px solid rgba(112,192,144,0.3)}
.sig-short{background:rgba(224,112,112,0.15);color:var(--red);border:1px solid rgba(224,112,112,0.3)}
.sig-neutral{background:rgba(90,122,154,0.1);color:var(--muted);border:1px solid var(--border)}
.score-dots{display:flex;gap:2px;margin-top:3px}
.sdot{width:5px;height:5px;border-radius:50%}
.sdot.bull{background:var(--green)}.sdot.bear{background:var(--red)}.sdot.off{background:var(--border2)}
/* NEWS TABS */
.news-tab{padding:11px 14px;font-size:8px;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.2s;white-space:nowrap;flex:1;text-align:center}
.news-tab:hover{color:var(--text)}
.news-tab.active{color:var(--blue2);border-bottom-color:var(--blue)}
.news-card{padding:12px 15px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s;animation:fadeUp 0.3s ease both}
.news-card:hover{background:var(--surface)}
.news-source{font-size:8px;letter-spacing:0.12em;text-transform:uppercase;color:var(--blue3);margin-bottom:4px;display:flex;align-items:center;gap:6px}
.news-headline{font-size:11px;color:var(--text);line-height:1.5;margin-bottom:5px}
.news-meta{font-size:9px;color:var(--muted)}
.news-tag{display:inline-block;padding:1px 6px;font-size:7px;border-radius:2px;letter-spacing:0.08em}
.tag-earnings{background:rgba(212,184,112,0.15);color:var(--yellow);border:1px solid rgba(212,184,112,0.2)}
.tag-fed{background:rgba(154,128,200,0.15);color:var(--purple);border:1px solid rgba(154,128,200,0.2)}
.tag-macro{background:rgba(74,127,168,0.15);color:var(--blue2);border:1px solid rgba(74,127,168,0.2)}
.tag-breaking{background:rgba(224,112,112,0.15);color:var(--red);border:1px solid rgba(224,112,112,0.2)}
.idea-card{padding:13px 15px;border-bottom:1px solid var(--border);transition:background 0.15s;animation:fadeUp 0.3s ease both}
.idea-card:hover{background:var(--surface)}
.idea-header{display:flex;align-items:center;gap:8px;margin-bottom:5px}
.idea-ticker{font-size:14px;color:var(--blue2);letter-spacing:0.08em;font-weight:500;font-family:'Playfair Display',serif}
.idea-dir{display:inline-block;padding:2px 8px;font-size:7px;letter-spacing:0.1em;text-transform:uppercase}
.dir-long{background:rgba(112,192,144,0.15);color:var(--green);border:1px solid rgba(112,192,144,0.3)}
.dir-short{background:rgba(224,112,112,0.15);color:var(--red);border:1px solid rgba(224,112,112,0.3)}
.idea-source{font-size:8px;color:var(--muted2);margin-bottom:3px}
.idea-note{font-size:10px;color:var(--muted);line-height:1.55}
/* SECTOR CARDS */
.sectors-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:24px}
.sector-card{background:var(--surface);border:1px solid var(--border);padding:16px 18px;position:relative;overflow:hidden;cursor:pointer;transition:border-color 0.2s,transform 0.15s;animation:fadeUp 0.4s ease both}
.sector-card:hover{transform:translateY(-2px);border-color:var(--border2)}
.sector-card.hot{border-left:3px solid var(--green)}
.sector-card.warm{border-left:3px solid var(--yellow)}
.sector-card.cold{border-left:3px solid var(--muted2);opacity:0.7}
.sector-card.short-bias{border-left:3px solid var(--red)}
.sc-heat{font-size:8px;letter-spacing:0.14em;text-transform:uppercase;margin-bottom:5px}
.sc-heat.hot{color:var(--green)}.sc-heat.warm{color:var(--yellow)}.sc-heat.cold{color:var(--muted)}.sc-heat.short-bias{color:var(--red)}
.sc-name{font-family:'Playfair Display',serif;font-size:15px;color:var(--white);margin-bottom:5px}
.sc-tickers{font-size:9px;color:var(--blue2);margin-bottom:6px;letter-spacing:0.04em}
.sc-note{font-size:9px;color:var(--muted);line-height:1.6}
.sc-emoji{position:absolute;top:10px;right:14px;font-size:22px;opacity:0.18}
/* MARKET PULSE */
.mp-cell{padding:8px 16px;border-right:1px solid var(--border);flex-shrink:0;cursor:pointer;transition:background 0.15s}
.mp-cell:hover{background:var(--surface)}
.mp-sym{font-size:9px;color:var(--muted);margin-bottom:2px;letter-spacing:0.06em}
.mp-price{font-size:11px;color:var(--white);font-weight:500}
.mp-chg{font-size:8px;margin-top:1px}
/* PRINT */
.no-print{}.print-only{display:none}
@media print{
  body{background:white!important;color:#000!important;overflow:visible!important}
  #login,.topbar,.re-sidebar,.no-print{display:none!important}
  .re-main{overflow:visible!important}
  .print-only{display:block!important}
  table th,table td{color:#000!important;background:white!important;border-color:#ddd!important}
  .sum-val,.stat-val,.net-val{color:#000!important}
  .pos{color:#2a7a4a!important}.neg{color:#a02020!important}
  .re-summary{background:white!important}
  .sum-lbl{color:#666!important}.sum-sub{color:#666!important}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="screen" id="login">
  <div class="login-card">
    <div class="login-wordmark">Funded Trust</div>
    <div class="login-tagline">Private Financial Portal</div>
    <label class="form-label">Password</label>
    <input class="form-input" id="pw" type="password" placeholder="¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑" autocomplete="current-password"/>
    <button class="login-btn" onclick="doLogin()">Access Portal</button>
    <div class="login-err" id="pw-err"></div>
  </div>
</div>

<!-- APP -->
<div class="screen hidden" id="app">
  <div class="topbar">
    <div class="topbar-logo" onclick="navTo('home')" title="Command Center">Funded Trust</div>
    <div class="topbar-greeting" id="topbar-greeting">Welcome, Bruno</div>
    <div class="topbar-right">
      <span class="topbar-date" id="tdate"></span>
      <button class="btn-sm no-print" id="print-btn" onclick="window.print()" style="display:none">üñ® Print</button>
      <button class="btn-sm no-print" onclick="doLogout()">Sign Out</button>
    </div>
  </div>
  <div class="app-body">
    <!-- GLOBAL NAV SIDEBAR ‚Äî always visible -->
    <div class="global-nav" id="global-nav">
      <div class="gnav-section">
        <div class="gnav-item active" id="gnav-home" onclick="navTo('home')"><span class="gnav-icon">‚åÇ</span>Dashboard</div>
        <div class="gnav-item" id="gnav-scanner" onclick="navTo('scanner')"><span class="gnav-icon">‚óâ</span>Scanner</div>
        <div class="gnav-item" id="gnav-ai" onclick="navTo('ai')"><span class="gnav-icon">‚óà</span>AI Advisor</div>
      </div>
      <div class="gnav-section">
        <div class="gnav-lbl">Portfolio</div>
        <div class="gnav-item" id="gnav-portfolio" onclick="navTo('portfolio')"><span class="gnav-icon">‚ñ¶</span>Overview</div>
        <div class="gnav-item" id="gnav-re" onclick="navTo('re')"><span class="gnav-icon">üè†</span>Real Estate</div>
        <div class="gnav-item" id="gnav-stocks" onclick="navTo('stocks')"><span class="gnav-icon">üìà</span>Stocks</div>
        <div class="gnav-item" id="gnav-retirement" onclick="navTo('retirement')"><span class="gnav-icon">üè¶</span>Retirement</div>
        <div class="gnav-item" id="gnav-crypto" onclick="navTo('crypto')"><span class="gnav-icon">‚Çø</span>Crypto</div>
        <div class="gnav-item" id="gnav-cash" onclick="navTo('cash')"><span class="gnav-icon">üíµ</span>Cash</div>
        <div class="gnav-item" id="gnav-other" onclick="navTo('other')"><span class="gnav-icon">‚óà</span>Other Assets</div>
      </div>
    </div>

    <!-- MAIN CONTENT AREA -->
    <div class="main-content">

    <!-- HOME: DASHBOARD -->
    <div id="home-view" style="display:flex;flex:1;overflow:hidden">

      <!-- LEFT: News / Ideas / Alerts -->
      <div class="home-left" style="width:380px;min-width:340px">
        <!-- Tab bar -->
        <div style="display:flex;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--bg)">
          <div class="news-tab active" id="ntab-news" onclick="switchNewsTab('news')">üì∞ Market News</div>
          <div class="news-tab" id="ntab-ideas" onclick="switchNewsTab('ideas')">üí° Ideas</div>
          <div class="news-tab" id="ntab-alerts" onclick="switchNewsTab('alerts')">üîî Alerts</div>
        </div>
        <div id="news-panel" style="flex:1;overflow-y:auto"></div>
      </div>

      <!-- RIGHT: Market Focus / Sectors -->
      <div style="flex:1;overflow:hidden;display:flex;flex-direction:column">
        <!-- Market pulse strip -->
        <div id="market-pulse" style="display:flex;border-bottom:1px solid var(--border);background:var(--bg);flex-shrink:0;overflow-x:auto">
          <div style="padding:10px 18px;font-size:8px;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted2);display:flex;align-items:center;flex-shrink:0">MARKET</div>
        </div>
        <!-- Main right panel -->
        <div style="flex:1;overflow-y:auto;padding:24px 28px" id="sectors-panel">
          <!-- content injected by JS -->
        </div>
      </div>
    </div>

    <!-- AI ADVISOR (standalone page) -->
    <div id="ai-view" style="display:none;flex:1;overflow:hidden;flex-direction:column">
      <div style="padding:16px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;background:var(--bg)">
        <div>
          <div style="font-family:'Playfair Display',serif;font-size:18px;color:var(--white)">AI Financial Advisor</div>
          <div style="font-size:9px;color:var(--muted);margin-top:2px;letter-spacing:0.08em">Persistent memory ¬∑ Portfolio-aware ¬∑ Investment analysis</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <div class="alert-dot live"></div>
          <span style="font-size:9px;color:var(--muted)">Claude Sonnet 4</span>
          <button class="btn-sm" onclick="clearChatMemory()" style="font-size:8px;padding:4px 10px">Clear Memory</button>
        </div>
      </div>
      <!-- Memory bar -->
      <div id="memory-bar" style="background:rgba(74,127,168,0.06);border-bottom:1px solid var(--border);padding:6px 22px;font-size:9px;color:var(--muted);flex-shrink:0;display:none">
        <span style="color:var(--blue2)">‚óà Memory active:</span> <span id="memory-summary"></span>
      </div>
      <div class="chat-messages" id="chat-messages" style="flex:1"></div>
      <div class="chat-input-row">
        <textarea class="chat-input" id="chat-input" placeholder="Ask about markets, your portfolio, long/short ideas, financial decisions‚Ä¶" rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}" oninput="autoResize(this)"></textarea>
        <button class="chat-send" onclick="sendChat()">Send ‚Üë</button>
      </div>
    </div>

    <!-- PORTFOLIO OVERVIEW (old home cards) -->
    <div id="portfolio-view" style="display:none;flex:1;overflow-y:auto;padding:40px">
      <div style="font-size:9px;letter-spacing:0.25em;text-transform:uppercase;color:var(--muted);margin-bottom:28px">Portfolio Overview</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px" id="portfolio-cards"></div>
    </div>

    <!-- SCANNER -->
    <div id="scanner-view" style="display:none;flex:1;overflow:hidden;flex-direction:column">
      <!-- Top bar -->
      <div style="display:flex;align-items:center;border-bottom:1px solid var(--border);background:var(--bg);flex-shrink:0;padding:0 0 0 0;gap:0;height:44px">
        <div class="scan-tab active" id="smode-crypto" onclick="setScanMode('crypto')" style="height:100%;display:flex;align-items:center">‚Çø Crypto Top 150</div>
        <div class="scan-tab" id="smode-sectors" onclick="setScanMode('sectors')" style="height:100%;display:flex;align-items:center">üìä Sector Stocks</div>
        <div style="margin-left:auto;display:flex;align-items:center;gap:8px;padding:0 14px">
          <select id="tv-interval" class="sf-input" style="width:68px">
            <option value="D" selected>1D</option>
            <option value="W">1W</option>
            <option value="240">4H</option>
            <option value="60">1H</option>
            <option value="15">15m</option>
          </select>
          <span id="scan-status" style="font-size:9px;color:var(--muted)">Ready to scan</span>
        </div>
      </div>

      <div style="flex:1;display:flex;overflow:hidden">

        <!-- LEFT PANEL: Controls + Results list -->
        <div style="width:270px;flex-shrink:0;border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--bg);overflow:hidden">

          <!-- Sector pills ‚Äî shown only in sector mode -->
          <div id="sector-pills" style="display:none;padding:8px 10px;border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto">
            <div style="display:flex;gap:5px;white-space:nowrap">
              <button class="sector-pill active" id="sp-tech" onclick="selectSector('tech')">Tech/AI</button>
              <button class="sector-pill" id="sp-defense" onclick="selectSector('defense')">Defense</button>
              <button class="sector-pill" id="sp-commodities" onclick="selectSector('commodities')">Commodities</button>
              <button class="sector-pill" id="sp-smallcap" onclick="selectSector('smallcap')">Small Caps</button>
              <button class="sector-pill" id="sp-drones" onclick="selectSector('drones')">Drones</button>
            </div>
          </div>

          <!-- Run button + signal filters -->
          <div style="padding:10px;border-bottom:1px solid var(--border);flex-shrink:0">
            <button id="scan-run-btn" onclick="runActiveScanner()" style="width:100%;padding:10px;background:var(--blue3);border:none;color:white;font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:0.18em;text-transform:uppercase;cursor:pointer;transition:background 0.2s;margin-bottom:8px">‚ñ∂ RUN SCANNER</button>
            <div style="display:flex;gap:5px">
              <button onclick="filterScanResults('all')" id="sfb-all" class="sig-filter-btn active">All</button>
              <button onclick="filterScanResults('long')" id="sfb-long" class="sig-filter-btn">üü¢ LONG</button>
              <button onclick="filterScanResults('short')" id="sfb-short" class="sig-filter-btn">üî¥ SHORT</button>
              <button onclick="filterScanResults('neutral')" id="sfb-neutral" class="sig-filter-btn">‚ö™ Neutral</button>
            </div>
          </div>

          <!-- Results list -->
          <div id="scan-results-list" style="flex:1;overflow-y:auto">
            <div style="padding:24px 16px;text-align:center;color:var(--muted);font-size:10px;line-height:2.2">
              <div style="font-size:24px;opacity:0.2;margin-bottom:8px">‚óâ</div>
              Click ‚ñ∂ RUN SCANNER<br>to analyze assets
            </div>
          </div>

          <!-- Count bar -->
          <div id="scan-count-bar" style="padding:7px 12px;border-top:1px solid var(--border);font-size:9px;color:var(--muted2);flex-shrink:0">‚Äî</div>
        </div>

        <!-- RIGHT PANEL: TradingView Advanced Chart -->
        <div style="flex:1;display:flex;flex-direction:column;overflow:hidden">
          <!-- Chart header bar -->
          <div style="padding:7px 12px;border-bottom:1px solid var(--border);background:var(--bg);display:flex;align-items:center;gap:10px;flex-shrink:0;flex-wrap:wrap">
            <input id="tv-symbol-input" class="sf-input" style="width:130px;text-transform:uppercase" placeholder="BTC, ETH, SOL‚Ä¶" value="BTCUSD" onkeydown="if(event.key==='Enter'){loadTVChart(this.value.trim().toUpperCase())}"/>
            <button onclick="loadTVChart(document.getElementById('tv-symbol-input').value.trim().toUpperCase())" style="padding:5px 14px;background:var(--blue3);border:none;color:white;font-family:'IBM Plex Mono',monospace;font-size:9px;cursor:pointer;letter-spacing:0.1em">LOAD</button>
            <div id="chart-label" style="font-size:10px;color:var(--muted);flex:1">Click a coin from scan list to load chart</div>
            <span style="font-size:8px;color:var(--muted2);padding:3px 8px;border:1px solid var(--border);border-radius:2px">üí° Add your 2/3 indicator in TradingView ‚Üí Save as Default Layout</span>
          </div>
          <!-- TradingView Advanced Chart Widget -->
          <div id="tv-widget-container" style="flex:1;overflow:hidden;background:#0d1117"></div>
        </div>

      </div>
    </div>

    <!-- RE MODULE -->
    <div id="re-view" style="display:none;flex:1;overflow:hidden;flex-direction:row">
      <div class="re-sidebar">
        <div class="sidebar-hdr">
          <span class="sidebar-title">Real Estate</span>
          <button class="sidebar-add" onclick="showAddPropModal()" title="Add Property">+</button>
        </div>
        <div class="sidebar-nav">
          <div class="snav-item active" id="nav-overview" onclick="showPanel('overview')"><span class="ni">‚óé</span>Overview</div>
          <div class="snav-item" id="nav-finance" onclick="showPanel('finance')"><span class="ni">$</span>All Finances</div>
          <div class="snav-item" id="nav-depreciation" onclick="showPanel('depreciation')"><span class="ni">%</span>Depreciation</div>
          <div class="snav-item" id="nav-statements" onclick="showPanel('statements')"><span class="ni">‚â°</span>Statements</div>
          <div class="snav-item" id="nav-tenants" onclick="showPanel('tenants')"><span class="ni">üë§</span>Tenants</div>
        </div>
        <div class="sidebar-sec-lbl">Properties</div>
        <div class="prop-list" id="prop-list"></div>
      </div>
      <div class="re-main" id="re-main"></div>
    </div>

    <!-- STOCKS MODULE -->
    <div id="stocks-view" style="display:none;flex:1;overflow:hidden;flex-direction:row">
      <div class="re-sidebar">
        <div class="sidebar-hdr"><span class="sidebar-title">Stocks</span></div>
        <div class="sidebar-nav">
          <div class="snav-item active" id="sn-holdings" onclick="showSPanel('holdings')"><span class="ni">‚óé</span>Holdings</div>
          <div class="snav-item" id="sn-cash" onclick="showSPanel('cash')"><span class="ni">$</span>Cash Positions</div>
          <div class="snav-item" id="sn-brokerages" onclick="showSPanel('brokerages')"><span class="ni">üîó</span>Brokerages</div>
        </div>
      </div>
      <div class="re-main" id="stocks-main"></div>
    </div>

    <!-- RETIREMENT MODULE -->
    <div id="ret-view" style="display:none;flex:1;overflow:hidden;flex-direction:row">
      <div class="re-sidebar">
        <div class="sidebar-hdr"><span class="sidebar-title">Retirement</span></div>
        <div class="sidebar-nav">
          <div class="snav-item active" id="rn-holdings" onclick="showRPanel('holdings')"><span class="ni">‚óé</span>Holdings</div>
          <div class="snav-item" id="rn-cash" onclick="showRPanel('cash')"><span class="ni">$</span>Cash Positions</div>
          <div class="snav-item" id="rn-brokerages" onclick="showRPanel('brokerages')"><span class="ni">üîó</span>Brokerages</div>
        </div>
      </div>
      <div class="re-main" id="ret-main"></div>
    </div>

    <!-- CRYPTO MODULE -->
    <div id="crypto-view" style="display:none;flex:1;overflow:hidden;flex-direction:row">
      <div class="re-sidebar">
        <div class="sidebar-hdr"><span class="sidebar-title">Crypto</span></div>
        <div class="sidebar-nav">
          <div class="snav-item active" id="crn-holdings" onclick="showCPanel('holdings')"><span class="ni">‚óé</span>Holdings</div>
        </div>
      </div>
      <div class="re-main" id="crypto-main"></div>
    </div>

    <!-- CASH MODULE -->
    <div id="cash-view" style="display:none;flex:1;overflow:hidden;flex-direction:row">
      <div class="re-sidebar">
        <div class="sidebar-hdr"><span class="sidebar-title">Cash</span></div>
        <div class="sidebar-nav">
          <div class="snav-item active" id="cashn-accounts" onclick="showCashPanel('accounts')"><span class="ni">‚óé</span>Accounts</div>
        </div>
      </div>
      <div class="re-main" id="cash-main"></div>
    </div>

    <!-- OTHER MODULE -->
    <div id="other-view" style="display:none;flex:1;overflow:hidden;flex-direction:row">
      <div class="re-sidebar">
        <div class="sidebar-hdr"><span class="sidebar-title">Other Assets</span></div>
        <div class="sidebar-nav">
          <div class="snav-item active" id="othn-assets" onclick="showOtherPanel('assets')"><span class="ni">‚óé</span>Assets</div>
        </div>
      </div>
      <div class="re-main" id="other-main"></div>
    </div>

    </div><!-- end main-content -->
  </div><!-- end app-body -->
</div><!-- end app -->

<!-- MODAL: ADD PROPERTY -->
<div class="modal-ov" id="modal-prop">
  <div class="modal">
    <button class="modal-x" onclick="closeModal('modal-prop')">‚úï</button>
    <div class="modal-title" id="modal-prop-title">Add Property</div>
    <input type="hidden" id="edit-prop-id"/>
    <div class="fg g3" style="margin-bottom:12px">
      <div class="fgrp full"><div class="fl">Property Name</div><input class="fi" id="np-name" placeholder="e.g. Boca House"/></div>
      <div class="fgrp"><div class="fl">Type</div><select class="fsl" id="np-type"><option>Single Family</option><option>Multi-Family</option><option>Condo/Townhome</option><option>Commercial</option><option>Vacation Rental</option><option>Land</option><option>REIT</option></select></div>
      <div class="fgrp"><div class="fl">Purchase Date</div><input class="fi" id="np-date" type="date"/></div>
      <div class="fgrp"><div class="fl">Market Value ($)</div><input class="fi" id="np-val" type="number" placeholder="0"/></div>
      <div class="fgrp"><div class="fl">Mortgage Balance ($)</div><input class="fi" id="np-debt" type="number" placeholder="0"/></div>
      <div class="fgrp"><div class="fl">Purchase Price ($)</div><input class="fi" id="np-pp" type="number" placeholder="0"/></div>
      <div class="fgrp"><div class="fl">Land Value ($) ‚ìò</div><input class="fi" id="np-land" type="number" placeholder="0" title="Non-depreciable land portion"/></div>
      <div class="fgrp"><div class="fl">Sq Footage</div><input class="fi" id="np-sqft" type="number" placeholder="0"/></div>
      <div class="fgrp"><div class="fl">Units / Bedrooms</div><input class="fi" id="np-units" placeholder="3 bed / 2 bath"/></div>
      <div class="fgrp full"><div class="fl">Address</div><input class="fi" id="np-addr" placeholder="123 Main St, City, FL 33000"/></div>
      <div class="fgrp full"><div class="fl">Notes</div><textarea class="fta" id="np-notes"></textarea></div>
    </div>
    <div class="brow"><button class="btn-p" onclick="saveProp()">Save Property</button><button class="btn-s" onclick="closeModal('modal-prop')">Cancel</button></div>
  </div>
</div>

<!-- MODAL: ADD TENANT -->
<div class="modal-ov" id="modal-tenant">
  <div class="modal">
    <button class="modal-x" onclick="closeModal('modal-tenant')">‚úï</button>
    <div class="modal-title">Add Tenant</div>
    <div style="margin-bottom:14px"><div class="fl" style="margin-bottom:6px">Property</div><select class="fsl" id="nt-prop" style="width:100%"></select></div>
    <div class="fg" style="margin-bottom:12px">
      <div class="fgrp"><div class="fl">First Name</div><input class="fi" id="nt-first" placeholder="John"/></div>
      <div class="fgrp"><div class="fl">Last Name</div><input class="fi" id="nt-last" placeholder="Doe"/></div>
      <div class="fgrp"><div class="fl">Phone</div><input class="fi" id="nt-phone" placeholder="(555) 000-0000" type="tel"/></div>
      <div class="fgrp"><div class="fl">Email</div><input class="fi" id="nt-email" placeholder="john@email.com" type="email"/></div>
      <div class="fgrp"><div class="fl">Lease Start</div><input class="fi" id="nt-start" type="date"/></div>
      <div class="fgrp"><div class="fl">Lease End</div><input class="fi" id="nt-end" type="date"/></div>
      <div class="fgrp"><div class="fl">Monthly Rent ($)</div><input class="fi" id="nt-rent" type="number" placeholder="0"/></div>
      <div class="fgrp"><div class="fl">Security Deposit ($)</div><input class="fi" id="nt-dep" type="number" placeholder="0"/></div>
      <div class="fgrp"><div class="fl">Unit / Suite</div><input class="fi" id="nt-unit" placeholder="Unit 1A"/></div>
      <div class="fgrp"><div class="fl">Status</div><select class="fsl" id="nt-status"><option>Active</option><option>Notice Given</option><option>Month-to-Month</option><option>Vacated</option></select></div>
      <div class="fgrp full"><div class="fl">Notes</div><textarea class="fta" id="nt-notes"></textarea></div>
    </div>
    <div class="brow"><button class="btn-p" onclick="saveTenant()">Save Tenant</button><button class="btn-s" onclick="closeModal('modal-tenant')">Cancel</button></div>
  </div>
</div>

<!-- MODAL: ADD ASSET -->
<div class="modal-ov" id="modal-asset">
  <div class="modal">
    <button class="modal-x" onclick="closeModal('modal-asset')">‚úï</button>
    <div class="modal-title">Add Depreciable Asset</div>
    <div style="margin-bottom:14px"><div class="fl" style="margin-bottom:6px">Property</div><select class="fsl" id="na-prop" style="width:100%"></select></div>
    <div class="fg" style="margin-bottom:12px">
      <div class="fgrp full"><div class="fl">Asset Description</div><input class="fi" id="na-desc" placeholder="e.g. Residential Building Structure"/></div>
      <div class="fgrp"><div class="fl">Cost / Depreciable Basis ($)</div><input class="fi" id="na-cost" type="number" placeholder="0" oninput="assetPreview()"/></div>
      <div class="fgrp"><div class="fl">Date Placed in Service</div><input class="fi" id="na-date" type="date" onchange="assetPreview()"/></div>
      <div class="fgrp"><div class="fl">MACRS Property Class</div>
        <select class="fsl" id="na-class" onchange="assetPreview()">
          <option value="27.5">27.5-Year ‚Äî Residential Rental</option>
          <option value="39">39-Year ‚Äî Nonresidential Real</option>
          <option value="15">15-Year ‚Äî Land Improvements</option>
          <option value="7">7-Year ‚Äî Equipment / Appliances</option>
          <option value="5">5-Year ‚Äî Vehicles / Computers</option>
        </select>
      </div>
      <div class="fgrp"><div class="fl">Method</div>
        <select class="fsl" id="na-method" onchange="assetPreview()">
          <option value="MACRS">MACRS GDS</option>
          <option value="SL">Straight-Line (SL)</option>
          <option value="179">Section 179 (Full Year)</option>
          <option value="BONUS">100% Bonus Depreciation</option>
        </select>
      </div>
      <div class="fgrp"><div class="fl">Convention</div>
        <select class="fsl" id="na-conv">
          <option value="MM">Mid-Month (Real Property)</option>
          <option value="HY">Half-Year (Personal Prop.)</option>
          <option value="MQ">Mid-Quarter</option>
        </select>
      </div>
      <div class="fgrp full"><div class="fl">Notes / IRS Ref</div><input class="fi" id="na-notes" placeholder="e.g. Sch E Line 18, Cost Seg Report"/></div>
    </div>
    <div id="asset-preview" style="background:var(--bg);border:1px solid var(--border);padding:12px;margin-bottom:14px;font-size:11px;color:var(--muted)">Enter cost and date to see preview.</div>
    <div class="brow"><button class="btn-p" onclick="saveAsset()">Save Asset</button><button class="btn-s" onclick="closeModal('modal-asset')">Cancel</button></div>
  </div>
</div>

<!-- MODAL: ADD HOLDING -->
<div class="modal-ov" id="modal-holding">
  <div class="modal">
    <button class="modal-x" onclick="closeModal('modal-holding')">‚úï</button>
    <div class="modal-title" id="modal-holding-title">Add Position</div>
    <input type="hidden" id="mh-module"/>
    <input type="hidden" id="mh-edit-id"/>
    <div class="fg" style="margin-bottom:12px">
      <div class="fgrp"><div class="fl">Ticker Symbol</div><input class="fi" id="mh-ticker" placeholder="e.g. AAPL" style="text-transform:uppercase" oninput="this.value=this.value.toUpperCase()"/></div>
      <div class="fgrp"><div class="fl">Account / Label</div><input class="fi" id="mh-account" placeholder="e.g. Fidelity Brokerage"/></div>
      <div class="fgrp"><div class="fl">Shares / Units</div><input class="fi" id="mh-shares" type="number" step="0.0001" placeholder="0"/></div>
      <div class="fgrp"><div class="fl">Avg Cost Basis ($ per share)</div><input class="fi" id="mh-cost" type="number" step="0.01" placeholder="0"/></div>
      <div class="fgrp"><div class="fl">Asset Type</div>
        <select class="fsl" id="mh-type">
          <option value="stock">Stock</option>
          <option value="etf">ETF</option>
          <option value="mutual">Mutual Fund</option>
          <option value="401k">401(k) Fund</option>
          <option value="ira">IRA Holding</option>
          <option value="roth">Roth IRA</option>
          <option value="pension">Pension</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="fgrp"><div class="fl">Notes</div><input class="fi" id="mh-notes" placeholder="Optional notes"/></div>
    </div>
    <div class="brow"><button class="btn-p" onclick="saveHolding()">Save Position</button><button class="btn-s" onclick="closeModal('modal-holding')">Cancel</button></div>
  </div>
</div>

<!-- MODAL: ADD CASH POSITION -->
<div class="modal-ov" id="modal-cash">
  <div class="modal">
    <button class="modal-x" onclick="closeModal('modal-cash')">‚úï</button>
    <div class="modal-title">Add Cash Position</div>
    <input type="hidden" id="mc-module"/>
    <div class="fg" style="margin-bottom:12px">
      <div class="fgrp full"><div class="fl">Account Name</div><input class="fi" id="mc-name" placeholder="e.g. Fidelity Cash, Money Market, SPAXX"/></div>
      <div class="fgrp"><div class="fl">Balance ($)</div><input class="fi" id="mc-bal" type="number" step="0.01" placeholder="0"/></div>
      <div class="fgrp"><div class="fl">Account Type</div>
        <select class="fsl" id="mc-type">
          <option>Cash / Sweep</option>
          <option>Money Market</option>
          <option>Savings</option>
          <option>Checking</option>
          <option>CD</option>
          <option>Other</option>
        </select>
      </div>
      <div class="fgrp full"><div class="fl">Notes</div><input class="fi" id="mc-notes" placeholder="Optional"/></div>
    </div>
    <div class="brow"><button class="btn-p" onclick="saveCash()">Save</button><button class="btn-s" onclick="closeModal('modal-cash')">Cancel</button></div>
  </div>
</div>

<!-- MODAL: ADD BROKERAGE LINK -->
<div class="modal-ov" id="modal-brokerage">
  <div class="modal">
    <button class="modal-x" onclick="closeModal('modal-brokerage')">‚úï</button>
    <div class="modal-title">Link Brokerage Account</div>
    <input type="hidden" id="mb-module"/>
    <div style="background:rgba(122,168,212,0.08);border:1px solid rgba(122,168,212,0.2);padding:14px;margin-bottom:16px;font-size:10px;color:var(--muted);line-height:1.8">
      <strong style="color:var(--blue2)">Read-Only Reference Link</strong><br>
      Paste your brokerage's portfolio URL or account login URL below. This portal stores it as a quick-access link only ‚Äî no credentials are stored, no data is fetched automatically. You can open it to view your live positions and manually sync holdings above.
    </div>
    <div class="fg" style="margin-bottom:12px">
      <div class="fgrp full"><div class="fl">Brokerage Name</div><input class="fi" id="mb-name" placeholder="e.g. Fidelity, Schwab, TD Ameritrade, Robinhood"/></div>
      <div class="fgrp full"><div class="fl">Portfolio / Account URL</div><input class="fi" id="mb-url" type="url" placeholder="https://www.fidelity.com/portfolio-summary"/></div>
      <div class="fgrp"><div class="fl">Account Type</div>
        <select class="fsl" id="mb-atype">
          <option>Brokerage</option><option>401(k)</option><option>IRA</option><option>Roth IRA</option><option>Pension</option><option>Other</option>
        </select>
      </div>
      <div class="fgrp"><div class="fl">Notes</div><input class="fi" id="mb-notes" placeholder="Account #, notes..."/></div>
    </div>
    <div class="brow"><button class="btn-p" onclick="saveBrokerage()">Save Link</button><button class="btn-s" onclick="closeModal('modal-brokerage')">Cancel</button></div>
  </div>
</div>

<!-- MODAL: ADD CRYPTO -->
<div class="modal-ov" id="modal-crypto">
  <div class="modal">
    <button class="modal-x" onclick="closeModal('modal-crypto')">‚úï</button>
    <div class="modal-title">Add Crypto Holding</div>
    <div style="font-size:9px;color:var(--muted);margin-bottom:14px;line-height:1.7">Enter the CoinGecko ID (e.g. <strong style="color:var(--blue2)">bitcoin</strong>, <strong style="color:var(--blue2)">ethereum</strong>, <strong style="color:var(--blue2)">solana</strong>). Live prices pulled from CoinGecko free API.</div>
    <div class="fg" style="margin-bottom:12px">
      <div class="fgrp"><div class="fl">CoinGecko ID</div><input class="fi" id="mcr-id" placeholder="bitcoin, ethereum, solana‚Ä¶" style="text-transform:lowercase" oninput="this.value=this.value.toLowerCase().replace(/\s/g,'-')"/></div>
      <div class="fgrp"><div class="fl">Display Name</div><input class="fi" id="mcr-name" placeholder="Bitcoin"/></div>
      <div class="fgrp"><div class="fl">Amount / Coins Held</div><input class="fi" id="mcr-amt" type="number" step="0.00000001" placeholder="0"/></div>
      <div class="fgrp"><div class="fl">Avg Cost Basis ($ per coin)</div><input class="fi" id="mcr-cost" type="number" step="0.01" placeholder="0"/></div>
      <div class="fgrp full"><div class="fl">Notes / Wallet</div><input class="fi" id="mcr-notes" placeholder="e.g. Coinbase, Ledger, DeFi"/></div>
    </div>
    <div class="brow"><button class="btn-p" onclick="saveCrypto()">Save</button><button class="btn-s" onclick="closeModal('modal-crypto')">Cancel</button></div>
  </div>
</div>

<!-- MODAL: ADD CASH ACCOUNT -->
<div class="modal-ov" id="modal-cash-acct">
  <div class="modal">
    <button class="modal-x" onclick="closeModal('modal-cash-acct')">‚úï</button>
    <div class="modal-title">Add Cash Account</div>
    <div class="fg" style="margin-bottom:12px">
      <div class="fgrp full"><div class="fl">Account Name</div><input class="fi" id="mca-name" placeholder="e.g. Chase Checking, Marcus Savings"/></div>
      <div class="fgrp"><div class="fl">Balance ($)</div><input class="fi" id="mca-bal" type="number" step="0.01" placeholder="0"/></div>
      <div class="fgrp"><div class="fl">Account Type</div>
        <select class="fsl" id="mca-type">
          <option>Checking</option><option>Savings</option><option>Money Market</option><option>CD</option><option>Cash</option><option>Other</option>
        </select>
      </div>
      <div class="fgrp"><div class="fl">Interest Rate (% APY)</div><input class="fi" id="mca-rate" type="number" step="0.01" placeholder="0.00"/></div>
      <div class="fgrp full"><div class="fl">Notes</div><input class="fi" id="mca-notes" placeholder="Bank name, account #, etc."/></div>
    </div>
    <div class="brow"><button class="btn-p" onclick="saveCashAcct()">Save</button><button class="btn-s" onclick="closeModal('modal-cash-acct')">Cancel</button></div>
  </div>
</div>

<!-- MODAL: ADD OTHER ASSET -->
<div class="modal-ov" id="modal-other">
  <div class="modal">
    <button class="modal-x" onclick="closeModal('modal-other')">‚úï</button>
    <div class="modal-title">Add Asset</div>
    <div class="fg" style="margin-bottom:12px">
      <div class="fgrp full"><div class="fl">Asset Name / Description</div><input class="fi" id="mo-name" placeholder="e.g. Bruno's Pizza LLC, 1967 Mustang, Art Collection"/></div>
      <div class="fgrp"><div class="fl">Category</div>
        <select class="fsl" id="mo-cat">
          <option>Business</option><option>Vehicle</option><option>Collectible</option><option>Jewelry</option><option>Art</option><option>Equipment</option><option>Note / Loan</option><option>Other</option>
        </select>
      </div>
      <div class="fgrp"><div class="fl">Date Acquired</div><input class="fi" id="mo-date" type="date"/></div>
      <div class="fgrp"><div class="fl">Amount Paid / Cost Basis ($)</div><input class="fi" id="mo-cost" type="number" step="0.01" placeholder="0"/></div>
      <div class="fgrp"><div class="fl">Current Estimated Value ($)</div><input class="fi" id="mo-val" type="number" step="0.01" placeholder="0"/></div>
      <div class="fgrp"><div class="fl">Ownership %</div><input class="fi" id="mo-own" type="number" step="0.1" placeholder="100" value="100"/></div>
      <div class="fgrp full"><div class="fl">Notes</div><textarea class="fta" id="mo-notes" placeholder="Business description, appraisal notes, etc."></textarea></div>
    </div>
    <div class="brow"><button class="btn-p" onclick="saveOther()">Save Asset</button><button class="btn-s" onclick="closeModal('modal-other')">Cancel</button></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CONSTANTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PW = "5555";
const CY = new Date().getFullYear();

const IRS = [
  {code:"SE-3",label:"Rents Received",type:"income"},
  {code:"SE-5",label:"Advertising",type:"expense"},
  {code:"SE-6",label:"Auto & Travel",type:"expense"},
  {code:"SE-7",label:"Cleaning & Maintenance",type:"expense"},
  {code:"SE-8",label:"Commissions",type:"expense"},
  {code:"SE-9",label:"Insurance",type:"expense"},
  {code:"SE-10",label:"Legal & Professional",type:"expense"},
  {code:"SE-11",label:"Management Fees",type:"expense"},
  {code:"SE-12",label:"Mortgage Interest",type:"expense"},
  {code:"SE-13",label:"Other Interest",type:"expense"},
  {code:"SE-14",label:"Repairs",type:"expense"},
  {code:"SE-15",label:"Supplies",type:"expense"},
  {code:"SE-16",label:"Taxes",type:"expense"},
  {code:"SE-17",label:"Utilities",type:"expense"},
  {code:"SE-18",label:"Depreciation",type:"expense"},
  {code:"SE-19a",label:"Other Expense",type:"expense"},
  {code:"CAPEX",label:"Capital Improvement",type:"expense"},
  {code:"1031",label:"1031 Exchange",type:"other"},
  {code:"SEC179",label:"Section 179",type:"expense"},
];

// MACRS GDS percentage tables (IRS Rev. Proc. 87-57 Table A & Table B)
const MACRS = {
  "27.5":[3.485,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,3.636,1.970],
  "39":  [2.461,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,2.564,1.177],
  "15":  [5.0,9.5,8.55,7.7,6.93,6.23,5.9,5.9,5.91,5.9,5.91,5.9,5.91,5.9,5.91,2.95],
  "7":   [14.29,24.49,17.49,12.49,8.93,8.92,8.93,4.46],
  "5":   [20.0,32.0,19.2,11.52,11.52,5.76],
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SUPABASE CONFIG
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SUPABASE_URL = 'https://txwzulnknpjbahtbxfdb.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4d3p1bG5rbnBqYmFodGJ4ZmRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2ODE4NzAsImV4cCI6MjA4NzI1Nzg3MH0.UzoXjYPdxFa29er-DPkZVhSIzvYvbVr-NcGvvv6y5PY';

async function sbGet(category) {
  try {
    const r = await fetch(`${SUPABASE_URL}/rest/v1/portfolio_data?id=eq.${category}&select=data`, {
      headers: {'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`}
    });
    const j = await r.json();
    return j?.[0]?.data || null;
  } catch(e) { return null; }
}

async function sbSet(category, data) {
  try {
    await fetch(`${SUPABASE_URL}/rest/v1/portfolio_data`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'resolution=merge-duplicates'
      },
      body: JSON.stringify({id: category, category, data, updated_at: new Date().toISOString()})
    });
  } catch(e) {}
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STATE + SAVE/LOAD (Supabase + localStorage fallback)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let S={properties:[],transactions:[],assets:[],tenants:[],holdings:[],cashPositions:[],brokerages:[],cryptos:[],cashAccounts:[],otherAssets:[],watchlistStocks:[],watchlistCrypto:[]};

// Save ‚Äî writes to Supabase AND localStorage (localStorage = fast local cache)
async function save() {
  localStorage.setItem('ft3', JSON.stringify(S));
  await sbSet('main', S);
}

// Load ‚Äî tries Supabase first, falls back to localStorage
async function load() {
  // Show localStorage immediately for instant UI
  const local = localStorage.getItem('ft3');
  if (local) {
    try { applyState(JSON.parse(local)); } catch(e) {}
  }
  // Then fetch from Supabase (authoritative)
  const remote = await sbGet('main');
  if (remote) {
    applyState(remote);
    localStorage.setItem('ft3', JSON.stringify(S)); // sync cache
  }
}

function applyState(p) {
  S.properties    = p.properties    || [];
  S.transactions  = p.transactions  || [];
  S.assets        = p.assets        || [];
  S.tenants       = p.tenants       || [];
  S.holdings      = p.holdings      || [];
  S.cashPositions = p.cashPositions || [];
  S.brokerages    = p.brokerages    || [];
  S.cryptos       = p.cryptos       || [];
  S.cashAccounts  = p.cashAccounts  || [];
  S.otherAssets   = p.otherAssets   || [];
  S.watchlistStocks = p.watchlistStocks || [];
  S.watchlistCrypto = p.watchlistCrypto || [];
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MODULE NAV
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let stockPriceCache={};   // TICKER ‚Üí {price,change,changePct}
let cryptoPriceCache={};  // coingecko-id ‚Üí {price,change24h}

function hideAllModules(){
  document.getElementById('home-view').style.display='none';
  document.getElementById('re-view').classList.remove('active');
  ['stocks-view','ret-view','crypto-view','cash-view','other-view'].forEach(id=>{
    document.getElementById(id).style.display='none';
  });
}
function goHome(){
  document.getElementById('home-view').style.display='';
  document.getElementById('re-view').classList.remove('active');
  ['stocks-view','ret-view','crypto-view','cash-view','other-view'].forEach(id=>{
    document.getElementById(id).style.display='none';
  });
  document.getElementById('back-btn').style.display='none';
  document.getElementById('print-btn').style.display='none';
}
function openModule(id,fn){
  hideAllModules();
  document.getElementById(id).style.display='flex';
  document.getElementById('back-btn').style.display='';
  document.getElementById('print-btn').style.display='none';
  load(); fn();
}
function openStocks(){openModule('stocks-view',()=>showSPanel('holdings'));}
function openRetirement(){openModule('ret-view',()=>showRPanel('holdings'));}
function openCrypto(){openModule('crypto-view',()=>showCPanel('holdings'));}
function openCash(){openModule('cash-view',()=>showCashPanel('accounts'));}
function openOther(){openModule('other-view',()=>showOtherPanel('assets'));}

function showSPanel(p){
  document.querySelectorAll('#stocks-view .snav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('sn-'+p)?.classList.add('active');
  renderInvestPanel('stocks',p);
}
function showRPanel(p){
  document.querySelectorAll('#ret-view .snav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('rn-'+p)?.classList.add('active');
  renderInvestPanel('retirement',p);
}
function showCPanel(p){
  document.querySelectorAll('#crypto-view .snav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('crn-'+p)?.classList.add('active');
  renderCryptoHoldings();
}
function showCashPanel(p){
  document.querySelectorAll('#cash-view .snav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('cashn-'+p)?.classList.add('active');
  renderCashModule();
}
function showOtherPanel(p){
  document.querySelectorAll('#other-view .snav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('othn-'+p)?.classList.add('active');
  renderOtherModule();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STOCK PRICE FETCHING  (Yahoo Finance via allorigins CORS proxy)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchStockPrice(ticker){
  const t=ticker.toUpperCase();
  try{
    // allorigins.win is a public CORS proxy ‚Äî wraps Yahoo Finance
    const target=encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${t}?interval=1d&range=1d`);
    const r=await fetch(`https://api.allorigins.win/get?url=${target}`,{signal:AbortSignal.timeout(8000)});
    if(!r.ok)return null;
    const wrapper=await r.json();
    const j=JSON.parse(wrapper.contents);
    const meta=j?.chart?.result?.[0]?.meta;
    if(!meta)return null;
    const price=meta.regularMarketPrice||meta.chartPreviousClose||0;
    const prev=meta.chartPreviousClose||meta.previousClose||price;
    const change=price-prev;
    const changePct=prev>0?(change/prev)*100:0;
    stockPriceCache[t]={price,change,changePct,updated:Date.now()};
    return stockPriceCache[t];
  }catch(e){return null;}
}

async function refreshStockPrices(module){
  const tickers=[...new Set(
    S.holdings.filter(h=>h.module===module&&h.ticker).map(h=>h.ticker.toUpperCase())
  )];
  if(!tickers.length)return;
  // Show loading spinners
  tickers.forEach(t=>{
    document.querySelectorAll(`.price-cell[data-ticker="${t}"]`).forEach(el=>{
      el.innerHTML=`<span style="color:var(--muted);font-size:9px">fetching‚Ä¶</span>`;
    });
  });
  await Promise.all(tickers.map(t=>fetchStockPrice(t)));
  // Update cells in place
  tickers.forEach(t=>{
    const cache=stockPriceCache[t];
    document.querySelectorAll(`.price-cell[data-ticker="${t}"]`).forEach(el=>{
      el.innerHTML=stockPriceHTML(cache);
    });
    if(!cache)return;
    document.querySelectorAll(`.val-cell[data-ticker="${t}"]`).forEach(el=>{
      const shares=parseFloat(el.dataset.shares)||0;
      el.textContent=f$(shares*cache.price);
      el.className=`val-cell ${cache.change>=0?'pos':'neg'}`;
    });
    document.querySelectorAll(`.gl-cell[data-ticker="${t}"]`).forEach(el=>{
      const shares=parseFloat(el.dataset.shares)||0;
      const cost=parseFloat(el.dataset.cost)||0;
      const gl=(cache.price-cost)*shares;
      el.textContent=`${gl>=0?'+':''}${f$(gl)}`;
      el.className=`gl-cell ${gl>=0?'pos':'neg'}`;
    });
  });
  rebuildStockSummary(module);
}

function stockPriceHTML(cache){
  if(!cache)return`<span style="color:var(--red);font-size:9px">unavailable</span>`;
  const up=cache.change>=0;
  return`<span style="color:var(--white);font-weight:500">${f2(cache.price)}</span> <span class="${up?'pos':'neg'}" style="font-size:9px">${up?'‚ñ≤':'‚ñº'}${f2(Math.abs(cache.change))} (${up?'+':''}${cache.changePct.toFixed(2)}%)</span>`;
}

function rebuildStockSummary(module){
  const holdings=S.holdings.filter(h=>h.module===module);
  let mktVal=0,costBasis=0;
  holdings.forEach(h=>{
    const cache=stockPriceCache[h.ticker?.toUpperCase()];
    const price=cache?.price||0;
    mktVal+=price*(+h.shares||0);
    costBasis+=(+h.costBasis||0)*(+h.shares||0);
  });
  const gl=mktVal-costBasis;
  const strip=document.querySelector(`#${module==='stocks'?'stocks':'ret'}-main .invest-strip`);
  if(strip)strip.innerHTML=stockStripHTML(mktVal,costBasis,gl,holdings.length);
}

function stockStripHTML(mktVal,costBasis,gl,count){
  return`
    <div class="sum-cell"><div class="sum-lbl">Market Value</div><div class="sum-val">${f$(mktVal)}</div></div>
    <div class="sum-cell"><div class="sum-lbl">Cost Basis</div><div class="sum-val">${f$(costBasis)}</div></div>
    <div class="sum-cell"><div class="sum-lbl">Unrealized G/L</div><div class="sum-val ${gl>=0?'pos':'neg'}">${gl>=0?'+':''}${f$(gl)}</div></div>
    <div class="sum-cell"><div class="sum-lbl">Positions</div><div class="sum-val">${count}</div></div>`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STOCKS / RETIREMENT RENDER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderInvestPanel(module,panel){
  const mainId=module==='stocks'?'stocks-main':'ret-main';
  const m=document.getElementById(mainId);
  if(panel==='holdings')renderHoldingsPanel(module,m);
  else if(panel==='cash')renderInvestCashPanel(module,m);
  else if(panel==='brokerages')renderBrokeragesPanel(module,m);
}

function renderHoldingsPanel(module,m){
  const holdings=S.holdings.filter(h=>h.module===module);
  let mktVal=0,costBasis=0;
  holdings.forEach(h=>{
    const cache=stockPriceCache[h.ticker?.toUpperCase()];
    const price=cache?.price||0;
    mktVal+=price*(+h.shares||0);
    costBasis+=(+h.costBasis||0)*(+h.shares||0);
  });
  const gl=mktVal-costBasis;
  m.innerHTML=`
  <div class="re-summary invest-strip" style="grid-template-columns:repeat(4,1fr)">
    ${stockStripHTML(mktVal,costBasis,gl,holdings.length)}
  </div>
  <div class="re-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div>
        <div class="page-title">${module==='stocks'?'Stock':'Retirement'} Holdings</div>
        <div class="page-sub">${module==='stocks'?'Equities ¬∑ ETFs ¬∑ Dividends':'401k ¬∑ IRA ¬∑ Pension Funds'} ¬∑ prices via Yahoo Finance</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn-a" onclick="refreshStockPrices('${module}').then(()=>toast('Prices updated!'))">‚Üª Refresh</button>
        <button class="btn-a" onclick="showAddHolding('${module}')">+ Add Position</button>
      </div>
    </div>
    ${!holdings.length
      ?`<div class="empty"><span class="empty-icon">üìà</span>No positions yet. Click + Add Position.</div>`
      :`<div class="tw"><table>
        <thead><tr>
          <th>Ticker</th><th>Account</th><th>Type</th>
          <th style="text-align:right">Shares</th>
          <th style="text-align:right">Avg Cost</th>
          <th>Live Price</th>
          <th style="text-align:right">Mkt Value</th>
          <th style="text-align:right">G / L</th>
          <th class="no-print"></th>
        </tr></thead>
        <tbody>${holdings.map(h=>{
          const t=h.ticker?.toUpperCase()||'';
          const cache=stockPriceCache[t];
          const price=cache?.price||0;
          const val=price*(+h.shares||0);
          const gl=(price-(+h.costBasis||0))*(+h.shares||0);
          return`<tr>
            <td>
              <strong style="color:var(--blue2);letter-spacing:0.06em;font-size:13px">${esc(t)}</strong>
              ${h.notes?`<div style="font-size:9px;color:var(--muted)">${esc(h.notes)}</div>`:''}
            </td>
            <td style="color:var(--muted);font-size:10px">${esc(h.account||'‚Äî')}</td>
            <td><span class="badge bg-blue" style="font-size:8px">${esc(h.assetType||'stock')}</span></td>
            <td style="text-align:right">${(+h.shares).toLocaleString(undefined,{maximumFractionDigits:6})}</td>
            <td style="text-align:right;color:var(--muted)">${f2(+h.costBasis||0)}</td>
            <td class="price-cell" data-ticker="${t}">${stockPriceHTML(cache)}</td>
            <td class="val-cell" style="text-align:right" data-ticker="${t}" data-shares="${h.shares}">${price?f$(val):'‚Äî'}</td>
            <td class="gl-cell ${gl>=0?'pos':'neg'}" style="text-align:right" data-ticker="${t}" data-shares="${h.shares}" data-cost="${h.costBasis}">${price?(gl>=0?'+':'')+f$(gl):'‚Äî'}</td>
            <td class="no-print"><button class="xbtn" onclick="delHolding('${h.id}','${module}')">‚úï</button></td>
          </tr>`;
        }).join('')}</tbody>
        <tfoot><tr class="tr-tot">
          <td colspan="5"><strong>Total</strong></td><td></td>
          <td style="text-align:right">${f$(mktVal)||'‚Äî'}</td>
          <td class="${gl>=0?'pos':'neg'}" style="text-align:right">${mktVal?(gl>=0?'+':'')+f$(gl):'‚Äî'}</td>
          <td class="no-print"></td>
        </tr></tfoot>
      </table></div>`}
    <div style="margin-top:12px;font-size:9px;color:var(--muted2)">Prices load on Refresh. Uses Yahoo Finance via CORS proxy. Market hours only.</div>
  </div>`;
  if(holdings.length)refreshStockPrices(module);
}

function renderInvestCashPanel(module,m){
  const positions=S.cashPositions.filter(c=>c.module===module);
  const total=positions.reduce((s,c)=>s+(+c.balance||0),0);
  m.innerHTML=`
  <div class="re-summary" style="grid-template-columns:repeat(2,1fr)">
    <div class="sum-cell"><div class="sum-lbl">Cash / Sweep</div><div class="sum-val pos">${f$(total)}</div></div>
    <div class="sum-cell"><div class="sum-lbl">Accounts</div><div class="sum-val">${positions.length}</div></div>
  </div>
  <div class="re-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div><div class="page-title">Cash / Sweep</div><div class="page-sub">Uninvested cash, money market, SPAXX</div></div>
      <button class="btn-a" onclick="showAddInvestCash('${module}')">+ Add</button>
    </div>
    ${!positions.length?`<div class="empty"><span class="empty-icon">üíµ</span>No cash positions.</div>`
    :`<div class="tw"><table>
      <thead><tr><th>Account</th><th>Type</th><th style="text-align:right">Balance</th><th>Notes</th><th class="no-print"></th></tr></thead>
      <tbody>${positions.map(c=>`<tr>
        <td><strong>${esc(c.name)}</strong></td>
        <td><span class="badge bg-blue">${esc(c.type||'Cash')}</span></td>
        <td class="pos" style="text-align:right">${f$(c.balance)}</td>
        <td style="color:var(--muted);font-size:10px">${esc(c.notes||'‚Äî')}</td>
        <td class="no-print"><button class="xbtn" onclick="delInvestCash('${c.id}','${module}')">‚úï</button></td>
      </tr>`).join('')}</tbody>
      <tfoot><tr class="tr-tot"><td colspan="2"><strong>Total</strong></td><td class="pos" style="text-align:right">${f$(total)}</td><td colspan="2"></td></tr></tfoot>
    </table></div>`}
  </div>`;
}

function renderBrokeragesPanel(module,m){
  const brokerages=S.brokerages.filter(b=>b.module===module);
  m.innerHTML=`
  <div class="re-content" style="padding-top:28px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <div><div class="page-title">Linked Brokerages</div><div class="page-sub">Quick-access links ¬∑ read-only reference</div></div>
      <button class="btn-a" onclick="showAddBrokerage('${module}')">+ Link Brokerage</button>
    </div>
    <div style="background:rgba(122,168,212,0.06);border:1px solid rgba(122,168,212,0.15);padding:12px 16px;margin-bottom:18px;font-size:10px;color:var(--muted);line-height:1.8">
      Paste your brokerage portfolio URL. Click <strong style="color:var(--white)">Open ‚Üí</strong> to view live positions, then manually update holdings above. No credentials stored.
    </div>
    ${!brokerages.length?`<div class="empty"><span class="empty-icon">üîó</span>No brokerages linked.</div>`
    :`<div style="display:grid;gap:10px">${brokerages.map(b=>`
      <div class="tenant-card" style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:14px;color:var(--white);font-family:'Playfair Display',serif">${esc(b.name)}</div>
          <div style="font-size:9px;color:var(--muted);margin-top:3px">${esc(b.accountType||'')}${b.notes?' ¬∑ '+esc(b.notes):''}</div>
          <div style="font-size:9px;color:var(--muted2);margin-top:2px">${esc(b.url||'')}</div>
        </div>
        <div style="display:flex;gap:8px;flex-shrink:0;margin-left:16px">
          <a href="${esc(b.url||'#')}" target="_blank" rel="noopener" class="btn-a" style="text-decoration:none">Open ‚Üí</a>
          <button class="xbtn" onclick="delBrokerage('${b.id}','${module}')">‚úï</button>
        </div>
      </div>`).join('')}</div>`}
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CRYPTO ‚Äî COINGECKO FREE API (CORS-friendly)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchCryptoPrices(ids){
  if(!ids.length)return;
  try{
    const url=`https://api.coingecko.com/api/v3/simple/price?ids=${ids.join(',')}&vs_currencies=usd&include_24hr_change=true`;
    const r=await fetch(url,{signal:AbortSignal.timeout(10000)});
    if(!r.ok)return;
    const j=await r.json();
    Object.entries(j).forEach(([id,data])=>{
      cryptoPriceCache[id]={price:data.usd||0,change24h:data.usd_24h_change||0};
    });
  }catch(e){}
}

async function refreshCryptoPrices(){
  const ids=[...new Set(S.cryptos.map(c=>c.coinId).filter(Boolean))];
  if(!ids.length)return;
  document.querySelectorAll('.crypto-price-cell').forEach(el=>{
    el.innerHTML=`<span style="color:var(--muted);font-size:9px">fetching‚Ä¶</span>`;
  });
  await fetchCryptoPrices(ids);
  renderCryptoHoldings(); // full re-render with live prices
}

function renderCryptoHoldings(){
  const m=document.getElementById('crypto-main');
  const holdings=S.cryptos;
  let totalVal=0,totalCost=0;
  holdings.forEach(c=>{
    const cache=cryptoPriceCache[c.coinId];
    const price=cache?.price||0;
    totalVal+=price*(+c.amount||0);
    totalCost+=(+c.costBasis||0)*(+c.amount||0);
  });
  const gl=totalVal-totalCost;
  m.innerHTML=`
  <div class="re-summary" style="grid-template-columns:repeat(4,1fr)">
    <div class="sum-cell"><div class="sum-lbl">Portfolio Value</div><div class="sum-val">${f$(totalVal)||'‚Äî'}</div></div>
    <div class="sum-cell"><div class="sum-lbl">Cost Basis</div><div class="sum-val">${f$(totalCost)}</div></div>
    <div class="sum-cell"><div class="sum-lbl">Unrealized G/L</div><div class="sum-val ${gl>=0?'pos':'neg'}">${totalVal?(gl>=0?'+':'')+f$(gl):'‚Äî'}</div></div>
    <div class="sum-cell"><div class="sum-lbl">Holdings</div><div class="sum-val">${holdings.length}</div></div>
  </div>
  <div class="re-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div>
        <div class="page-title">Crypto Holdings</div>
        <div class="page-sub">Live prices via CoinGecko free API</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn-a" onclick="refreshCryptoPrices().then(()=>toast('Crypto prices updated!'))">‚Üª Refresh</button>
        <button class="btn-a" onclick="openModal('modal-crypto')">+ Add Coin</button>
      </div>
    </div>
    ${!holdings.length?`<div class="empty"><span class="empty-icon">‚Çø</span>No crypto holdings. Click + Add Coin.<br><span style="font-size:10px;color:var(--muted2)">Use CoinGecko IDs: bitcoin, ethereum, solana, cardano, etc.</span></div>`
    :`<div class="tw"><table>
      <thead><tr>
        <th>Coin</th><th>Wallet / Notes</th>
        <th style="text-align:right">Amount</th>
        <th style="text-align:right">Avg Cost</th>
        <th>Live Price (24h)</th>
        <th style="text-align:right">Value</th>
        <th style="text-align:right">G / L</th>
        <th class="no-print"></th>
      </tr></thead>
      <tbody>${holdings.map(c=>{
        const cache=cryptoPriceCache[c.coinId];
        const price=cache?.price||0;
        const val=price*(+c.amount||0);
        const gl=(price-(+c.costBasis||0))*(+c.amount||0);
        const up=(cache?.change24h||0)>=0;
        return`<tr>
          <td>
            <strong style="color:var(--yellow);letter-spacing:0.04em;font-size:13px">${esc(c.name||c.coinId)}</strong>
            <div style="font-size:9px;color:var(--muted)">${esc(c.coinId)}</div>
          </td>
          <td style="color:var(--muted);font-size:10px">${esc(c.notes||'‚Äî')}</td>
          <td style="text-align:right">${(+c.amount).toLocaleString(undefined,{maximumFractionDigits:8})}</td>
          <td style="text-align:right;color:var(--muted)">${f2(+c.costBasis||0)}</td>
          <td class="crypto-price-cell">
            ${cache
              ?`<span style="color:var(--white);font-weight:500">${f2(price)}</span> <span class="${up?'pos':'neg'}" style="font-size:9px">${up?'‚ñ≤':'‚ñº'}${Math.abs(cache.change24h).toFixed(2)}% 24h</span>`
              :`<span style="color:var(--muted)">‚Äî</span>`}
          </td>
          <td style="text-align:right" class="${val>0?(gl>=0?'pos':'neg'):''}">${price?f$(val):'‚Äî'}</td>
          <td style="text-align:right" class="${gl>=0?'pos':'neg'}">${price?(gl>=0?'+':'')+f$(gl):'‚Äî'}</td>
          <td class="no-print"><button class="xbtn" onclick="delCrypto('${c.id}')">‚úï</button></td>
        </tr>`;
      }).join('')}</tbody>
      <tfoot><tr class="tr-tot">
        <td colspan="4"><strong>Total</strong></td><td></td>
        <td style="text-align:right">${totalVal?f$(totalVal):'‚Äî'}</td>
        <td class="${gl>=0?'pos':'neg'}" style="text-align:right">${totalVal?(gl>=0?'+':'')+f$(gl):'‚Äî'}</td>
        <td class="no-print"></td>
      </tr></tfoot>
    </table></div>`}
    <div style="margin-top:12px;font-size:9px;color:var(--muted2)">Prices from CoinGecko free API. Use exact CoinGecko IDs (check coingecko.com). Click Refresh to update.</div>
  </div>`;
  if(holdings.length&&!Object.keys(cryptoPriceCache).length)refreshCryptoPrices();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CASH MODULE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCashModule(){
  const m=document.getElementById('cash-main');
  const accts=S.cashAccounts;
  const total=accts.reduce((s,a)=>s+(+a.balance||0),0);
  const annualInterest=accts.reduce((s,a)=>s+(+a.balance||0)*(+a.rate||0)/100,0);
  m.innerHTML=`
  <div class="re-summary" style="grid-template-columns:repeat(3,1fr)">
    <div class="sum-cell"><div class="sum-lbl">Total Cash</div><div class="sum-val pos">${f$(total)}</div></div>
    <div class="sum-cell"><div class="sum-lbl">Annual Interest</div><div class="sum-val">${f$(annualInterest)}<div class="sum-sub">est. at current rates</div></div></div>
    <div class="sum-cell"><div class="sum-lbl">Accounts</div><div class="sum-val">${accts.length}</div></div>
  </div>
  <div class="re-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div><div class="page-title">Cash Holdings</div><div class="page-sub">Checking ¬∑ Savings ¬∑ Money Market ¬∑ CDs</div></div>
      <button class="btn-a" onclick="openModal('modal-cash-acct')">+ Add Account</button>
    </div>
    ${!accts.length?`<div class="empty"><span class="empty-icon">üíµ</span>No cash accounts yet. Add your checking, savings, and money market accounts.</div>`
    :`<div class="tw"><table>
      <thead><tr><th>Account Name</th><th>Type</th><th style="text-align:right">Balance</th><th style="text-align:right">APY %</th><th style="text-align:right">Est. Annual Interest</th><th>Notes</th><th class="no-print"></th></tr></thead>
      <tbody>${accts.map(a=>{
        const interest=(+a.balance||0)*(+a.rate||0)/100;
        return`<tr>
          <td><strong>${esc(a.name)}</strong></td>
          <td><span class="badge bg-green" style="font-size:8px">${esc(a.type||'Cash')}</span></td>
          <td class="pos" style="text-align:right">${f$(a.balance)}</td>
          <td style="text-align:right;color:var(--muted)">${+a.rate?f2(a.rate)+'%':'‚Äî'}</td>
          <td style="text-align:right" class="${interest>0?'pos':''}">${interest>0?f$(interest):'‚Äî'}</td>
          <td style="color:var(--muted);font-size:10px">${esc(a.notes||'‚Äî')}</td>
          <td class="no-print"><button class="xbtn" onclick="delCashAcct('${a.id}')">‚úï</button></td>
        </tr>`;
      }).join('')}</tbody>
      <tfoot><tr class="tr-tot"><td colspan="2"><strong>Total</strong></td><td class="pos" style="text-align:right">${f$(total)}</td><td></td><td class="pos" style="text-align:right">${f$(annualInterest)}</td><td colspan="2"></td></tr></tfoot>
    </table></div>`}
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// OTHER ASSETS MODULE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderOtherModule(){
  const m=document.getElementById('other-main');
  const assets=S.otherAssets;
  const totalCost=assets.reduce((s,a)=>s+(+a.cost||0)*(+a.ownership||100)/100,0);
  const totalVal=assets.reduce((s,a)=>s+(+a.currentVal||0)*(+a.ownership||100)/100,0);
  const gl=totalVal-totalCost;
  m.innerHTML=`
  <div class="re-summary" style="grid-template-columns:repeat(4,1fr)">
    <div class="sum-cell"><div class="sum-lbl">Total Est. Value</div><div class="sum-val">${f$(totalVal)}</div></div>
    <div class="sum-cell"><div class="sum-lbl">Total Cost Basis</div><div class="sum-val">${f$(totalCost)}</div></div>
    <div class="sum-cell"><div class="sum-lbl">Unrealized G/L</div><div class="sum-val ${gl>=0?'pos':'neg'}">${gl>=0?'+':''}${f$(gl)}</div></div>
    <div class="sum-cell"><div class="sum-lbl">Assets</div><div class="sum-val">${assets.length}</div></div>
  </div>
  <div class="re-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div><div class="page-title">Other Assets</div><div class="page-sub">Business interests ¬∑ Vehicles ¬∑ Collectibles ¬∑ Notes</div></div>
      <button class="btn-a" onclick="openModal('modal-other');document.getElementById('mo-date').value=td()">+ Add Asset</button>
    </div>
    ${!assets.length?`<div class="empty"><span class="empty-icon">‚óà</span>No other assets yet. Add businesses, vehicles, collectibles, or any other assets you own.</div>`
    :`<div class="tw"><table>
      <thead><tr><th>Asset</th><th>Category</th><th>Acquired</th><th style="text-align:right">Cost Basis</th><th style="text-align:right">Est. Value</th><th style="text-align:right">Own %</th><th style="text-align:right">G / L</th><th>Notes</th><th class="no-print"></th></tr></thead>
      <tbody>${assets.map(a=>{
        const own=(+a.ownership||100)/100;
        const cost=(+a.cost||0)*own;
        const val=(+a.currentVal||0)*own;
        const gl=val-cost;
        return`<tr>
          <td><strong style="font-family:'Playfair Display',serif">${esc(a.name)}</strong></td>
          <td><span class="badge bg-blue" style="font-size:8px">${esc(a.category||'Other')}</span></td>
          <td style="color:var(--muted);font-size:10px">${a.dateAcquired||'‚Äî'}</td>
          <td style="text-align:right;color:var(--muted)">${f$(cost)}</td>
          <td style="text-align:right" class="${val>cost?'pos':val<cost?'neg':''}">${f$(val)}</td>
          <td style="text-align:right;color:var(--muted)">${+a.ownership!==100?a.ownership+'%':'100%'}</td>
          <td class="${gl>=0?'pos':'neg'}" style="text-align:right">${gl>=0?'+':''}${f$(gl)}</td>
          <td style="color:var(--muted);font-size:10px;max-width:160px;overflow:hidden;text-overflow:ellipsis">${esc(a.notes||'‚Äî')}</td>
          <td class="no-print"><button class="xbtn" onclick="delOther('${a.id}')">‚úï</button></td>
        </tr>`;
      }).join('')}</tbody>
      <tfoot><tr class="tr-tot"><td colspan="3"><strong>Total (adj. ownership)</strong></td><td style="text-align:right">${f$(totalCost)}</td><td style="text-align:right">${f$(totalVal)}</td><td></td><td class="${gl>=0?'pos':'neg'}" style="text-align:right">${gl>=0?'+':''}${f$(gl)}</td><td colspan="2"></td></tr></tfoot>
    </table></div>`}
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CRUD ‚Äî STOCKS/RETIREMENT HOLDINGS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showAddHolding(module){
  ['mh-ticker','mh-account','mh-notes','mh-shares','mh-cost'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  document.getElementById('mh-module').value=module;
  document.getElementById('mh-edit-id').value='';
  document.getElementById('modal-holding-title').textContent='Add Position';
  openModal('modal-holding');
}
function saveHolding(){
  const ticker=document.getElementById('mh-ticker').value.trim().toUpperCase();
  if(!ticker){toast('Ticker required.');return;}
  const module=document.getElementById('mh-module').value;
  const data={ticker,account:document.getElementById('mh-account').value.trim(),shares:parseFloat(document.getElementById('mh-shares').value)||0,costBasis:parseFloat(document.getElementById('mh-cost').value)||0,assetType:document.getElementById('mh-type').value,notes:document.getElementById('mh-notes').value.trim(),module};
  const eid=document.getElementById('mh-edit-id').value;
  if(eid){const h=S.holdings.find(x=>x.id===eid);if(h)Object.assign(h,data);}
  else S.holdings.push({id:'h'+Date.now(),...data});
  save();closeModal('modal-holding');
  renderHoldingsPanel(module,document.getElementById(module==='stocks'?'stocks-main':'ret-main'));
  toast('Position saved!');
}
function delHolding(id,module){
  if(!confirm('Remove position?'))return;
  S.holdings=S.holdings.filter(h=>h.id!==id);save();
  renderHoldingsPanel(module,document.getElementById(module==='stocks'?'stocks-main':'ret-main'));
}

// invest cash (brokerage sweep)
function showAddInvestCash(module){
  ['mc-name','mc-notes','mc-bal'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  document.getElementById('mc-module').value=module;
  openModal('modal-cash');
}
function saveCash(){
  const name=document.getElementById('mc-name').value.trim();
  if(!name){toast('Account name required.');return;}
  const module=document.getElementById('mc-module').value;
  S.cashPositions.push({id:'c'+Date.now(),name,balance:parseFloat(document.getElementById('mc-bal').value)||0,type:document.getElementById('mc-type').value,notes:document.getElementById('mc-notes').value.trim(),module});
  save();closeModal('modal-cash');
  renderInvestCashPanel(module,document.getElementById(module==='stocks'?'stocks-main':'ret-main'));
}
function delInvestCash(id,module){
  if(!confirm('Remove?'))return;
  S.cashPositions=S.cashPositions.filter(c=>c.id!==id);save();
  renderInvestCashPanel(module,document.getElementById(module==='stocks'?'stocks-main':'ret-main'));
}

// brokerages
function showAddBrokerage(module){
  ['mb-name','mb-url','mb-notes'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  document.getElementById('mb-module').value=module;
  openModal('modal-brokerage');
}
function saveBrokerage(){
  const name=document.getElementById('mb-name').value.trim();
  if(!name){toast('Name required.');return;}
  const module=document.getElementById('mb-module').value;
  S.brokerages.push({id:'b'+Date.now(),name,url:document.getElementById('mb-url').value.trim(),accountType:document.getElementById('mb-atype').value,notes:document.getElementById('mb-notes').value.trim(),module});
  save();closeModal('modal-brokerage');
  renderBrokeragesPanel(module,document.getElementById(module==='stocks'?'stocks-main':'ret-main'));
}
function delBrokerage(id,module){
  if(!confirm('Remove?'))return;
  S.brokerages=S.brokerages.filter(b=>b.id!==id);save();
  renderBrokeragesPanel(module,document.getElementById(module==='stocks'?'stocks-main':'ret-main'));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CRUD ‚Äî CRYPTO
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveCrypto(){
  const coinId=document.getElementById('mcr-id').value.trim().toLowerCase();
  const name=document.getElementById('mcr-name').value.trim();
  if(!coinId){toast('CoinGecko ID required.');return;}
  S.cryptos.push({id:'cr'+Date.now(),coinId,name:name||coinId,amount:parseFloat(document.getElementById('mcr-amt').value)||0,costBasis:parseFloat(document.getElementById('mcr-cost').value)||0,notes:document.getElementById('mcr-notes').value.trim()});
  save();closeModal('modal-crypto');
  renderCryptoHoldings();
  toast('Crypto added!');
}
function delCrypto(id){
  if(!confirm('Remove?'))return;
  S.cryptos=S.cryptos.filter(c=>c.id!==id);save();renderCryptoHoldings();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CRUD ‚Äî CASH ACCOUNTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveCashAcct(){
  const name=document.getElementById('mca-name').value.trim();
  if(!name){toast('Account name required.');return;}
  S.cashAccounts.push({id:'ca'+Date.now(),name,balance:parseFloat(document.getElementById('mca-bal').value)||0,type:document.getElementById('mca-type').value,rate:parseFloat(document.getElementById('mca-rate').value)||0,notes:document.getElementById('mca-notes').value.trim()});
  save();closeModal('modal-cash-acct');renderCashModule();toast('Account added!');
}
function delCashAcct(id){
  if(!confirm('Remove?'))return;
  S.cashAccounts=S.cashAccounts.filter(a=>a.id!==id);save();renderCashModule();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CRUD ‚Äî OTHER ASSETS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveOther(){
  const name=document.getElementById('mo-name').value.trim();
  if(!name){toast('Asset name required.');return;}
  S.otherAssets.push({id:'oa'+Date.now(),name,category:document.getElementById('mo-cat').value,dateAcquired:document.getElementById('mo-date').value,cost:parseFloat(document.getElementById('mo-cost').value)||0,currentVal:parseFloat(document.getElementById('mo-val').value)||0,ownership:parseFloat(document.getElementById('mo-own').value)||100,notes:document.getElementById('mo-notes').value.trim()});
  save();closeModal('modal-other');renderOtherModule();toast('Asset added!');
}
function delOther(id){
  if(!confirm('Remove?'))return;
  S.otherAssets=S.otherAssets.filter(a=>a.id!==id);save();renderOtherModule();
}

function f2(v){return(+v||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// NAVIGATION ‚Äî unified navTo()
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ALL_VIEWS=['home-view','portfolio-view','scanner-view','re-view','stocks-view','ret-view','crypto-view','cash-view','other-view','ai-view'];
const NAV_IDS=['gnav-home','gnav-scanner','gnav-ai','gnav-portfolio','gnav-re','gnav-stocks','gnav-retirement','gnav-crypto','gnav-cash','gnav-other'];

function navTo(page){
  ALL_VIEWS.forEach(id=>{
    const el=document.getElementById(id);
    if(el)el.style.display='none';
  });
  NAV_IDS.forEach(id=>document.getElementById(id)?.classList.remove('active'));
  document.getElementById('print-btn').style.display=page==='re'?'':'none';

  if(page==='home'){
    document.getElementById('home-view').style.display='flex';
    document.getElementById('gnav-home').classList.add('active');
    initDashboard();
  } else if(page==='ai'){
    document.getElementById('ai-view').style.display='flex';
    document.getElementById('gnav-ai').classList.add('active');
    initAIAdvisor();
  } else if(page==='portfolio'){
    document.getElementById('portfolio-view').style.display='flex';
    document.getElementById('gnav-portfolio').classList.add('active');
    renderPortfolioCards();
  } else if(page==='scanner'){
    document.getElementById('scanner-view').style.display='flex';
    document.getElementById('gnav-scanner').classList.add('active');
    setScanMode('crypto');
    setTimeout(()=>{ loadTVChart('BTC','Bitcoin'); }, 200);
  } else if(page==='re'){
    document.getElementById('re-view').style.display='flex';
    document.getElementById('gnav-re').classList.add('active');
    document.getElementById('print-btn').style.display='';
    load().then(()=>{renderSidebar();showPanel('overview');});
  } else if(page==='stocks'){
    document.getElementById('stocks-view').style.display='flex';
    document.getElementById('gnav-stocks').classList.add('active');
    load().then(()=>showSPanel('holdings'));
  } else if(page==='retirement'){
    document.getElementById('ret-view').style.display='flex';
    document.getElementById('gnav-retirement').classList.add('active');
    load().then(()=>showRPanel('holdings'));
  } else if(page==='crypto'){
    document.getElementById('crypto-view').style.display='flex';
    document.getElementById('gnav-crypto').classList.add('active');
    load().then(()=>showCPanel('holdings'));
  } else if(page==='cash'){
    document.getElementById('cash-view').style.display='flex';
    document.getElementById('gnav-cash').classList.add('active');
    load().then(()=>showCashPanel('accounts'));
  } else if(page==='other'){
    document.getElementById('other-view').style.display='flex';
    document.getElementById('gnav-other').classList.add('active');
    load().then(()=>showOtherPanel('assets'));
  }
}

// Keep goHome for legacy calls in RE module
function goHome(){navTo('home');}
function openRE(){navTo('re');}
function openStocks(){navTo('stocks');}
function openRetirement(){navTo('retirement');}
function openCrypto(){navTo('crypto');}
function openCash(){navTo('cash');}
function openOther(){navTo('other');}
function openModule(id,fn){} // legacy no-op

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PORTFOLIO OVERVIEW CARDS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPortfolioCards(){
  const container=document.getElementById('portfolio-cards');
  if(!container)return;
  const cards=[
    {page:'re',icon:'üè†',name:'Real Estate',sub:'Properties ¬∑ Tenants<br>Depreciation ¬∑ Statements',ca:'#7aa8d4'},
    {page:'stocks',icon:'üìà',name:'Stocks',sub:'Equities ¬∑ ETFs ¬∑ Dividends<br>Live Prices ¬∑ Brokerage Link',ca:'#70c090'},
    {page:'retirement',icon:'üè¶',name:'Retirement',sub:'401k ¬∑ IRA ¬∑ Pension<br>Live Prices ¬∑ Brokerage Link',ca:'#9a80c8'},
    {page:'crypto',icon:'‚Çø',name:'Crypto',sub:'Bitcoin ¬∑ Altcoins ¬∑ DeFi<br>Live Prices via CoinGecko',ca:'#d4b870'},
    {page:'cash',icon:'üíµ',name:'Cash',sub:'Savings ¬∑ Checking ¬∑ CDs<br>Track all liquid holdings',ca:'#4a9e8e'},
    {page:'other',icon:'‚óà',name:'Other',sub:'Business ¬∑ Collectibles<br>Cost basis & current value',ca:'#9a9a9a'},
  ];
  container.innerHTML=cards.map((c,i)=>`
    <div onclick="navTo('${c.page}')" style="background:var(--surface);border:1px solid var(--border);padding:30px 26px;cursor:pointer;position:relative;overflow:hidden;transition:transform 0.25s,box-shadow 0.25s,border-color 0.25s;animation:fadeUp 0.5s ease both;animation-delay:${(i+1)*0.05}s;--ca:${c.ca}">
      <div style="position:absolute;top:0;left:0;right:0;height:2px;background:${c.ca};transform:scaleX(0);transform-origin:left;transition:transform 0.3s" class="card-top-bar"></div>
      <span style="font-size:24px;margin-bottom:14px;display:block">${c.icon}</span>
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:400;color:var(--text);margin-bottom:6px">${c.name}</div>
      <div style="font-size:9px;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);line-height:1.7">${c.sub}</div>
      <div style="position:absolute;bottom:20px;right:20px;color:${c.ca};opacity:0;transform:translate(-3px,3px);transition:all 0.25s;font-size:16px" class="card-arrow">‚Üó</div>
    </div>`).join('');
  // Re-attach hover effects
  container.querySelectorAll('[onclick]').forEach(el=>{
    el.addEventListener('mouseenter',()=>{el.style.transform='translateY(-3px)';el.style.boxShadow='0 16px 48px rgba(0,0,0,0.35)';el.querySelector('.card-top-bar').style.transform='scaleX(1)';el.querySelector('.card-arrow').style.opacity='1';el.querySelector('.card-arrow').style.transform='translate(0,0)';});
    el.addEventListener('mouseleave',()=>{el.style.transform='';el.style.boxShadow='';el.querySelector('.card-top-bar').style.transform='';el.querySelector('.card-arrow').style.opacity='0';el.querySelector('.card-arrow').style.transform='translate(-3px,3px)';});
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DASHBOARD ‚Äî NEWS, IDEAS, ALERTS, SECTORS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let newsTab='news';
let dashboardInited=false;

function initDashboard(){
  renderMarketPulse();
  renderSectorsPanel();
  switchNewsTab(newsTab);
  if(!dashboardInited){fetchMarketPulse();dashboardInited=true;}
}

function switchNewsTab(tab){
  newsTab=tab;
  ['news','ideas','alerts'].forEach(t=>{
    document.getElementById('ntab-'+t)?.classList.toggle('active',t===tab);
  });
  if(tab==='news')renderNewsPanel();
  else if(tab==='ideas')renderIdeasPanel();
  else if(tab==='alerts')renderDashboardAlerts();
}

// Live financial news via RSS-to-JSON (rss2json.com public proxy)
const NEWS_FEEDS=[
  {name:'CNBC',url:'https://search.cnbc.com/rs/search/combinedcms/view.xml?partnerId=wrss01&id=100003114'},
  {name:'Reuters',url:'https://feeds.reuters.com/reuters/businessNews'},
  {name:'MarketWatch',url:'https://feeds.marketwatch.com/marketwatch/topstories'},
];
let cachedNews=[];
let newsFetched=false;

async function renderNewsPanel(){
  const panel=document.getElementById('news-panel');
  panel.innerHTML=`<div style="padding:20px;color:var(--muted);font-size:10px;text-align:center"><div class="chat-typing" style="justify-content:center"><span></span><span></span><span></span></div><div style="margin-top:8px">Loading live news‚Ä¶</div></div>`;
  if(!newsFetched){
    await fetchLiveNews();
    newsFetched=true;
  }
  renderNewsList();
}

async function fetchLiveNews(){
  const proxyBase='https://api.rss2json.com/v1/api.json?rss_url=';
  const feeds=[
    {src:'CNBC Markets',url:'https://search.cnbc.com/rs/search/combinedcms/view.xml?partnerId=wrss01&id=100003114'},
    {src:'Reuters Business',url:'https://feeds.reuters.com/reuters/businessNews'},
  ];
  const articles=[];
  await Promise.allSettled(feeds.map(async f=>{
    try{
      const r=await fetch(proxyBase+encodeURIComponent(f.url)+'&count=15',{signal:AbortSignal.timeout(8000)});
      const j=await r.json();
      if(j.status==='ok'&&j.items){
        j.items.forEach(item=>{
          articles.push({
            source:f.src,
            title:item.title,
            link:item.link,
            date:item.pubDate,
            tag:detectTag(item.title)
          });
        });
      }
    }catch(e){}
  }));
  // Sort by date newest first
  cachedNews=articles.sort((a,b)=>new Date(b.date)-new Date(a.date));
}

function detectTag(title){
  const t=title.toLowerCase();
  if(t.includes('earnings')||t.includes('eps')||t.includes('revenue')||t.includes('quarterly'))return'EARNINGS';
  if(t.includes('fed')||t.includes('federal reserve')||t.includes('interest rate')||t.includes('inflation')||t.includes('cpi'))return'FED/MACRO';
  if(t.includes('bitcoin')||t.includes('crypto')||t.includes('ethereum'))return'CRYPTO';
  if(t.includes('breaking')||t.includes('flash'))return'BREAKING';
  if(t.includes('gdp')||t.includes('jobs')||t.includes('unemployment')||t.includes('payroll'))return'ECONOMIC DATA';
  return null;
}

function tagHTML(tag){
  if(!tag)return'';
  const map={'EARNINGS':'tag-earnings','FED/MACRO':'tag-fed','CRYPTO':'tag-earnings','BREAKING':'tag-breaking','ECONOMIC DATA':'tag-macro'};
  return`<span class="news-tag ${map[tag]||'tag-macro'}">${tag}</span>`;
}

function renderNewsList(){
  const panel=document.getElementById('news-panel');
  if(!cachedNews.length){
    panel.innerHTML=`<div style="padding:20px 16px">
      <div style="font-size:10px;color:var(--muted);margin-bottom:16px;line-height:1.8">Live news feeds require internet access. While loading, here are today's key market themes to watch:</div>
      ${MANUAL_NEWS.map(n=>`<div class="news-card"><div class="news-source">${n.source}${tagHTML(n.tag)}</div><div class="news-headline">${n.title}</div><div class="news-meta">${n.time}</div></div>`).join('')}
    </div>`;
    return;
  }
  panel.innerHTML=cachedNews.slice(0,30).map((n,i)=>`
    <a href="${esc(n.link)}" target="_blank" rel="noopener" style="text-decoration:none;display:block">
    <div class="news-card" style="animation-delay:${i*0.03}s">
      <div class="news-source">${esc(n.source)}${tagHTML(n.tag)}</div>
      <div class="news-headline">${esc(n.title)}</div>
      <div class="news-meta">${formatNewsDate(n.date)}</div>
    </div></a>`).join('');
}

function formatNewsDate(d){
  if(!d)return'';
  try{const dt=new Date(d);const now=new Date();const diff=Math.floor((now-dt)/60000);
    if(diff<60)return diff+'m ago';if(diff<1440)return Math.floor(diff/60)+'h ago';return dt.toLocaleDateString();}
  catch(e){return d;}
}

// Fallback manual news for when feeds are offline
const MANUAL_NEWS=[
  {source:'CNBC',title:'Markets watchful as Fed holds rates steady ‚Äî next move may be September',time:'Today',tag:'FED/MACRO'},
  {source:'Reuters',title:'S&P 500 hits new all-time high driven by AI and tech momentum',time:'Today',tag:'BREAKING'},
  {source:'Bloomberg',title:'Q1 earnings season beats expectations with 78% of S&P 500 companies topping estimates',time:'Today',tag:'EARNINGS'},
  {source:'MarketWatch',title:'Gold surges past $2,400 on safe-haven demand and dollar weakness',time:'Today',tag:'ECONOMIC DATA'},
  {source:'CNBC',title:'Small-cap Russell 2000 outperforms large caps amid rotation trade',time:'Today',tag:null},
  {source:'Reuters',title:'Bitcoin consolidates after recent pullback ‚Äî analysts eye $95K support level',time:'Today',tag:'CRYPTO'},
  {source:'Bloomberg',title:'Defense stocks rally on geopolitical tensions and increased NATO spending',time:'Today',tag:null},
  {source:'CNBC',title:'Drone sector ETFs see record inflows as commercial adoption accelerates',time:'Today',tag:null},
];

// Investment ideas panel
const INVESTMENT_IDEAS=[
  {ticker:'IWM',dir:'long',source:'Momentum / Rotation',note:'Small-cap rotation in full swing. IWM breaking above 200MA with strong volume. Rate cut expectations support small caps.'},
  {ticker:'GLD',dir:'long',source:'Macro / Safe Haven',note:'Gold holding above $2,400. Central bank buying continues. Dollar weakness is tailwind. Target $2,600.'},
  {ticker:'ITA',dir:'long',source:'Defense Sector',note:'iShares Aerospace & Defense ETF. Geopolitical spending cycle. Strong earnings across Lockheed, RTX, Northrop.'},
  {ticker:'DRON',dir:'long',source:'Emerging Sector',note:'Drone sector seeing massive institutional inflows. Commercial + defense demand. Early innings of multi-year theme.'},
  {ticker:'SLV',dir:'long',source:'Commodities',note:'Silver lagging gold but industrial demand from solar/EVs growing. Historically cheap vs gold ratio. Catch-up trade.'},
  {ticker:'BTC-USD',dir:'long',source:'Crypto',note:'Bitcoin consolidating at key support. ETF flows positive. Halving cycle suggests long-term uptrend intact.'},
  {ticker:'NVDA',dir:'long',source:'AI / Tech',note:'AI capex supercycle continuing. Data center revenue beat. Pullbacks remain buying opportunities in secular trend.'},
  {ticker:'ARKK',dir:'short',source:'Risk-Off Signal',note:'High-multiple growth names vulnerable if rates stay higher longer. Weak balance sheets. Risk/reward skewed short.'},
  {ticker:'TLT',dir:'short',source:'Rates',note:'Long bonds still under pressure. Sticky inflation + higher-for-longer rates narrative keeps pressure on duration.'},
];

function renderIdeasPanel(){
  const panel=document.getElementById('news-panel');
  panel.innerHTML=`
    <div style="padding:10px 14px;border-bottom:1px solid var(--border);font-size:9px;color:var(--muted);line-height:1.7">
      Investment ideas based on current market environment. Click any to open chart.
    </div>
    ${INVESTMENT_IDEAS.map((idea,i)=>`
    <div class="idea-card" onclick="navTo('scanner');setTimeout(()=>{document.getElementById('tv-symbol-input').value='${idea.ticker}';loadTVChart('${idea.ticker}')},200)" style="animation-delay:${i*0.04}s">
      <div class="idea-header">
        <span class="idea-ticker">${idea.ticker}</span>
        <span class="idea-dir dir-${idea.dir}">${idea.dir.toUpperCase()}</span>
      </div>
      <div class="idea-source">${idea.source}</div>
      <div class="idea-note">${idea.note}</div>
    </div>`).join('')}`;
}

function renderDashboardAlerts(){
  const panel=document.getElementById('news-panel');
  const alerts=scanAlerts||[];
  if(!alerts.length){
    panel.innerHTML=`<div style="padding:20px;text-align:center;color:var(--muted);font-size:10px;line-height:2">
      No scanner alerts active.<br>
      <span style="color:var(--blue2);cursor:pointer" onclick="navTo('scanner')">Open Scanner ‚Üí</span> to set alerts.
    </div>`;
    return;
  }
  panel.innerHTML=alerts.map(a=>`
    <div class="news-card">
      <div class="news-source">${a.ticker} <span class="news-tag ${a.triggered?'tag-breaking':'tag-macro'}">${a.triggered?'TRIGGERED':'ACTIVE'}</span></div>
      <div class="news-headline">${a.condition==='above'?`Price above $${a.threshold}`:a.condition==='below'?`Price below $${a.threshold}`:a.condition==='up5'?'Up >5% today':'Down >5% today'}</div>
      <div class="news-meta">${a.created}</div>
    </div>`).join('');
}

// SECTORS PANEL
function renderSectorsPanel(){
  const panel=document.getElementById('sectors-panel');
  const sectors=[
    {heat:'hot',emoji:'üöÄ',name:'Small Caps',tickers:'IWM ¬∑ RUT ¬∑ SCHA',note:'Rate cut expectations fueling rotation into small caps. IWM above 200MA. Strongest relative strength in months.',class:'hot'},
    {heat:'hot',emoji:'üõ°Ô∏è',name:'Defense & Aerospace',tickers:'ITA ¬∑ LMT ¬∑ RTX ¬∑ NOC',note:'Geopolitical spending supercycle. NATO countries increasing budgets. Earnings beats across the board.',class:'hot'},
    {heat:'hot',emoji:'üöÅ',name:'Drone Technology',tickers:'DRON ¬∑ UAVS ¬∑ AVAV',note:'Commercial + military drone adoption accelerating. New FAA rules favorable. Institutional money flowing in.',class:'hot'},
    {heat:'warm',emoji:'ü•á',name:'Gold & Precious Metals',tickers:'GLD ¬∑ SLV ¬∑ GDX ¬∑ GOLD',note:'Holding above key levels. Central bank buying provides floor. Geopolitical uncertainty = safe haven bid.',class:'warm'},
    {heat:'warm',emoji:'ü§ñ',name:'AI / Semiconductors',tickers:'NVDA ¬∑ AMD ¬∑ SMCI ¬∑ AVGO',note:'Secular trend intact. Data center capex growing. Pullbacks in strong names remain opportunities.',class:'warm'},
    {heat:'cold',emoji:'‚ùÑÔ∏è',name:'Crypto',tickers:'BTC ¬∑ ETH ¬∑ SOL',note:'Consolidating after rally. ETF flows mixed. Watch for re-acceleration, but not the focus right now.',class:'cold'},
    {heat:'short-bias',emoji:'üìâ',name:'Long Duration Bonds',tickers:'TLT ¬∑ TMF',note:'Higher-for-longer rates environment. Weak technical setup. Better opportunities elsewhere.',class:'short-bias'},
    {heat:'cold',emoji:'üè¶',name:'Regional Banks',tickers:'KRE ¬∑ KBE',note:'Squeezed by rate environment. CRE exposure still a concern. Underweight vs larger cap banks.',class:'cold'},
  ];
  panel.innerHTML=`
    <div style="margin-bottom:18px">
      <div style="font-family:'Playfair Display',serif;font-size:20px;color:var(--white);margin-bottom:4px">Where To Focus</div>
      <div style="font-size:9px;color:var(--muted);letter-spacing:0.1em;text-transform:uppercase">Current market environment ¬∑ Updated by AI weekly</div>
    </div>
    <div style="display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:5px;font-size:9px;color:var(--green)"><div style="width:10px;height:10px;background:var(--green);border-radius:1px"></div>Hot ‚Äî Strong focus</div>
      <div style="display:flex;align-items:center;gap:5px;font-size:9px;color:var(--yellow)"><div style="width:10px;height:10px;background:var(--yellow);border-radius:1px"></div>Warm ‚Äî Watch</div>
      <div style="display:flex;align-items:center;gap:5px;font-size:9px;color:var(--muted)"><div style="width:10px;height:10px;background:var(--muted2);border-radius:1px"></div>Cold ‚Äî Avoid</div>
      <div style="display:flex;align-items:center;gap:5px;font-size:9px;color:var(--red)"><div style="width:10px;height:10px;background:var(--red);border-radius:1px"></div>Short Bias</div>
    </div>
    <div class="sectors-grid">
      ${sectors.map((s,i)=>`
      <div class="sector-card ${s.class}" onclick="navTo('scanner');setTimeout(()=>{document.getElementById('tv-symbol-input').value='${s.tickers.split('¬∑')[0].trim()}';loadTVChart('${s.tickers.split('¬∑')[0].trim()}')},200)" style="animation-delay:${i*0.05}s">
        <div class="sc-emoji">${s.emoji}</div>
        <div class="sc-heat ${s.heat}">${s.heat==='hot'?'üî• HOT':s.heat==='warm'?'‚óé WARM':s.heat==='cold'?'‚ùÑ COLD':'‚ñº SHORT BIAS'}</div>
        <div class="sc-name">${s.name}</div>
        <div class="sc-tickers">${s.tickers}</div>
        <div class="sc-note">${s.note}</div>
      </div>`).join('')}
    </div>
    <div style="margin-top:8px;padding:14px 16px;background:var(--surface);border:1px solid var(--border);font-size:10px;color:var(--muted);line-height:1.8">
      <strong style="color:var(--blue2)">Market Summary:</strong> Rotation trade favoring small caps and value. Defense/drone sector getting institutional money. Gold as inflation hedge. Crypto consolidating ‚Äî not the current focus. AI names remain long-term holds on pullbacks.
      <span style="color:var(--blue2);cursor:pointer;margin-left:8px" onclick="navTo('ai');setTimeout(()=>{document.getElementById('chat-input').value='Update my market sector analysis with current conditions';sendChat()},300)">Ask AI to update ‚Üí</span>
    </div>`;
}

// MARKET PULSE (key indices live)
const PULSE_TICKERS=['SPY','QQQ','IWM','GLD','BTC-USD'];
async function fetchMarketPulse(){
  const pulse=document.getElementById('market-pulse');
  // Stocks
  await Promise.allSettled(PULSE_TICKERS.map(async sym=>{
    let price=0,changePct=0;
    try{
      if(sym==='BTC-USD'){
        const r=await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true',{signal:AbortSignal.timeout(8000)});
        const j=await r.json();price=j.bitcoin?.usd||0;changePct=j.bitcoin?.usd_24h_change||0;
      }else{
        const c=await fetchStockPrice(sym);
        if(c){price=c.price;changePct=c.changePct;}
      }
    }catch(e){}
    if(!price)return;
    const up=changePct>=0;
    const cell=document.createElement('div');
    cell.className='mp-cell';
    cell.innerHTML=`<div class="mp-sym">${sym==='BTC-USD'?'BTC':sym}</div><div class="mp-price">$${f2(price)}</div><div class="mp-chg ${up?'pos':'neg'}">${up?'‚ñ≤':'‚ñº'}${Math.abs(changePct).toFixed(2)}%</div>`;
    cell.onclick=()=>{navTo('scanner');setTimeout(()=>{document.getElementById('tv-symbol-input').value=sym==='BTC-USD'?'BTCUSD':sym;loadTVChart(sym==='BTC-USD'?'BTCUSD':sym)},200);};
    pulse.appendChild(cell);
  }));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// AI ADVISOR ‚Äî persistent memory via localStorage
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let chatHistory=[];
let aiInited=false;

async function initAIAdvisor(){
  await loadChatMemory();
  if(!aiInited){
    aiInited=true;
    if(chatHistory.length===0){
      // First-time greeting
      appendChatMsg('ai',`Good ${new Date().getHours()<12?'morning':new Date().getHours()<17?'afternoon':'evening'}, Bruno. I'm your Funded Trust AI advisor with persistent memory ‚Äî I'll remember our conversations across sessions.<br><br>I have full context of your portfolio. You can ask me about:<br><div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px">
        <span onclick="chatSuggest('What are the best long setups right now given current market conditions?')" style="background:var(--bg);border:1px solid var(--border);color:var(--muted);font-size:9px;padding:4px 10px;cursor:pointer;transition:all 0.2s;border-radius:0" onmouseover="this.style.borderColor='var(--blue3)';this.style.color='var(--blue2)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--muted)'">Long ideas ‚Üí</span>
        <span onclick="chatSuggest('Analyze my overall portfolio allocation and suggest improvements')" style="background:var(--bg);border:1px solid var(--border);color:var(--muted);font-size:9px;padding:4px 10px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='var(--blue3)';this.style.color='var(--blue2)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--muted)'">Portfolio review ‚Üí</span>
        <span onclick="chatSuggest('What sectors should I be focused on right now for the best opportunities?')" style="background:var(--bg);border:1px solid var(--border);color:var(--muted);font-size:9px;padding:4px 10px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='var(--blue3)';this.style.color='var(--blue2)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--muted)'">Sector focus ‚Üí</span>
        <span onclick="chatSuggest('What short setups look attractive right now?')" style="background:var(--bg);border:1px solid var(--border);color:var(--muted);font-size:9px;padding:4px 10px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='var(--blue3)';this.style.color='var(--blue2)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--muted)'">Short ideas ‚Üí</span>
      </div>`);
    }
    updateMemoryBar();
  }
  scrollChat();
}

async function loadChatMemory(){
  // Try localStorage first for instant render
  try {
    const local = localStorage.getItem('ft3_chat');
    if (local) {
      const d = JSON.parse(local);
      chatHistory = d.history || [];
      reRenderChat();
    }
  } catch(e) { chatHistory = []; }

  // Fetch from Supabase (authoritative)
  const remote = await sbGet('chat_memory');
  if (remote && remote.history) {
    chatHistory = remote.history;
    localStorage.setItem('ft3_chat', JSON.stringify({history: chatHistory}));
    reRenderChat();
  }
}

function reRenderChat() {
  const msgs = document.getElementById('chat-messages');
  if (!msgs || chatHistory.length === 0) return;
  msgs.innerHTML = '';
  chatHistory.forEach(m => {
    if (m.role === 'user' || m.role === 'assistant')
      appendChatMsg(m.role === 'user' ? 'user' : 'ai', formatChatReply(m.content));
  });
  scrollChat();
}

async function saveChatMemory(){
  const trimmed = chatHistory.slice(-40);
  chatHistory = trimmed;
  const data = {history: trimmed, updated: Date.now()};
  localStorage.setItem('ft3_chat', JSON.stringify(data));
  await sbSet('chat_memory', data);
  updateMemoryBar();
}

function updateMemoryBar(){
  const bar=document.getElementById('memory-bar');
  const summary=document.getElementById('memory-summary');
  if(!bar||!summary)return;
  const msgCount=chatHistory.filter(m=>m.role!=='system').length;
  if(msgCount>0){
    bar.style.display='';
    summary.textContent=`${msgCount} messages across ${Math.ceil(msgCount/2)} conversations stored`;
  }else{
    bar.style.display='none';
  }
}

function clearChatMemory(){
  if(!confirm('Clear all chat history and memory?'))return;
  chatHistory=[];
  localStorage.removeItem('ft3_chat');
  const msgs=document.getElementById('chat-messages');
  if(msgs)msgs.innerHTML='';
  aiInited=false;
  initAIAdvisor();
  toast('Chat memory cleared.');
}

function chatSuggest(msg){
  const input=document.getElementById('chat-input');
  if(input){input.value=msg;sendChat();}
}

function autoResize(el){
  el.style.height='auto';
  el.style.height=Math.min(el.scrollHeight,120)+'px';
}

async function sendChat(){
  const input=document.getElementById('chat-input');
  const msg=input.value.trim();
  if(!msg)return;
  input.value='';input.style.height='auto';

  appendChatMsg('user',msg);
  chatHistory.push({role:'user',content:msg});

  const typingId='typing-'+Date.now();
  appendChatMsg('ai','<div class="chat-typing"><span></span><span></span><span></span></div>',typingId);
  scrollChat();

  const portfolioCtx=buildPortfolioContext();

  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1000,
        system:`You are Bruno's personal AI financial advisor inside Funded Trust, a private portfolio management platform. Today is ${new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}.

Be concise, direct, and confident. Give specific tickers and actionable ideas. No disclaimers. Format cleanly with bold, bullets where useful. You have persistent memory of past conversations.

Current portfolio context:
${portfolioCtx}

Current market focus: Small caps (IWM) hot, Defense/Drones hot, Gold/Silver warm, AI/Semis warm, Crypto consolidating, Long bonds bearish.`,
        messages:chatHistory.slice(-20).filter(m=>m.role==='user'||m.role==='assistant')
      })
    });
    const data=await res.json();
    const reply=data.content?.[0]?.text||'Unable to get a response. Check your connection.';
    document.getElementById(typingId)?.remove();
    appendChatMsg('ai',formatChatReply(reply));
    chatHistory.push({role:'assistant',content:reply});
    saveChatMemory();
  }catch(e){
    document.getElementById(typingId)?.remove();
    appendChatMsg('ai','Connection error. The AI API could not be reached. Check your network.');
  }
  scrollChat();
}

function buildPortfolioContext(){
  const props=S.properties||[];
  const holdings=S.holdings||[];
  const cryptos=S.cryptos||[];
  const cash=S.cashAccounts||[];
  const totalRE=props.reduce((s,p)=>s+(+p.value||0),0);
  const totalDebt=props.reduce((s,p)=>s+(+p.debt||0),0);
  const cashTotal=cash.reduce((s,a)=>s+(+a.balance||0),0);
  let ctx=`Real Estate: ${props.length} properties, value ~$${f2(totalRE)}, debt $${f2(totalDebt)}, equity $${f2(totalRE-totalDebt)}.`;
  if(holdings.length)ctx+=` Stocks/Retirement: ${holdings.map(h=>`${h.ticker}(${h.shares}sh @ $${h.costBasis})`).join(', ')}.`;
  if(cryptos.length)ctx+=` Crypto: ${cryptos.map(c=>`${c.name} ${c.amount} @ $${c.costBasis}`).join(', ')}.`;
  if(cashTotal>0)ctx+=` Cash: $${f2(cashTotal)}.`;
  return ctx||'No portfolio data entered yet.';
}

function formatChatReply(text){
  return text
    .replace(/\*\*(.*?)\*\*/g,'<strong style="color:var(--blue2)">$1</strong>')
    .replace(/\*(.*?)\*/g,'<em>$1</em>')
    .replace(/^### (.*)/gm,'<div style="font-family:\'Playfair Display\',serif;font-size:13px;color:var(--white);margin:10px 0 5px">$1</div>')
    .replace(/^## (.*)/gm,'<div style="font-family:\'Playfair Display\',serif;font-size:14px;color:var(--white);margin:12px 0 6px">$1</div>')
    .replace(/^- (.*)/gm,'<div style="display:flex;gap:6px;margin:3px 0"><span style="color:var(--blue3);flex-shrink:0">¬∑</span><span>$1</span></div>')
    .replace(/^(\d+)\. (.*)/gm,'<div style="display:flex;gap:6px;margin:3px 0"><span style="color:var(--blue3);min-width:14px;flex-shrink:0">$1.</span><span>$2</span></div>')
    .replace(/\n\n/g,'<br><br>')
    .replace(/\n/g,'<br>');
}

function appendChatMsg(role,content,id=''){
  const msgs=document.getElementById('chat-messages');
  if(!msgs)return;
  const div=document.createElement('div');
  div.className=`chat-msg ${role}`;
  if(id)div.id=id;
  div.innerHTML=`<div class="msg-avatar">${role==='user'?'B':'AI'}</div><div class="msg-bubble">${content}</div>`;
  msgs.appendChild(div);
  scrollChat();
}

function scrollChat(){
  const msgs=document.getElementById('chat-messages');
  if(msgs)msgs.scrollTop=msgs.scrollHeight;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SCANNER ‚Äî 2-of-3 Signal Engine
// Rebuilds PineScript logic in JS:
// 1. RSI Bias (fast RSI EMA vs slow RSI SMA)
// 2. Wick Trend (rolling high/low flip)
// 3. EMA Bias (price vs EMA50 & EMA100)
// Signal = LONG/SHORT when 2+ agree
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let scanMode = 'crypto';
let activeSector = 'tech';
let scanResults = [];
let scanFilter = 'all';
let selectedScanTicker = '';
let scanAlerts = [];

// Stablecoins to exclude from crypto scan
const STABLECOINS = new Set(['tether','usd-coin','binance-usd','dai','frax','true-usd','pax-dollar','gemini-dollar','liquity-usd','fei-usd','neutrino-usd','terra-usd','usdd','celo-dollar','usdt','usdc','busd','tusd','usdp','usdn','cusd','ust']);

// Sector stock universes
const SECTORS = {
  tech:        {label:'Tech / AI',    tickers:['NVDA','MSFT','AAPL','GOOGL','META','AMD','AVGO','SMCI','PLTR','SNOW','CRM','TSLA','AMZN','ORCL','IBM','INTC','MU','QCOM','AMAT','LRCX']},
  defense:     {label:'Defense',      tickers:['LMT','RTX','NOC','GD','BA','L3H','LDOS','CACI','BAH','SAIC','HII','TXT','KTOS','HRMY','DRS']},
  commodities: {label:'Commodities',  tickers:['GLD','SLV','GDX','GDXJ','IAU','GOLD','NEM','AEM','WPM','RGLD','FCX','CLF','AA','X','MT','MP','XOM','CVX','COP','OXY']},
  smallcap:    {label:'Small Caps',   tickers:['IWM','SCHA','IJR','VBR','AVUV','CLOV','SOFI','OPEN','RIDE','NKLA','SPCE','JOBY','ARCHER','ACHR','BLDE','ASTS','LUNR','RDW','MNTS']},
  drones:      {label:'Drones/Space', tickers:['AVAV','KTOS','JOBY','ACHR','BLDE','EH','AMBA','SWBI','AXON','RCAT','DRON','UAVS','AIR','LHX','ATRO']},
};

function setScanMode(mode) {
  scanMode = mode;
  ['crypto','sectors'].forEach(m => {
    document.getElementById('smode-'+m)?.classList.toggle('active', m === mode);
  });
  const pills = document.getElementById('sector-pills');
  if (pills) pills.style.display = mode === 'sectors' ? '' : 'none';
  // Reset results
  document.getElementById('scan-results-list').innerHTML = '<div style="padding:24px 16px;text-align:center;color:var(--muted);font-size:10px;line-height:2.2"><div style="font-size:24px;opacity:0.2;margin-bottom:8px">‚óâ</div>Click ‚ñ∂ RUN SCANNER<br>to analyze assets</div>';
  document.getElementById('scan-count-bar').textContent = '‚Äî';
}

function selectSector(sector) {
  activeSector = sector;
  Object.keys(SECTORS).forEach(s => {
    document.getElementById('sp-'+s)?.classList.toggle('active', s === sector);
  });
}

function filterScanResults(f) {
  scanFilter = f;
  ['all','long','short','neutral'].forEach(x => {
    document.getElementById('sfb-'+x)?.classList.toggle('active', x === f);
  });
  renderScanList();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SIGNAL ENGINE ‚Äî exact JS port of PineScript "2 of 3"
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Wilder RMA (Running Moving Average) ‚Äî matches ta.rma()
function calcRMA(arr, period) {
  if (arr.length < period) return arr.reduce((a,b)=>a+b,0)/arr.length;
  let rma = arr.slice(0, period).reduce((a,b)=>a+b,0) / period;
  for (let i = period; i < arr.length; i++) {
    rma = (rma * (period - 1) + arr[i]) / period;
  }
  return rma;
}

// RSI using Wilder RMA ‚Äî matches ta.rsi() exactly
function calcRSI(closes, period) {
  if (closes.length < period + 1) return 50;
  const changes = [];
  for (let i = 1; i < closes.length; i++) changes.push(closes[i] - closes[i-1]);
  const gains  = changes.map(c => Math.max(c, 0));
  const losses = changes.map(c => Math.max(-c, 0));
  const avgGain = calcRMA(gains, period);
  const avgLoss = calcRMA(losses, period);
  if (avgLoss === 0) return 100;
  if (avgGain === 0) return 0;
  return 100 - (100 / (1 + avgGain / avgLoss));
}

// RSI series ‚Äî compute RSI for every bar position
function calcRSISeries(closes, period) {
  const out = new Array(closes.length).fill(50);
  if (closes.length < period + 1) return out;
  // Build change arrays
  const changes = [0];
  for (let i = 1; i < closes.length; i++) changes.push(closes[i] - closes[i-1]);
  // Seed first RMA
  let avgGain = 0, avgLoss = 0;
  for (let i = 1; i <= period; i++) {
    avgGain += Math.max(changes[i], 0);
    avgLoss += Math.max(-changes[i], 0);
  }
  avgGain /= period; avgLoss /= period;
  out[period] = avgLoss === 0 ? 100 : avgGain === 0 ? 0 : 100 - (100/(1+avgGain/avgLoss));
  for (let i = period + 1; i < closes.length; i++) {
    avgGain = (avgGain * (period-1) + Math.max(changes[i], 0)) / period;
    avgLoss = (avgLoss * (period-1) + Math.max(-changes[i], 0)) / period;
    out[i] = avgLoss === 0 ? 100 : avgGain === 0 ? 0 : 100 - (100/(1+avgGain/avgLoss));
  }
  return out;
}

// EMA series
function calcEMASeries(arr, period) {
  const out = new Array(arr.length).fill(0);
  const k = 2 / (period + 1);
  let ema = arr.slice(0, period).reduce((a,b)=>a+b,0) / period;
  out[period-1] = ema;
  for (let i = period; i < arr.length; i++) {
    ema = arr[i]*k + ema*(1-k);
    out[i] = ema;
  }
  return out;
}

// SMA series
function calcSMASeries(arr, period) {
  const out = new Array(arr.length).fill(0);
  for (let i = period-1; i < arr.length; i++) {
    out[i] = arr.slice(i-period+1, i+1).reduce((a,b)=>a+b,0) / period;
  }
  return out;
}

// Single EMA scalar
function calcEMA(arr, period) {
  if (!arr.length) return 0;
  if (arr.length < period) return arr[arr.length-1];
  const k = 2/(period+1);
  let ema = arr.slice(0, period).reduce((a,b)=>a+b,0)/period;
  for (let i = period; i < arr.length; i++) ema = arr[i]*k + ema*(1-k);
  return ema;
}

function calcSMA(arr, period) {
  if (!arr.length) return 0;
  if (arr.length < period) return arr.reduce((a,b)=>a+b,0)/arr.length;
  return arr.slice(-period).reduce((a,b)=>a+b,0)/period;
}

// ‚îÄ‚îÄ MAIN SIGNAL COMPUTE ‚Äî exact PineScript port ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Returns current bar state + whether a SIGNAL just fired
function compute2of3(ohlc) {
  if (!ohlc || ohlc.length < 40) {
    return {signal:'neutral', barState:0, barFlipToGreen:false, barFlipToRed:false,
            bull:0, bear:0, rsi:50, rsiBias:'neutral', wickBias:'neutral', emaBias:'neutral',
            momentum:0, allThreeBull:false, allThreeBear:false};
  }

  const closes = ohlc.map(b => b.c);
  const highs  = ohlc.map(b => b.h);
  const lows   = ohlc.map(b => b.l);
  const opens  = ohlc.map(b => b.o);
  const n = closes.length;

  // ‚îÄ‚îÄ 1. RSI + MOMENTUM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // fast RSI(14), slow RSI(20), smooth = EMA(fastRSI, 3), sig = SMA(slowRSI, 14)
  const fastPeriod=14, slowPeriod=20, emaSm=3, sigLen=14, momLen=14;

  const fastRSIs = calcRSISeries(closes, fastPeriod);
  const slowRSIs = calcRSISeries(closes, slowPeriod);
  const smooth1s = calcEMASeries(fastRSIs, emaSm);   // EMA(rsi1, 3)
  const sigs     = calcSMASeries(slowRSIs, sigLen);  // SMA(rsi2, 14)

  const smooth1_cur = smooth1s[n-1];
  const sig_cur     = sigs[n-1];

  // Momentum = close - close[14]
  const mom_cur  = n > momLen ? closes[n-1] - closes[n-1-momLen] : 0;
  const mom_prev = n > momLen+1 ? closes[n-2] - closes[n-2-momLen] : 0;

  // Momentum cross zero
  const mom_up_cross   = mom_prev <= 0 && mom_cur > 0;
  const mom_down_cross = mom_prev >= 0 && mom_cur < 0;

  const rsi_bias_bull = smooth1_cur > sig_cur;
  const rsi_bias_bear = smooth1_cur < sig_cur;

  // RSI value (Wilder RMA method matching table display)
  const rsiVal = fastRSIs[n-1];

  // ‚îÄ‚îÄ 2. WICK TREND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Exact port of PineScript stateful loop
  let wickTrend = closes[0] > opens[0] ? 1 : -1;
  let wickHigh  = highs[0];
  let wickLow   = lows[0];
  let prevWickTrend = wickTrend;

  for (let i = 1; i < n; i++) {
    prevWickTrend = wickTrend;
    if (wickTrend === 1) {
      if (closes[i] < wickLow) {
        wickTrend = -1; wickHigh = highs[i]; wickLow = lows[i];
      } else if (closes[i] > wickHigh) {
        wickLow = lows[i]; wickHigh = highs[i];
      }
    } else { // wickTrend === -1
      if (closes[i] < wickLow) {
        wickHigh = highs[i]; wickLow = lows[i];
      } else if (closes[i] > wickHigh) {
        wickTrend = 1; wickLow = lows[i]; wickHigh = highs[i];
      }
    }
  }

  const wick_bias_bull = wickTrend === 1;
  const wick_bias_bear = wickTrend === -1;
  const wick_buy_signal  = wickTrend !== prevWickTrend && wickTrend === 1;
  const wick_sell_signal = wickTrend !== prevWickTrend && wickTrend === -1;

  // ‚îÄ‚îÄ 3. EMA BIAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // CoinGecko daily OHLC gives ~90 bars. PineScript uses 5-min EMAs but we
  // approximate with daily. Need 100+ bars for EMA100 so fetch 180 days in scan.
  const lastClose = closes[n-1];
  let ema50 = lastClose, ema100 = lastClose;
  let ema_bull_bias = false, ema_bear_bias = false;
  let ema_bull_bias_prev = false, ema_bear_bias_prev = false;

  if (n >= 100) {
    ema50  = calcEMA(closes, 50);
    ema100 = calcEMA(closes, 100);
    const cp = closes.slice(0, -1);
    const e50p = calcEMA(cp, 50);
    const e100p = cp.length >= 100 ? calcEMA(cp, 100) : ema100;
    const lcp = cp[cp.length - 1];

    const priceAboveBoth = lastClose > ema50 && lastClose > ema100;
    const priceBelowBoth = lastClose < ema50 && lastClose < ema100;
    ema_bull_bias = priceAboveBoth && ema50 > ema100;
    ema_bear_bias = priceBelowBoth && ema50 < ema100;
    ema_bull_bias_prev = lcp > e50p && lcp > e100p && e50p > e100p;
    ema_bear_bias_prev = lcp < e50p && lcp < e100p && e50p < e100p;
  } else if (n >= 50) {
    // Only EMA50 available as rough proxy
    ema50  = calcEMA(closes, 50);
    ema100 = ema50;
    ema_bull_bias = lastClose > ema50;
    ema_bear_bias = lastClose < ema50;
  }
  // else: not enough data, EMA stays neutral (no contribution to 2/3 count)

  const ema_buy_signal  = ema_bull_bias && !ema_bull_bias_prev;
  const ema_sell_signal = ema_bear_bias && !ema_bear_bias_prev;

  // ‚îÄ‚îÄ 4. 2-OF-3 ALIGNMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // RSI and Wick always vote (they're always bull or bear)
  // EMA only votes when it has a clear bias ‚Äî neutral EMA is abstained
  let bull_count = 0, bear_count = 0;
  if (rsi_bias_bull) bull_count++; else bear_count++;   // RSI always votes
  if (wick_bias_bull) bull_count++; else bear_count++;  // Wick always votes
  if (ema_bull_bias) bull_count++;                      // EMA votes bull
  else if (ema_bear_bias) bear_count++;                 // EMA votes bear
  // EMA neutral = abstain (matches PineScript where EMA bias can be neither)

  const two_of_three_bull = bull_count >= 2;
  const two_of_three_bear = bear_count >= 2;
  const all_three_bull    = bull_count === 3;
  const all_three_bear    = bear_count === 3;

  // Check previous bar alignment for flip detection
  // Re-run for n-2 (prev bar) to detect transitions
  let prevBull = 0, prevBear = 0;
  if (n >= 2) {
    const smooth1_prev = smooth1s[n-2] || smooth1_cur;
    const sig_prev     = sigs[n-2] || sig_cur;
    if (smooth1_prev > sig_prev) prevBull++; else prevBear++;
    if (wick_bias_bull) prevBull++; else prevBear++; // wick trend same (flipped at bar n-1)
    if (ema_bull_bias_prev) prevBull++;
    else if (ema_bear_bias_prev) prevBear++;
  }
  const prev_two_bull = prevBull >= 2;
  const prev_two_bear = prevBear >= 2;

  const two_of_three_buy_signal  = two_of_three_bull && !prev_two_bull;
  const two_of_three_sell_signal = two_of_three_bear && !prev_two_bear;

  // ‚îÄ‚îÄ 5. BAR STATE (for coloring + flip alerts) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Using "2 of 3 Alignment" color mode (default in your script)
  let barState = 0;
  if (two_of_three_bull) barState = 1;
  else if (two_of_three_bear) barState = -1;

  // Flip signals ‚Äî the primary alert triggers
  const barFlipToGreen = barState === 1  && !prev_two_bull;
  const barFlipToRed   = barState === -1 && !prev_two_bear;

  // Final signal for display
  let signal = 'neutral';
  if (barFlipToGreen || two_of_three_buy_signal) signal = 'long';
  else if (barFlipToRed || two_of_three_sell_signal) signal = 'short';
  else if (two_of_three_bull) signal = 'long_hold';  // green but no new signal
  else if (two_of_three_bear) signal = 'short_hold'; // red but no new signal

  return {
    signal, barState, barFlipToGreen, barFlipToRed,
    bull: bull_count, bear: bear_count,
    rsi: Math.round(rsiVal * 10) / 10,
    momentum: mom_cur,
    rsiBias: rsi_bias_bull ? 'bull' : 'bear',
    wickBias: wick_bias_bull ? 'bull' : 'bear',
    emaBias: ema_bull_bias ? 'bull' : ema_bear_bias ? 'bear' : 'neutral',
    allThreeBull: all_three_bull,
    allThreeBear: all_three_bear,
    ema50, ema100, lastClose,
    wickHigh, wickLow,
    twoOfThreeBull: two_of_three_bull,
    twoOfThreeBear: two_of_three_bear,
  };
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DATA ‚Äî Netlify serverless functions proxy Binance
// No CORS, no geo-block, runs server-side
// /.netlify/functions/prices  ‚Üí top coins by volume with live prices
// /.netlify/functions/klines  ‚Üí OHLC candles for chart + signals
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const STABLES = new Set(['USDT','USDC','BUSD','DAI','TUSD','USDP','USDD','USDE','FDUSD','PYUSD','SUSD','FRAX','LUSD','GUSD','USDJ','TRIBE']);

// Fetch top coins by volume from Binance via Netlify function
async function fetchTop150Coins() {
  setScanStatus('Fetching top coins via Binance‚Ä¶');
  try {
    const r = await fetch('/.netlify/functions/prices', {signal: AbortSignal.timeout(15000)});
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const coins = await r.json();
    if (!Array.isArray(coins) || !coins.length) throw new Error('Empty response');
    const filtered = coins.filter(c => !STABLES.has(c.symbol));
    setScanStatus(`Got ${filtered.length} coins ‚Äî scanning‚Ä¶`);
    return filtered;
  } catch(e) {
    setScanStatus('Using cached coin list (' + e.message + ')');
    // Fallback hardcoded list
    return [
      {symbol:'BTC',price:0,change24h:0},{symbol:'ETH',price:0,change24h:0},
      {symbol:'SOL',price:0,change24h:0},{symbol:'BNB',price:0,change24h:0},
      {symbol:'XRP',price:0,change24h:0},{symbol:'DOGE',price:0,change24h:0},
      {symbol:'ADA',price:0,change24h:0},{symbol:'AVAX',price:0,change24h:0},
      {symbol:'HYPE',price:0,change24h:0},{symbol:'LINK',price:0,change24h:0},
      {symbol:'SUI',price:0,change24h:0},{symbol:'TON',price:0,change24h:0},
      {symbol:'SHIB',price:0,change24h:0},{symbol:'PEPE',price:0,change24h:0},
      {symbol:'WIF',price:0,change24h:0},{symbol:'BONK',price:0,change24h:0},
      {symbol:'NEAR',price:0,change24h:0},{symbol:'APT',price:0,change24h:0},
      {symbol:'INJ',price:0,change24h:0},{symbol:'ARB',price:0,change24h:0},
    ];
  }
}

// Fetch OHLC candles via Netlify function ‚Üí Binance klines
// Returns real OHLC with true high/low ‚Äî critical for wick trend accuracy
async function fetchCoinOHLC(symbol, days=365) {
  try {
    const sym = (symbol + 'USDT').toUpperCase().replace('USDTUSDT','USDT');
    // Map days to Binance interval + limit
    // Daily candles: 1d interval, limit=days
    const url = `/.netlify/functions/klines?symbol=${sym}&interval=1d&limit=${Math.min(days, 500)}`;
    const r = await fetch(url, {signal: AbortSignal.timeout(15000)});
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const data = await r.json();
    if (!Array.isArray(data) || data.length < 10) return null;
    return data.map(d => ({
      time:  Math.floor(d[0] / 1000),
      open:  parseFloat(d[1]),
      high:  parseFloat(d[2]),
      low:   parseFloat(d[3]),
      close: parseFloat(d[4]),
    }));
  } catch(e) { return null; }
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCANNER ‚Äî CRYPTO SCAN + SECTOR SCAN
// Data: Netlify functions ‚Üí Binance (server-side, no geo-block)
// Signal: 2-of-3 alignment (RSI bias + Wick Trend + EMA Bias)
// Chart: Lightweight Charts with per-bar coloring + indicators
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function runCryptoScan() {
  const coins = await fetchTop150Coins();
  if (!coins || !coins.length) { setScanStatus('Failed to fetch coins.'); return; }

  setScanStatus(`Scanning ${coins.length} coins‚Ä¶`);
  const results = [];
  let done = 0;
  const order = {long:0, short:1, long_hold:2, short_hold:3, neutral:4};

  for (const coin of coins) {
    done++;
    const sym = (coin.symbol || '').toUpperCase();
    if (!sym) continue;
    setScanStatus(`${done}/${coins.length} ‚Äî ${sym}`);
    try {
      const candles = await fetchCoinOHLC(sym, 365);
      let sig;
      const chg = coin.change24h || 0;

      if (!candles || candles.length < 30) {
        // Fallback: use 24h change as rough directional signal
        const st = chg > 3 ? 1 : chg < -3 ? -1 : 0;
        sig = { signal: st===1?'long_hold':st===-1?'short_hold':'neutral',
                barState:st, barFlipToGreen:false, barFlipToRed:false,
                bull:st===1?2:0, bear:st===-1?2:0, rsi:null,
                rsiBias:chg>0?'bull':'bear', wickBias:chg>0?'bull':'bear',
                emaBias:'neutral', allThreeBull:false, allThreeBear:false,
                twoOfThreeBull:st===1, twoOfThreeBear:st===-1, wickHigh:0, wickLow:0 };
      } else {
        const ohlc = candles.map(c=>({o:c.open, h:c.high, l:c.low, c:c.close}));
        sig = compute2of3(ohlc);
      }

      results.push({
        id: sym, name: coin.name || sym,
        symbol: sym, tvSymbol: sym,
        price: coin.price || 0, change24h: chg,
        signal: sig.signal, barState: sig.barState,
        barFlipToGreen: sig.barFlipToGreen, barFlipToRed: sig.barFlipToRed,
        bull: sig.bull, bear: sig.bear, rsi: sig.rsi,
        rsiBias: sig.rsiBias, wickBias: sig.wickBias, emaBias: sig.emaBias,
        allThreeBull: sig.allThreeBull, allThreeBear: sig.allThreeBear,
      });

      if (done % 8 === 0) {
        scanResults = [...results].sort((a,b)=>(order[a.signal]??4)-(order[b.signal]??4));
        renderScanList();
      }
    } catch(e) { /* skip coin */ }
    await new Promise(res => setTimeout(res, 80)); // Binance is generous
  }

  scanResults = results.sort((a,b)=>(order[a.signal]??4)-(order[b.signal]??4));
  checkAlerts(scanResults);
  const nL = results.filter(r=>r.signal==='long').length;
  const nS = results.filter(r=>r.signal==='short').length;
  const hL = results.filter(r=>r.signal==='long_hold').length;
  const hS = results.filter(r=>r.signal==='short_hold').length;
  setScanStatus(`‚úì ${nL} NEW LONG ¬∑ ${hL} bull ¬∑ ${nS} NEW SHORT ¬∑ ${hS} bear ¬∑ ${results.length} scanned`);
  renderScanList();
  const first = scanResults.find(r=>r.signal==='long'||r.signal==='long_hold');
  if (first) selectScanItem(first.tvSymbol, first.name, first.signal);
}

async function runSectorScan() {
  const sector = activeSector || 'tech';
  const tickers = SECTORS[sector]?.tickers || [];
  if (!tickers.length) return;
  setScanStatus(`Scanning ${tickers.length} stocks‚Ä¶`);
  const results = [];
  const order = {long:0, short:1, long_hold:2, short_hold:3, neutral:4};

  for (const ticker of tickers) {
    setScanStatus(`Scanning ${ticker}‚Ä¶`);
    try {
      // Use yfinance-style endpoint via Netlify function
      const candles = await fetchStockOHLC(ticker, 365);
      let sig;
      if (!candles || candles.length < 30) {
        sig = { signal:'neutral', barState:0, barFlipToGreen:false, barFlipToRed:false,
                bull:1, bear:1, rsi:50, rsiBias:'neutral', wickBias:'neutral',
                emaBias:'neutral', allThreeBull:false, allThreeBear:false,
                twoOfThreeBull:false, twoOfThreeBear:false };
      } else {
        const ohlc = candles.map(c=>({o:c.open,h:c.high,l:c.low,c:c.close}));
        sig = compute2of3(ohlc);
      }
      const priceData = candles?.length ? candles[candles.length-1] : null;
      const price = priceData?.close || 0;
      results.push({
        id:ticker, name:ticker, symbol:ticker, tvSymbol:ticker,
        price, change24h:0,
        signal:sig.signal, barState:sig.barState,
        barFlipToGreen:sig.barFlipToGreen, barFlipToRed:sig.barFlipToRed,
        bull:sig.bull, bear:sig.bear, rsi:sig.rsi,
        rsiBias:sig.rsiBias, wickBias:sig.wickBias, emaBias:sig.emaBias,
        allThreeBull:sig.allThreeBull, allThreeBear:sig.allThreeBear,
      });
    } catch(e) {}
    await new Promise(res => setTimeout(res, 200));
  }

  scanResults = results.sort((a,b)=>(order[a.signal]??4)-(order[b.signal]??4));
  setScanStatus(`‚úì ${results.length} stocks scanned`);
  renderScanList();
  const first = scanResults.find(r=>r.signal==='long'||r.signal==='long_hold');
  if (first) selectScanItem(first.tvSymbol, first.name, first.signal);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STOCK OHLC via Netlify function
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchStockOHLC(ticker, days=365) {
  try {
    const url = `/.netlify/functions/klines?symbol=${ticker}&interval=1d&limit=${days}&market=stock`;
    const r = await fetch(url, {signal: AbortSignal.timeout(15000)});
    if (!r.ok) return null;
    const data = await r.json();
    if (!Array.isArray(data) || data.length < 10) return null;
    return data.map(d=>({time:Math.floor(d[0]/1000),open:parseFloat(d[1]),high:parseFloat(d[2]),low:parseFloat(d[3]),close:parseFloat(d[4])}));
  } catch(e) { return null; }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// RENDER SCAN LIST
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderScanList() {
  const list = document.getElementById('scan-results-list');
  if (!list) return;

  const filtered = scanResults.filter(r => {
    if (scanFilter==='all') return true;
    if (scanFilter==='long')    return r.signal==='long'||r.signal==='long_hold';
    if (scanFilter==='short')   return r.signal==='short'||r.signal==='short_hold';
    if (scanFilter==='neutral') return r.signal==='neutral';
    return true;
  });

  const cb = document.getElementById('scan-count-bar');
  const nL=scanResults.filter(r=>r.signal==='long').length;
  const hL=scanResults.filter(r=>r.signal==='long_hold').length;
  const nS=scanResults.filter(r=>r.signal==='short').length;
  const hS=scanResults.filter(r=>r.signal==='short_hold').length;
  const neu=scanResults.filter(r=>r.signal==='neutral').length;
  if (cb) cb.innerHTML=`<span class="pos">üü¢ ${nL} new ¬∑ ${hL} bull</span> &nbsp;<span class="neg">üî¥ ${nS} new ¬∑ ${hS} bear</span> &nbsp;<span style="color:var(--muted)">${neu} neutral</span>`;

  if (!filtered.length) {
    list.innerHTML='<div style="padding:16px;text-align:center;color:var(--muted);font-size:10px">No results</div>';
    return;
  }

  list.innerHTML = filtered.map(r => {
    const isNewLong   = r.signal==='long';
    const isNewShort  = r.signal==='short';
    const isHoldLong  = r.signal==='long_hold';
    const isHoldShort = r.signal==='short_hold';
    const up = r.change24h >= 0;

    const barColor = isNewLong||isHoldLong ? '#00cc44'
                   : isNewShort||isHoldShort ? '#ff3333' : '#444';

    let sigLabel, sigClass;
    if (isNewLong)    { sigLabel='üî∫ NEW LONG';  sigClass='sig-long'; }
    else if (isNewShort)  { sigLabel='üîª NEW SHORT'; sigClass='sig-short'; }
    else if (isHoldLong)  { sigLabel='‚ñ≤ BULLISH';    sigClass='sig-long'; }
    else if (isHoldShort) { sigLabel='‚ñº BEARISH';    sigClass='sig-short'; }
    else                  { sigLabel='‚óè NEUTRAL';    sigClass='sig-neutral'; }

    const dots = [
      `<div class="sdot ${r.rsiBias==='bull'?'bull':'bear'}" title="RSI Bias"></div>`,
      `<div class="sdot ${r.wickBias==='bull'?'bull':'bear'}" title="Wick Trend"></div>`,
      `<div class="sdot ${r.emaBias==='bull'?'bull':r.emaBias==='bear'?'bear':'off'}" title="EMA Bias"></div>`,
    ].join('');

    const p = r.price;
    const priceStr = !p ? '‚Äî' : p >= 1 ? '$'+p.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})
                  : p >= 0.0001 ? '$'+p.toFixed(6) : '$'+p.toExponential(3);

    const sel = r.tvSymbol===selectedScanTicker ? 'selected' : '';
    return `<div class="scan-item ${sel}" onclick="selectScanItem('${r.tvSymbol}','${(r.name||r.symbol).replace(/'/g,'')}','${r.signal}')" id="si-${r.tvSymbol}">
      <div style="width:4px;flex-shrink:0;border-radius:2px;align-self:stretch;background:${barColor}"></div>
      <div style="flex:1;min-width:0;padding:8px 0 8px 8px">
        <div style="display:flex;align-items:center;gap:5px;margin-bottom:1px">
          <span class="scan-item-ticker">${r.symbol}</span>
          <span class="sig-badge ${sigClass}">${sigLabel}</span>
        </div>
        <div class="scan-item-name">${r.name||r.symbol}</div>
        <div style="display:flex;align-items:center;gap:6px;margin-top:3px">
          <div class="score-dots">${dots}</div>
          <span style="font-size:8px;color:var(--muted2)">${r.bull}üêÇ${r.bear}üêª</span>
          ${r.rsi!=null?`<span style="font-size:8px;color:var(--muted2)">RSI ${r.rsi}</span>`:''}
        </div>
      </div>
      <div class="scan-item-right">
        <div class="scan-item-price">${priceStr}</div>
        <div class="scan-item-chg ${up?'pos':'neg'}">${up?'‚ñ≤':'‚ñº'}${Math.abs(r.change24h||0).toFixed(2)}%</div>
      </div>
    </div>`;
  }).join('');
}

function selectScanItem(tvSymbol, name, signal) {
  selectedScanTicker = tvSymbol;
  document.querySelectorAll('.scan-item').forEach(el=>el.classList.remove('selected'));
  document.getElementById('si-'+tvSymbol)?.classList.add('selected');
  loadChart(tvSymbol, name);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CHART ‚Äî Lightweight Charts + 2/3 Indicator
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lwChart = null, lwCandleSeries = null, lwEma50S = null, lwEma100S = null;
let currentChartSymbol = '';

function initLWChart() {
  const container = document.getElementById('tv-widget-container');
  if (!container) return;
  if (lwChart) { try{lwChart.remove();}catch(e){} lwChart=null; }
  const LWC = window.LightweightCharts;
  if (!LWC) { container.innerHTML='<div style="padding:30px;color:#5a7a9a;text-align:center;font-size:11px">Chart library loading‚Ä¶</div>'; return; }

  lwChart = LWC.createChart(container, {
    layout:{ background:{color:'#0d1117'}, textColor:'#8aa3b8' },
    grid:{ vertLines:{color:'#1a2430'}, horzLines:{color:'#1a2430'} },
    rightPriceScale:{ borderColor:'#1e2d40' },
    timeScale:{ borderColor:'#1e2d40', timeVisible:true },
    crosshair:{ mode:1 },
    width: container.clientWidth || 800,
    height: container.clientHeight || 500,
  });

  lwCandleSeries = lwChart.addCandlestickSeries({
    upColor:'#26a69a', downColor:'#ef5350',
    borderUpColor:'#26a69a', borderDownColor:'#ef5350',
    wickUpColor:'#26a69a', wickDownColor:'#ef5350',
  });
  lwEma50S  = lwChart.addLineSeries({color:'rgba(80,200,120,0.8)', lineWidth:1, priceLineVisible:false, lastValueVisible:false});
  lwEma100S = lwChart.addLineSeries({color:'rgba(220,80,80,0.8)',  lineWidth:1, priceLineVisible:false, lastValueVisible:false});

  new ResizeObserver(()=>{
    if (lwChart && container.clientWidth>0)
      lwChart.applyOptions({width:container.clientWidth, height:container.clientHeight||500});
  }).observe(container);
}

async function loadChart(symbol, name) {
  if (!symbol) return;
  const base = symbol.trim().toUpperCase().replace(/USDT?$/,'');
  currentChartSymbol = base;
  selectedScanTicker = base;

  const input = document.getElementById('tv-symbol-input');
  if (input) input.value = base;
  const label = document.getElementById('chart-label');
  if (label) label.textContent = (name?`${base} ¬∑ ${name}`:base) + ' ‚Äî loading‚Ä¶';

  if (!lwChart) initLWChart();
  if (!lwChart) return;

  // Fetch real OHLC from Binance via Netlify function
  const candles = await fetchCoinOHLC(base, 365);

  if (!candles || candles.length < 20) {
    if (label) label.textContent = `${base} ‚Äî no data (check Netlify functions are deployed)`;
    return;
  }

  const ohlc = candles.map(c=>({o:c.open,h:c.high,l:c.low,c:c.close}));

  // Run per-bar 2/3 for candle coloring
  const perBar = computePerBar2of3(ohlc);
  const sig    = compute2of3(ohlc);

  // Color candles: green = 2/3 bull, red = 2/3 bear, gray = neutral/persisted
  const colored = candles.map((c,i)=>{
    const s = perBar[i]?.barState ?? 0;
    const col = s===1?'#00cc44': s===-1?'#ff3333':'#5a7a9a';
    return {time:c.time, open:c.open, high:c.high, low:c.low, close:c.close,
            color:col, wickColor:col, borderColor:col};
  });
  lwCandleSeries.setData(colored);

  // EMA 50 (green) + EMA 100 (red)
  const closes = candles.map(c=>c.close);
  const k50=2/51, k100=2/101;
  let e50=closes.slice(0,50).reduce((a,b)=>a+b,0)/50;
  let e100=closes.slice(0,100).reduce((a,b)=>a+b,0)/100;
  const ema50d=[], ema100d=[];
  for (let i=0;i<candles.length;i++){
    if(i>=49){  e50=closes[i]*k50+e50*(1-k50);   ema50d.push({time:candles[i].time,value:e50}); }
    if(i>=99){  e100=closes[i]*k100+e100*(1-k100); ema100d.push({time:candles[i].time,value:e100}); }
  }
  lwEma50S.setData(ema50d);
  lwEma100S.setData(ema100d);

  // Wick High/Low reference lines
  try {
    if (sig.wickHigh) lwCandleSeries.createPriceLine({price:sig.wickHigh,color:'#f09030',lineWidth:1,lineStyle:2,title:'Wick High'});
    if (sig.wickLow)  lwCandleSeries.createPriceLine({price:sig.wickLow, color:'#4a90d8',lineWidth:1,lineStyle:2,title:'Wick Low'});
  } catch(e){}

  // LONG/SHORT arrows on bar flips
  const markers = [];
  for (let i=1;i<candles.length;i++){
    if (perBar[i]?.flipToGreen) markers.push({time:candles[i].time,position:'belowBar',color:'#00ff44',shape:'arrowUp',text:'L',size:1});
    else if (perBar[i]?.flipToRed) markers.push({time:candles[i].time,position:'aboveBar',color:'#ff4444',shape:'arrowDown',text:'S',size:1});
  }
  if (markers.length) lwCandleSeries.setMarkers(markers);

  if (label) {
    const bias = sig.allThreeBull?'üü¢ ALL 3': sig.twoOfThreeBull?'üü¢ BULLISH':
                 sig.allThreeBear?'üî¥ ALL 3': sig.twoOfThreeBear?'üî¥ BEARISH':'‚ö™ NEUTRAL';
    label.textContent=`${name||base} ¬∑ RSI ${sig.rsi??'--'} ¬∑ ${bias} (${sig.bull}/3 bull ¬∑ ${sig.bear}/3 bear)`;
  }
  lwChart.timeScale().fitContent();
}

// Alias so both names work
function loadTVChart(symbol, name) { return loadChart(symbol, name); }

// Per-bar 2/3 alignment ‚Äî JS port matching PineScript bar-by-bar logic
function computePerBar2of3(ohlc) {
  const n=ohlc.length;
  const closes=ohlc.map(b=>b.c), highs=ohlc.map(b=>b.h), lows=ohlc.map(b=>b.l), opens=ohlc.map(b=>b.o);

  // RSI series (Wilder smoothing, matches TradingView)
  const fRSI=calcRSISeries(closes,14), sRSI=calcRSISeries(closes,20);
  const smooth=calcEMASeries(fRSI,3), sig=calcSMASeries(sRSI,14);

  // Wick trend ‚Äî stateful, persists across bars
  let wt=closes[0]>opens[0]?1:-1, wh=highs[0], wl=lows[0];
  const wtS=new Array(n); wtS[0]=wt;
  for(let i=1;i<n;i++){
    if(wt===1){
      if(closes[i]<wl){wt=-1;wh=highs[i];wl=lows[i];}
      else if(closes[i]>wh){wl=lows[i];wh=highs[i];}
    } else {
      if(closes[i]<wl){wh=highs[i];wl=lows[i];}
      else if(closes[i]>wh){wt=1;wl=lows[i];wh=highs[i];}
    }
    wtS[i]=wt;
  }

  // Incremental EMA 50/100 ‚Äî proper warm-up
  let e50=closes.slice(0,50).reduce((a,b)=>a+b,0)/50;
  let e100=n>=100?closes.slice(0,100).reduce((a,b)=>a+b,0)/100:e50;
  const k50=2/51, k100=2/101;
  const ema50s=new Array(n).fill(0), ema100s=new Array(n).fill(0);
  for(let i=0;i<n;i++){
    if(i>=49){e50=closes[i]*k50+e50*(1-k50);} ema50s[i]=e50;
    if(i>=99){e100=closes[i]*k100+e100*(1-k100);} ema100s[i]=e100;
  }

  const results=[]; let prevBarState=0;
  for(let i=0;i<n;i++){
    const rsi_bull  = smooth[i]>sig[i];
    const wick_bull = wtS[i]===1;
    const c=closes[i],e5=ema50s[i],e10=ema100s[i];
    const ema_bull  = i>=99 && c>e5 && c>e10 && e5>e10;
    const ema_bear  = i>=99 && c<e5 && c<e10 && e5<e10;

    let bull=0, bear=0;
    if(rsi_bull) bull++; else bear++;
    if(wick_bull) bull++; else bear++;
    if(ema_bull) bull++; else if(ema_bear) bear++;

    // barState persists ‚Äî stays green/red until opposite flips it
    let barState=prevBarState;
    if(bull>=2) barState=1; else if(bear>=2) barState=-1;

    results.push({
      barState, bull, bear,
      flipToGreen: barState===1  && prevBarState===-1,
      flipToRed:   barState===-1 && prevBarState===1,
    });
    prevBarState=barState;
  }
  return results;
}

function reloadCurrentChart() { if(currentChartSymbol) loadChart(currentChartSymbol); }
function runScanner() { runActiveScanner(); }
function setScanTab(t) {}
function toggleFilter(el) { el.classList.toggle('on'); }
function addCustomAlert() {
  const t=prompt('Ticker (e.g. BTC):'); if(!t) return;
  scanAlerts.push({id:'al'+Date.now(),ticker:t.trim().toUpperCase(),active:true,triggered:false,created:new Date().toLocaleString()});
  toast('Alert set for '+t.toUpperCase());
}
function checkAlerts(results) {
  scanAlerts.forEach(a=>{
    if(a.triggered) return;
    const r=results.find(x=>x.symbol===a.ticker||x.tvSymbol===a.ticker);
    if(r&&(r.signal==='long'||r.signal==='long_hold')){a.triggered=true;toast('üîî '+a.ticker+' ‚Äî BULLISH signal');}
  });
}

function soon(m){toast(m+' module ‚Äî coming soon!');}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// AUTH
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doLogin(){
  if(document.getElementById('pw').value===PW){
    const btn = document.querySelector('.login-btn');
    btn.textContent = 'Loading‚Ä¶'; btn.disabled = true;
    document.getElementById('login').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    document.getElementById('tdate').textContent=new Date().toLocaleDateString('en-US',{weekday:'short',month:'long',day:'numeric',year:'numeric'});
    await load();
    navTo('home');
    btn.textContent = 'Access Portal'; btn.disabled = false;
  } else {
    const e=document.getElementById('pw-err');e.textContent='Incorrect password.';
    document.getElementById('pw').value='';setTimeout(()=>e.textContent='',3000);
  }
}
function doLogout(){
  document.getElementById('login').classList.remove('hidden');
  document.getElementById('app').classList.add('hidden');
  document.getElementById('pw').value='';
}
document.getElementById('pw').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});

let AP='overview',APID=null,APTab='info';

function setNav(id){
  document.querySelectorAll('.snav-item').forEach(n=>n.classList.remove('active'));
  document.querySelectorAll('.prop-item').forEach(n=>n.classList.remove('active'));
  if(id){
    if(id.startsWith('nav-'))document.getElementById(id)?.classList.add('active');
    else document.querySelector(`.prop-item[data-id="${id}"]`)?.classList.add('active');
  }
}
function showPanel(panel,pid){
  AP=panel;APID=pid||null;
  if(panel==='overview'){setNav('nav-overview');renderOverview();}
  else if(panel==='finance'){setNav('nav-finance');renderAllFinance();}
  else if(panel==='depreciation'){setNav('nav-depreciation');renderDepreciation();}
  else if(panel==='statements'){setNav('nav-statements');renderStatements();}
  else if(panel==='tenants'){setNav('nav-tenants');renderTenants();}
  else if(panel==='prop'){setNav(pid);APTab='info';renderPropDetail(pid);}
}
function renderSidebar(){
  const list=document.getElementById('prop-list');list.innerHTML='';
  if(!S.properties.length){list.innerHTML='<div style="padding:14px 16px;font-size:9px;color:var(--muted);line-height:1.8">No properties yet.<br>Click + to add one.</div>';return;}
  S.properties.forEach(p=>{
    const el=document.createElement('div');el.className='prop-item';el.dataset.id=p.id;
    el.innerHTML=`<div class="prop-item-name">${esc(p.name)}</div><div class="prop-item-sub">${esc(p.addr||p.type)}</div>`;
    el.onclick=()=>showPanel('prop',p.id);
    list.appendChild(el);
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// OVERVIEW
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderOverview(){
  const tv=sum(S.properties,'value'),td=sum(S.properties,'debt'),eq=tv-td;
  const m=document.getElementById('re-main');
  m.innerHTML=`
  <div class="re-summary" style="grid-template-columns:repeat(3,1fr)">
    <div class="sum-cell" onclick="showPanel('overview')" style="cursor:pointer;transition:background 0.2s" onmouseover="this.style.background='var(--surface)'" onmouseout="this.style.background=''"><div class="sum-lbl">Portfolio Value</div><div class="sum-val">${f$(tv)}</div><div class="sum-sub">Market Value ‚Üó</div></div>
    <div class="sum-cell" onclick="showPanel('finance')" style="cursor:pointer;transition:background 0.2s" onmouseover="this.style.background='var(--surface)'" onmouseout="this.style.background=''"><div class="sum-lbl">Total Debt</div><div class="sum-val neg">${f$(td)}</div><div class="sum-sub">Outstanding Mortgages ‚Üó</div></div>
    <div class="sum-cell" onclick="showPanel('overview')" style="cursor:pointer;transition:background 0.2s" onmouseover="this.style.background='var(--surface)'" onmouseout="this.style.background=''"><div class="sum-lbl">Properties</div><div class="sum-val neu">${S.properties.length}</div><div class="sum-sub">Net Equity: ${f$(eq)} ‚Üó</div></div>
  </div>
  <div class="re-content">
    <div class="page-title">Portfolio Overview</div><div class="page-sub">All Properties</div>
    ${!S.properties.length?`<div class="empty"><span class="empty-icon">üè†</span>No properties yet. Click + to add your first property.</div>`
    :`<div class="tw"><table>
      <thead><tr><th>Name</th><th>Type</th><th>Address</th><th>Value</th><th>Debt</th><th>Equity</th><th>Purchase Price</th><th>Active Tenants</th></tr></thead>
      <tbody>${S.properties.map(p=>{
        const eq2=(+p.value||0)-(+p.debt||0);
        const tc=S.tenants.filter(t=>t.propId===p.id&&t.status==='Active').length;
        return `<tr onclick="showPanel('prop','${p.id}')" style="cursor:pointer">
          <td><strong>${esc(p.name)}</strong></td><td style="color:var(--muted)">${p.type}</td>
          <td style="color:var(--muted);font-size:10px">${esc(p.addr||'‚Äî')}</td>
          <td class="pos">${f$(p.value)}</td><td class="neg">${f$(p.debt)}</td>
          <td class="${eq2>=0?'pos':'neg'}">${f$(eq2)}</td><td>${f$(p.purchasePrice)}</td>
          <td>${tc?`<span class="badge bg-green">${tc} Active</span>`:'‚Äî'}</td>
        </tr>`;
      }).join('')}</tbody>
    </table></div>`}
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PROPERTY DETAIL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPropDetail(pid){
  const p=S.properties.find(x=>x.id===pid);if(!p){return renderOverview();}
  const txns=S.transactions.filter(t=>t.propId===pid);
  const inc=txns.filter(t=>t.amount>0).reduce((s,t)=>s+(+t.amount),0);
  const exp=txns.filter(t=>t.amount<0).reduce((s,t)=>s+(+t.amount),0);
  const eq=(+p.value||0)-(+p.debt||0);
  const m=document.getElementById('re-main');
  m.innerHTML=`
  <div class="re-summary" style="grid-template-columns:repeat(3,1fr)">
    <div class="sum-cell" onclick="setPTab('${p.id}','info')" style="cursor:pointer;transition:background 0.2s" onmouseover="this.style.background='var(--surface)'" onmouseout="this.style.background=''"><div class="sum-lbl">Market Value</div><div class="sum-val">${f$(p.value)}</div><div class="sum-sub">Edit Info ‚Üó</div></div>
    <div class="sum-cell" onclick="setPTab('${p.id}','finance')" style="cursor:pointer;transition:background 0.2s" onmouseover="this.style.background='var(--surface)'" onmouseout="this.style.background=''"><div class="sum-lbl">Mortgage Balance</div><div class="sum-val neg">${f$(p.debt)}</div><div class="sum-sub">View Finances ‚Üó</div></div>
    <div class="sum-cell" onclick="showPanel('overview')" style="cursor:pointer;transition:background 0.2s" onmouseover="this.style.background='var(--surface)'" onmouseout="this.style.background=''"><div class="sum-lbl">Net Equity</div><div class="sum-val ${eq>=0?'pos':'neg'}">${f$(eq)}</div><div class="sum-sub">All Properties ‚Üó</div></div>
  </div>
  <div class="re-content">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px">
      <div>
        <div style="font-family:'Playfair Display',serif;font-size:22px;color:var(--white)">${esc(p.name)}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:3px">${esc(p.addr||'')} ${p.units?'¬∑ '+esc(p.units):''} ${p.sqft?'¬∑ '+Number(p.sqft).toLocaleString()+' sqft':''}</div>
      </div>
      <button class="btn-d no-print" onclick="deleteProp('${p.id}')">Delete Property</button>
    </div>
    <div class="stat-row">
      <div class="stat-box"><div class="stat-lbl">Purchase Price</div><div class="stat-val">${f$(p.purchasePrice)}</div></div>
      <div class="stat-box"><div class="stat-lbl">Total Income</div><div class="stat-val pos">${f$(inc)}</div></div>
      <div class="stat-box"><div class="stat-lbl">Total Expenses</div><div class="stat-val neg">${f$(Math.abs(exp))}</div></div>
      <div class="stat-box"><div class="stat-lbl">Net Cash Flow</div><div class="stat-val ${inc+exp>=0?'pos':'neg'}">${f$(inc+exp)}</div></div>
    </div>
    <div class="tabs">
      <div class="tab ${APTab==='info'?'active':''}" onclick="setPTab('${pid}','info')">Property Info</div>
      <div class="tab ${APTab==='finance'?'active':''}" onclick="setPTab('${pid}','finance')">Finances</div>
      <div class="tab ${APTab==='depr'?'active':''}" onclick="setPTab('${pid}','depr')">Depreciation</div>
      <div class="tab ${APTab==='tenants'?'active':''}" onclick="setPTab('${pid}','tenants')">Tenants</div>
    </div>
    <div id="ptab">${renderPTab(pid,APTab)}</div>
  </div>`;
  if(APTab==='finance'){renderFinanceTable('pft',pid,false);}
  if(APTab==='depr'){renderPropDeprTab(pid);}
  if(APTab==='tenants'){renderPropTenantsTab(pid);}
}
function setPTab(pid,tab){APTab=tab;renderPropDetail(pid);}
function renderPTab(pid,tab){
  if(tab==='info')return renderInfoTab(pid);
  if(tab==='finance')return`<div class="fctrls no-print"><button class="btn-a" onclick="addTxn('${pid}')">+ Add Transaction</button><div class="frow"><select class="fsel" id="pf-irs" onchange="renderFinanceTable('pft','${pid}',false)"><option value="">All IRS</option>${IRS.map(c=>`<option value="${c.code}">${c.code}</option>`).join('')}</select><select class="fsel" id="pf-year" onchange="renderFinanceTable('pft','${pid}',false)"><option value="">All Years</option>${getYears().map(y=>`<option value="${y}">${y}</option>`).join('')}</select></div></div><div id="pft"></div>`;
  if(tab==='depr')return`<div id="pdwrap"></div>`;
  if(tab==='tenants')return`<div id="ptwrap"></div>`;
  return '';
}
function renderInfoTab(pid){
  const p=S.properties.find(x=>x.id===pid);if(!p)return '';
  const equity=(+p.value||0)-(+p.debt||0);
  const zillowAddr=encodeURIComponent((p.addr||'').trim().replace(/\s+/g,'-'));
  const zillowUrl=p.addr?`https://www.zillow.com/homes/${zillowAddr}_rb/`:'https://www.zillow.com';
  const payHistory=p.payHistory||[];
  const totalPaidDown=payHistory.reduce((s,x)=>s+(+x.principal||0),0);
  const totalInterestPaid=payHistory.reduce((s,x)=>s+(+x.interest||0),0);
  return `<div class="fs">
    <div class="fs-title">Property Details ‚Äî edits auto-save</div>
    <div class="fg g3">
      <div class="fgrp"><div class="fl">Type</div><input class="fi" value="${esc(p.type||'')}" onchange="up('${pid}','type',this.value)"/></div>
      <div class="fgrp"><div class="fl">Purchase Date</div><input class="fi" type="date" value="${p.purchaseDate||''}" onchange="up('${pid}','purchaseDate',this.value)"/></div>
      <div class="fgrp"><div class="fl">Sq Footage</div><input class="fi" type="number" value="${p.sqft||''}" onchange="up('${pid}','sqft',this.value)"/></div>
      <div class="fgrp">
        <div class="fl" style="display:flex;justify-content:space-between;align-items:center">
          <span>Market Value ($)</span>
          <a href="${zillowUrl}" target="_blank" rel="noopener" style="font-size:8px;color:var(--blue2);letter-spacing:0.08em;text-decoration:none;border:1px solid rgba(122,168,212,0.3);padding:2px 7px;border-radius:2px;transition:all 0.2s" onmouseover="this.style.background='rgba(122,168,212,0.1)'" onmouseout="this.style.background='none'">Zillow ‚Üó</a>
        </div>
        <input class="fi" type="number" value="${p.value||''}" onchange="up('${pid}','value',this.value);renderPropDetail('${pid}')"/>
      </div>
      <div class="fgrp"><div class="fl">Current Mortgage Balance ($)</div><input class="fi" type="number" value="${p.debt||''}" onchange="up('${pid}','debt',this.value);renderPropDetail('${pid}')"/></div>
      <div class="fgrp"><div class="fl">Purchase Price ($)</div><input class="fi" type="number" value="${p.purchasePrice||''}" onchange="up('${pid}','purchasePrice',this.value)"/></div>
      <div class="fgrp"><div class="fl">Land Value ($)</div><input class="fi" type="number" value="${p.landValue||''}" onchange="up('${pid}','landValue',this.value)" title="Non-depreciable land"/></div>
      <div class="fgrp"><div class="fl">Units / Bedrooms</div><input class="fi" value="${esc(p.units||'')}" onchange="up('${pid}','units',this.value)"/></div>
      <div class="fgrp full"><div class="fl">Address</div><input class="fi" value="${esc(p.addr||'')}" onchange="up('${pid}','addr',this.value)"/></div>
      <div class="fgrp full"><div class="fl">Notes</div><textarea class="fta" onchange="up('${pid}','notes',this.value)">${esc(p.notes||'')}</textarea></div>
    </div>
  </div>

  <div class="fs">
    <div class="fs-title" style="display:flex;justify-content:space-between;align-items:center">
      <span>Monthly Principal Buydown</span>
      <div style="display:flex;gap:20px;font-size:10px;font-weight:400">
        <span style="color:var(--muted)">Paid Down: <strong class="pos">${f$(totalPaidDown)}</strong></span>
        <span style="color:var(--muted)">Interest Paid: <strong class="neg">${f$(totalInterestPaid)}</strong></span>
        <span style="color:var(--muted)">Current Equity: <strong class="${equity>=0?'pos':'neg'}">${f$(equity)}</strong></span>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;margin-bottom:16px;align-items:end">
      <div class="fgrp"><div class="fl">Month</div><input class="fi" type="month" id="pay-m-${pid}" value="${new Date().toISOString().slice(0,7)}"/></div>
      <div class="fgrp"><div class="fl">Principal Paid ($)</div><input class="fi" type="number" id="pay-p-${pid}" placeholder="0" step="0.01"/></div>
      <div class="fgrp"><div class="fl">Interest Paid ($) <span style="color:var(--muted2);font-size:8px">optional</span></div><input class="fi" type="number" id="pay-i-${pid}" placeholder="0" step="0.01"/></div>
      <button class="btn-p" style="height:38px" onclick="addPayment('${pid}')">+ Add</button>
    </div>
    ${!payHistory.length
      ?`<div style="color:var(--muted);font-size:11px;padding:4px 0">No payments yet. Add monthly payments above ‚Äî the mortgage balance and equity update automatically.</div>`
      :`<div class="tw"><table>
          <thead><tr><th>Month</th><th style="text-align:right">Principal</th><th style="text-align:right">Interest</th><th style="text-align:right">Remaining Balance</th><th style="text-align:right">Equity</th><th class="no-print"></th></tr></thead>
          <tbody>${buildPayRows(pid)}</tbody>
          <tfoot><tr class="tr-tot">
            <td><strong>Totals</strong></td>
            <td class="pos" style="text-align:right">${f$(totalPaidDown)}</td>
            <td class="neg" style="text-align:right">${f$(totalInterestPaid)}</td>
            <td style="text-align:right">${f$(+p.debt||0)}</td>
            <td class="${equity>=0?'pos':'neg'}" style="text-align:right">${f$(equity)}</td>
            <td class="no-print"></td>
          </tr></tfoot>
        </table></div>`}
  </div>`;
}

function buildPayRows(pid){
  const p=S.properties.find(x=>x.id===pid);if(!p||!p.payHistory)return '';
  const sorted=[...p.payHistory].sort((a,b)=>a.month.localeCompare(b.month));
  const totalPaid=sorted.reduce((s,x)=>s+(+x.principal||0),0);
  // Reconstruct running balance: current balance is after all payments, work forward
  let runBal=(+p.debt||0)+totalPaid;
  return sorted.map(ph=>{
    runBal-=(+ph.principal||0);
    const eq=(+p.value||0)-runBal;
    return`<tr>
      <td>${ph.month}</td>
      <td class="pos" style="text-align:right">${f$(ph.principal)}</td>
      <td class="neg" style="text-align:right">${+ph.interest>0?f$(ph.interest):'‚Äî'}</td>
      <td style="text-align:right">${f$(Math.max(0,runBal))}</td>
      <td class="${eq>=0?'pos':'neg'}" style="text-align:right">${f$(eq)}</td>
      <td class="no-print"><button class="xbtn" onclick="delPayment('${pid}','${ph.id}')">‚úï</button></td>
    </tr>`;
  }).join('');
}

function addPayment(pid){
  const month=document.getElementById(`pay-m-${pid}`)?.value;
  const principal=parseFloat(document.getElementById(`pay-p-${pid}`)?.value)||0;
  const interest=parseFloat(document.getElementById(`pay-i-${pid}`)?.value)||0;
  if(!month||principal<=0){toast('Enter a month and principal amount.');return;}
  const p=S.properties.find(x=>x.id===pid);if(!p)return;
  if(!p.payHistory)p.payHistory=[];
  if(p.payHistory.find(x=>x.month===month)){toast('Payment for that month already exists.');return;}
  p.payHistory.push({id:'ph'+Date.now(),month,principal,interest});
  p.debt=Math.max(0,(+p.debt||0)-principal);
  save();
  renderPropDetail(pid);
  toast('Payment added ‚Äî balance & equity updated!');
}

function delPayment(pid,phId){
  const p=S.properties.find(x=>x.id===pid);if(!p)return;
  const ph=(p.payHistory||[]).find(x=>x.id===phId);if(!ph)return;
  if(!confirm('Remove this payment? The mortgage balance will be restored.'))return;
  p.debt=(+p.debt||0)+(+ph.principal||0);
  p.payHistory=p.payHistory.filter(x=>x.id!==phId);
  save();
  renderPropDetail(pid);
  toast('Payment removed.');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FINANCES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAllFinance(){
  const inc=S.transactions.filter(t=>t.amount>0).reduce((s,t)=>s+(+t.amount),0);
  const exp=S.transactions.filter(t=>t.amount<0).reduce((s,t)=>s+(+t.amount),0);
  const m=document.getElementById('re-main');
  m.innerHTML=`
  <div class="re-summary" style="grid-template-columns:repeat(3,1fr)">
    <div class="sum-cell"><div class="sum-lbl">Total Income</div><div class="sum-val pos">${f$(inc)}</div></div>
    <div class="sum-cell"><div class="sum-lbl">Total Expenses</div><div class="sum-val neg">${f$(Math.abs(exp))}</div></div>
    <div class="sum-cell"><div class="sum-lbl">Net</div><div class="sum-val ${inc+exp>=0?'pos':'neg'}">${f$(inc+exp)}</div></div>
  </div>
  <div class="re-content">
    <div class="page-title">All Finances</div><div class="page-sub">All Properties ¬∑ IRS Schedule E</div>
    <div class="fctrls no-print">
      <button class="btn-a" onclick="addTxn(null)">+ Add Transaction</button>
      <div class="frow">
        <select class="fsel" id="af-prop" onchange="renderFinanceTable('aft',null,true)"><option value="">All Properties</option>${S.properties.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('')}</select>
        <select class="fsel" id="af-irs" onchange="renderFinanceTable('aft',null,true)"><option value="">All IRS Codes</option>${IRS.map(c=>`<option value="${c.code}">${c.code} ‚Äî ${c.label}</option>`).join('')}</select>
        <select class="fsel" id="af-yr" onchange="renderFinanceTable('aft',null,true)"><option value="">All Years</option>${getYears().map(y=>`<option value="${y}">${y}</option>`).join('')}</select>
      </div>
    </div>
    <div id="aft"></div>
  </div>`;
  renderFinanceTable('aft',null,true);
}

function renderFinanceTable(cid,pFilter,showProp){
  const c=document.getElementById(cid);if(!c)return;
  const pf=document.getElementById('af-prop')?.value||pFilter||'';
  const irf=document.getElementById('af-irs')?.value||document.getElementById('pf-irs')?.value||'';
  const yf=document.getElementById('af-yr')?.value||document.getElementById('pf-year')?.value||'';
  let txns=[...S.transactions];
  if(pf)txns=txns.filter(t=>t.propId===pf);
  if(irf)txns=txns.filter(t=>t.irsCode===irf);
  if(yf)txns=txns.filter(t=>t.date&&t.date.startsWith(yf));
  txns.sort((a,b)=>new Date(b.date)-new Date(a.date));
  const inc=txns.filter(t=>t.amount>0).reduce((s,t)=>s+(+t.amount),0);
  const exp=txns.filter(t=>t.amount<0).reduce((s,t)=>s+(+t.amount),0);
  const cols=showProp?7:6;
  c.innerHTML=`<div class="tw"><table>
    <thead><tr><th>Date</th>${showProp?'<th>Property</th>':''}<th>Description</th><th>IRS Category</th><th>Type</th><th style="text-align:right">Amount</th><th class="no-print"></th></tr></thead>
    <tbody>
    ${!txns.length?`<tr><td colspan="${cols}" class="empty">No transactions. Click + Add Transaction.</td></tr>`
    :txns.map(t=>`<tr>
      <td><input class="tde" type="date" value="${t.date||''}" style="width:126px" onchange="ut('${t.id}','date',this.value)"/></td>
      ${showProp?`<td><select class="tds" style="min-width:110px" onchange="ut('${t.id}','propId',this.value)"><option value="">‚Äî</option>${S.properties.map(p=>`<option value="${p.id}" ${p.id===t.propId?'selected':''}>${esc(p.name)}</option>`).join('')}</select></td>`:''}
      <td><input class="tde" value="${esc(t.desc||'')}" placeholder="Description" style="min-width:140px" onchange="ut('${t.id}','desc',this.value)"/></td>
      <td><select class="tds" style="min-width:160px" onchange="ut('${t.id}','irsCode',this.value)">${IRS.map(ic=>`<option value="${ic.code}" ${ic.code===t.irsCode?'selected':''}>${ic.code} ‚Äî ${ic.label}</option>`).join('')}</select></td>
      <td><select class="tds" style="min-width:90px" onchange="utType('${t.id}',this.value)"><option value="income" ${t.amount>0?'selected':''}>Income</option><option value="expense" ${t.amount<=0?'selected':''}>Expense</option></select></td>
      <td style="text-align:right"><input class="tde" type="number" step="0.01" value="${Math.abs(+t.amount).toFixed(2)}" style="text-align:right;width:96px" onchange="utAmt('${t.id}',this.value)"/></td>
      <td class="no-print" style="white-space:nowrap">
        ${t.irsCode==='SE-18'?`<button class="xbtn" style="color:var(--blue2);font-size:11px;padding:2px 6px" title="Import to Depreciation Schedule" onclick="importTxnToDepr('${t.id}')">üìã‚Üí</button>`:''}
        <button class="xbtn" onclick="dtxn('${t.id}','${cid}','${pFilter||''}','${showProp}')">‚úï</button>
      </td>
    </tr>`).join('')}
    </tbody>
    ${txns.length?`<tfoot><tr class="tr-tot"><td colspan="${showProp?3:2}"><strong>Totals</strong></td><td colspan="2"></td><td style="text-align:right"><span class="pos">${f$(inc)}</span> / <span class="neg">${f$(Math.abs(exp))}</span></td><td class="no-print"></td></tr></tfoot>`:''}
  </table></div>
  ${txns.length?`<div class="net-bar">
    <div class="net-item"><div class="net-lbl">Income</div><div class="net-val pos">${f$(inc)}</div></div>
    <div class="net-item"><div class="net-lbl">Expenses</div><div class="net-val neg">${f$(Math.abs(exp))}</div></div>
    <div class="net-item"><div class="net-lbl">Net</div><div class="net-val" style="color:${inc+exp>=0?'var(--green)':'var(--red)'}">${f$(inc+exp)}</div></div>
  </div>`:''}`;
}

function addTxn(pid){const t={id:'t'+Date.now(),propId:pid||'',date:td(),desc:'',amount:0,irsCode:'SE-7'};S.transactions.push(t);save();if(document.getElementById('pft'))renderFinanceTable('pft',pid,false);else renderAllFinance();}
function ut(id,f,v){const t=S.transactions.find(x=>x.id===id);if(t){t[f]=v;save();}}
function utType(id,type){const t=S.transactions.find(x=>x.id===id);if(t){const a=Math.abs(+t.amount);t.amount=type==='income'?a:-a;save();}}
function utAmt(id,v){const t=S.transactions.find(x=>x.id===id);if(t){const a=+v||0;t.amount=t.amount>=0?a:-a;save();}}
function dtxn(id,cid,pf,sp){S.transactions=S.transactions.filter(t=>t.id!==id);save();renderFinanceTable(cid,pf||null,sp==='true');}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DEPRECIATION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDepreciation(){
  const tc=sum(S.assets,'cost');
  const ty=S.assets.reduce((s,a)=>s+deprYr(a,CY),0);
  const tcl=S.assets.reduce((s,a)=>s+deprThru(a,CY),0);
  const m=document.getElementById('re-main');
  m.innerHTML=`
  <div class="re-summary" style="grid-template-columns:repeat(4,1fr)">
    <div class="sum-cell"><div class="sum-lbl">Total Assets</div><div class="sum-val neu">${S.assets.length}</div></div>
    <div class="sum-cell"><div class="sum-lbl">Depreciable Basis</div><div class="sum-val">${f$(tc)}</div></div>
    <div class="sum-cell"><div class="sum-lbl">${CY} Depreciation</div><div class="sum-val pos">${f$(ty)}</div></div>
    <div class="sum-cell"><div class="sum-lbl">Total Claimed to Date</div><div class="sum-val neg">${f$(tcl)}</div></div>
  </div>
  <div class="re-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div><div class="page-title">MACRS Depreciation Schedules</div><div class="page-sub">IRS Schedule E ¬∑ Line 18 ¬∑ Rev. Proc. 87-57</div></div>
      <div style="display:flex;gap:8px;align-items:center" class="no-print">
        <button class="btn-a" onclick="showAddAssetModal(null)">+ Add Asset</button>
        <select class="fsel" id="depr-yr" onchange="reDeprTable()" style="min-width:80px">
          ${[...Array(12)].map((_,i)=>`<option value="${CY-i}" ${i===0?'selected':''}>${CY-i}</option>`).join('')}
        </select>
      </div>
    </div>
    <div id="depr-wrap"></div>
  </div>`;
  reDeprTable();
}

function reDeprTable(){
  const yr=parseInt(document.getElementById('depr-yr')?.value||CY);
  const c=document.getElementById('depr-wrap');if(!c)return;
  if(!S.assets.length){c.innerHTML=`<div class="empty"><span class="empty-icon">üìã</span>No depreciable assets yet.<br>Click + Add Asset to begin tracking MACRS schedules.</div>`;return;}

  let totBasis=0,totYr=0,totClaimed=0,totRem=0;
  let rows=S.assets.map(a=>{
    const prop=S.properties.find(p=>p.id===a.propId);
    const ty=deprYr(a,yr);
    const cl=deprThru(a,yr);
    const rem=Math.max(0,(+a.cost||0)-cl);
    const full=rem<1;
    totBasis+=(+a.cost||0);totYr+=ty;totClaimed+=cl;totRem+=rem;
    return `<tr>
      <td><strong>${esc(a.desc)}</strong>${a.notes?`<br><span style="font-size:9px;color:var(--muted)">${esc(a.notes)}</span>`:''}</td>
      <td style="color:var(--muted);font-size:10px">${prop?esc(prop.name):'‚Äî'}</td>
      <td style="color:var(--muted)">${a.serviceDate||'‚Äî'}</td>
      <td>${f$(a.cost)}</td>
      <td><span class="badge bg-blue">${a.macrsCls}-yr</span></td>
      <td style="font-size:10px;color:var(--muted)">${a.method}</td>
      <td class="${ty>0?'pos':'neg'}">${f$(ty)}</td>
      <td class="neg">${f$(cl)}</td>
      <td>${f$(rem)}</td>
      <td>${full?`<span class="badge bg-yellow">Fully Depreciated</span>`:`<span class="badge bg-green">Active</span>`}</td>
      <td class="no-print"><button class="xbtn" onclick="delAsset('${a.id}')">‚úï</button></td>
    </tr>`;
  }).join('');

  // ‚îÄ‚îÄ Build combined year-by-year schedule across ALL assets ‚îÄ‚îÄ
  // Collect every tax year that appears across all asset schedules
  const allYears=new Set();
  S.assets.forEach(a=>{
    if(!a.serviceDate)return;
    const sy=new Date(a.serviceDate).getFullYear();
    const rates=MACRS[String(a.macrsCls)]||MACRS['27.5'];
    for(let i=0;i<rates.length;i++)allYears.add(sy+i);
  });
  const sortedYears=[...allYears].sort((a,b)=>a-b);

  // For each year: sum depr, cumulative, remaining across all assets
  let combinedRows='';
  let runningCum=0;
  const totalBasisAll=S.assets.reduce((s,a)=>s+(+a.cost||0),0);
  sortedYears.forEach(y=>{
    const yearDepr=S.assets.reduce((s,a)=>s+deprYr(a,y),0);
    runningCum+=yearDepr;
    const remaining=Math.max(0,totalBasisAll-runningCum);
    const isCur=y===yr;
    combinedRows+=`<tr class="${isCur?'macrs-cur':''}">
      <td style="${isCur?'color:var(--blue2);font-weight:600':''}">${isCur?`${y} ‚óÄ Selected Year`:y}</td>
      <td class="${yearDepr>0?'pos':'neg'}">${yearDepr>0?f$(yearDepr):'‚Äî'}</td>
      <td class="neg">${f$(runningCum)}</td>
      <td>${f$(remaining)}</td>
    </tr>`;
  });

  // Per-asset summary rows (expandable detail) ‚Äî collapsed by default
  let assetDetailRows=S.assets.map((a,idx)=>{
    const prop=S.properties.find(p=>p.id===a.propId);
    const ty2=deprYr(a,yr);
    const cl2=deprThru(a,yr);
    const rem2=Math.max(0,(+a.cost||0)-cl2);
    return `<tr>
      <td><strong>${esc(a.desc)}</strong>${a.notes?`<br><span style="font-size:9px;color:var(--muted)">${esc(a.notes)}</span>`:''}</td>
      <td style="color:var(--muted);font-size:10px">${prop?esc(prop.name):'‚Äî'}</td>
      <td style="color:var(--muted)">${a.serviceDate||'‚Äî'}</td>
      <td>${f$(a.cost)}</td>
      <td><span class="badge bg-blue">${a.macrsCls}-yr</span></td>
      <td style="font-size:10px;color:var(--muted)">${a.method}</td>
      <td class="${ty2>0?'pos':'neg'}">${f$(ty2)}</td>
      <td class="neg">${f$(cl2)}</td>
      <td>${f$(rem2)}</td>
      <td>${rem2<1?`<span class="badge bg-yellow">Fully Depreciated</span>`:`<span class="badge bg-green">Active</span>`}</td>
      <td class="no-print"><button class="xbtn" onclick="delAsset('${a.id}')">‚úï</button></td>
    </tr>`;
  }).join('');

  let html=`
  <!-- ASSET SUMMARY TABLE -->
  <div class="tw"><table>
    <thead><tr><th>Asset</th><th>Property</th><th>In Service</th><th>Basis</th><th>Class</th><th>Method</th><th>${yr} Depr.</th><th>Prior Claimed</th><th>Remaining</th><th>Status</th><th class="no-print"></th></tr></thead>
    <tbody>${assetDetailRows}</tbody>
    <tfoot><tr class="tr-tot"><td colspan="3"><strong>Totals</strong></td><td>${f$(totBasis)}</td><td colspan="2"></td><td class="pos">${f$(totYr)}</td><td class="neg">${f$(totClaimed)}</td><td>${f$(totRem)}</td><td colspan="2"></td></tr></tfoot>
  </table></div>

  <!-- COMBINED YEAR-BY-YEAR SCHEDULE -->
  <div style="margin-top:28px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <div style="font-size:9px;letter-spacing:0.2em;text-transform:uppercase;color:var(--muted)">Combined Year-by-Year Schedule ‚Äî All Assets</div>
      <div style="font-size:9px;color:var(--muted)">Total Basis: <strong style="color:var(--white)">${f$(totalBasisAll)}</strong></div>
    </div>
    <div class="fs" style="padding:0;overflow:hidden">
      <div class="tw"><table>
        <thead><tr>
          <th>Tax Year</th>
          <th>Combined Annual Depreciation</th>
          <th>Cumulative Claimed</th>
          <th>Remaining Basis (All Assets)</th>
        </tr></thead>
        <tbody>${combinedRows||'<tr><td colspan="4" class="empty">No assets with service dates.</td></tr>'}</tbody>
        <tfoot><tr class="tr-tot">
          <td><strong>Total</strong></td>
          <td class="pos">${f$(totalBasisAll)}</td>
          <td class="neg">${f$(totalBasisAll)}</td>
          <td>‚Äî</td>
        </tr></tfoot>
      </table></div>
    </div>
    <div style="margin-top:10px;font-size:9px;color:var(--muted2)">‚ñ≤ Combined totals across all ${S.assets.length} asset${S.assets.length!==1?'s':''}. Selected year (${yr}) is highlighted in blue.</div>
  </div>`;
  c.innerHTML=html;
}

function assetScheduleHTML(a,viewYr){
  const life=parseFloat(a.macrsCls)||27.5;
  const startYr=new Date(a.serviceDate||new Date()).getFullYear();
  const rates=MACRS[String(a.macrsCls)]||MACRS['27.5'];
  const cost=+a.cost||0;
  let rows='';let cum=0;
  for(let i=0;i<rates.length;i++){
    const yr=startYr+i;
    const rate=rates[i]||0;
    let da=0;
    if(a.method==='179'||a.method==='BONUS'){da=i===0?cost:0;}
    else{da=cost*(rate/100);}
    cum+=da;
    const rem=Math.max(0,cost-cum);
    const isCur=yr===viewYr;
    rows+=`<tr class="${isCur?'macrs-cur':''}">
      <td style="${isCur?'color:var(--blue2)':''}">${isCur?`<strong>${yr} ‚óÄ</strong>`:yr}</td>
      <td style="color:var(--muted)">${i+1}</td>
      <td style="color:var(--muted)">${a.method==='179'||a.method==='BONUS'?(i===0?'100%':'‚Äî'):(rate.toFixed(3)+'%')}</td>
      <td class="${da>0?'pos':'neg'}">${f$(da)}</td>
      <td class="neg">${f$(cum)}</td>
      <td>${f$(rem)}</td>
    </tr>`;
  }
  return `<div class="fs" style="margin-bottom:14px">
    <div class="fs-title">${esc(a.desc)} ‚Äî ${a.macrsCls}-Year MACRS (${a.method}) ¬∑ ${a.serviceDate||'N/A'}</div>
    <div class="tw"><table>
      <thead><tr><th>Tax Year</th><th>Yr #</th><th>Rate</th><th>Annual Depr.</th><th>Cumulative</th><th>Remaining</th></tr></thead>
      <tbody>${rows}</tbody>
    </table></div>
  </div>`;
}

function renderPropDeprTab(pid){
  const c=document.getElementById('pdwrap');if(!c)return;
  const assets=S.assets.filter(a=>a.propId===pid);
  const ty=assets.reduce((s,a)=>s+deprYr(a,CY),0);
  c.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
    <div style="font-size:9px;color:var(--muted)">${CY} Depreciation: <strong class="pos">${f$(ty)}</strong></div>
    <button class="btn-a no-print" onclick="showAddAssetModal('${pid}')">+ Add Asset</button>
  </div>
  ${!assets.length?`<div class="empty"><span class="empty-icon">üìã</span>No depreciable assets. Add assets to track MACRS schedules.</div>`
  :assets.map(a=>assetScheduleHTML(a,CY)).join('')}`;
}

function deprYr(a,yr){
  if(!a.serviceDate||!a.cost)return 0;
  const sy=new Date(a.serviceDate).getFullYear();
  const idx=yr-sy;if(idx<0)return 0;
  if(a.method==='179'||a.method==='BONUS')return idx===0?(+a.cost||0):0;
  const rates=MACRS[String(a.macrsCls)]||MACRS['27.5'];
  if(idx>=rates.length)return 0;
  return(+a.cost||0)*(rates[idx]/100);
}
function deprThru(a,thruYr){
  let t=0;const sy=new Date(a.serviceDate||'1900-01-01').getFullYear();
  for(let y=sy;y<=thruYr;y++)t+=deprYr(a,y);return t;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STATEMENTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStatements(){
  const m=document.getElementById('re-main');
  m.innerHTML=`
  <div class="re-content">
    <div class="page-title">Financial Statements</div>
    <div class="page-sub">Portfolio & Individual Property Reports</div>
    <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap" class="no-print">
      <select class="fsel" id="st-prop" onchange="genStmt()" style="min-width:160px">
        <option value="">All Properties</option>
        ${S.properties.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('')}
      </select>
      <select class="fsel" id="st-period" onchange="genStmt()">
        <option value="year">Annual</option>
        <option value="month">Monthly</option>
        <option value="quarter">Quarterly</option>
      </select>
      <select class="fsel" id="st-year" onchange="genStmt()">
        ${getYears().map(y=>`<option value="${y}" ${y===CY?'selected':''}>${y}</option>`).join('')}
      </select>
      <select class="fsel" id="st-month" onchange="genStmt()">
        ${['January','February','March','April','May','June','July','August','September','October','November','December'].map((mn,i)=>`<option value="${i+1}" ${i+1===new Date().getMonth()+1?'selected':''}>${mn}</option>`).join('')}
      </select>
    </div>
    <div id="stmt-out"></div>
  </div>`;
  genStmt();
}

function genStmt(){
  const scope=document.getElementById('st-prop')?.value||'';
  const period=document.getElementById('st-period')?.value||'year';
  const year=parseInt(document.getElementById('st-year')?.value||CY);
  const month=parseInt(document.getElementById('st-month')?.value||1);
  const props=scope?S.properties.filter(p=>p.id===scope):S.properties;
  const propLabel=scope?(S.properties.find(p=>p.id===scope)?.name||'Property'):'All Properties';

  let txns=[...S.transactions];
  if(scope)txns=txns.filter(t=>t.propId===scope);
  if(period==='year')txns=txns.filter(t=>t.date&&t.date.startsWith(String(year)));
  else if(period==='month')txns=txns.filter(t=>{if(!t.date)return false;const d=new Date(t.date);return d.getFullYear()===year&&d.getMonth()+1===month;});
  else{const q=Math.ceil(month/3);txns=txns.filter(t=>{if(!t.date)return false;const d=new Date(t.date);return d.getFullYear()===year&&Math.ceil((d.getMonth()+1)/3)===q;});}

  const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
  const periodLabel=period==='year'?`Year ${year}`:period==='month'?`${MONTHS[month-1]} ${year}`:`Q${Math.ceil(month/3)} ${year}`;
  const tv=props.reduce((s,p)=>s+(+p.value||0),0);
  const td2=props.reduce((s,p)=>s+(+p.debt||0),0);
  const inc=txns.filter(t=>t.amount>0).reduce((s,t)=>s+(+t.amount),0);
  const exp=txns.filter(t=>t.amount<0).reduce((s,t)=>s+(+t.amount),0);
  const noi=inc+exp;

  // ‚îÄ‚îÄ Tally transactions by IRS code ‚îÄ‚îÄ
  const byCode={};
  txns.forEach(t=>{const k=t.irsCode||'SE-19a';if(!byCode[k])byCode[k]=0;byCode[k]+=(+t.amount||0);});

  // ‚îÄ‚îÄ DEPRECIATION from asset schedule for this tax year ‚îÄ‚îÄ
  // Includes ALL assets that have a recovery period covering `year`,
  // regardless of when they were placed in service (5yr, 7yr, 27.5yr etc.)
  const scopedAssets=S.assets.filter(a=>!scope||a.propId===scope);
  const deprByAsset=scopedAssets.map(a=>{
    const sy=new Date(a.serviceDate||'1900').getFullYear();
    const d=deprYr(a,year);
    const rates=MACRS[String(a.macrsCls)]||MACRS['27.5'];
    const endYr=sy+rates.length-1;
    const inRecovery=year>=sy&&year<=endYr&&d>0;
    return{a,d,sy,endYr,inRecovery};
  }).filter(x=>x.d>0);
  const deprTotal=deprByAsset.reduce((s,x)=>s+x.d,0);
  const netTax=noi-deprTotal;

  // ‚îÄ‚îÄ Monthly breakdown (annual view only) ‚îÄ‚îÄ
  let monthlyHTML='';
  if(period==='year'){
    const mRows=MONTHS.map((mn,i)=>{
      const mt=txns.filter(t=>{if(!t.date)return false;const d=new Date(t.date);return d.getMonth()===i;});
      const mi=mt.filter(t=>t.amount>0).reduce((s,t)=>s+(+t.amount),0);
      const me=mt.filter(t=>t.amount<0).reduce((s,t)=>s+(+t.amount),0);
      return`<tr><td>${mn}</td><td class="pos" style="text-align:right">${mi>0?f$(mi):'‚Äî'}</td><td class="neg" style="text-align:right">${me<0?f$(Math.abs(me)):'‚Äî'}</td><td class="${mi+me>=0?'pos':'neg'}" style="text-align:right">${f$(mi+me)}</td></tr>`;
    }).join('');
    monthlyHTML=`<div class="stmt-sec">
      <div class="stmt-sec-hdr"><div class="stmt-sec-hdr-title">Monthly Breakdown ‚Äî ${year}</div></div>
      <div class="stmt-sec-body"><div class="tw"><table>
        <thead><tr><th>Month</th><th style="text-align:right">Income</th><th style="text-align:right">Expenses</th><th style="text-align:right">Net</th></tr></thead>
        <tbody>${mRows}</tbody>
        <tfoot><tr class="tr-tot"><td>Total</td><td class="pos" style="text-align:right">${f$(inc)}</td><td class="neg" style="text-align:right">${f$(Math.abs(exp))}</td><td class="${noi>=0?'pos':'neg'}" style="text-align:right">${f$(noi)}</td></tr></tfoot>
      </table></div></div>
    </div>`;
  }

  // ‚îÄ‚îÄ BUILD IRS SCHEDULE E MOCK ‚îÄ‚îÄ
  // Schedule E Part I ‚Äî Income or Loss From Rental Real Estate
  // Each line maps to a real IRS SE line number and pulls from byCode
  // Line 18 (Depreciation) is calculated from the asset schedule, not from transactions

  function seLine(lineNum,label,codeKey,isIncome,forceVal){
    const raw=forceVal!==undefined?forceVal:(byCode[codeKey]||0);
    const display=isIncome?raw:Math.abs(raw);
    const hasVal=display>0;
    return`<tr class="${hasVal?'':'se-zero'}">
      <td style="color:var(--muted);width:60px;font-size:10px">Line ${lineNum}</td>
      <td>${label}</td>
      <td style="text-align:right;width:130px" class="${hasVal?(isIncome?'pos':'neg'):''}">${hasVal?f$(display):'‚Äî'}</td>
    </tr>`;
  }

  // Part I ‚Äî Income
  const incomeSection=`
    <tr style="background:var(--bg)"><td colspan="3" style="font-size:9px;letter-spacing:0.15em;text-transform:uppercase;color:var(--blue2);padding:10px 11px 6px">Income</td></tr>
    ${seLine(3,'Rents Received','SE-3',true)}`;

  // Part I ‚Äî Expenses
  const expSection=`
    <tr style="background:var(--bg)"><td colspan="3" style="font-size:9px;letter-spacing:0.15em;text-transform:uppercase;color:var(--blue2);padding:10px 11px 6px">Expenses</td></tr>
    ${seLine(5,'Advertising','SE-5',false)}
    ${seLine(6,'Auto and Travel','SE-6',false)}
    ${seLine(7,'Cleaning and Maintenance','SE-7',false)}
    ${seLine(8,'Commissions','SE-8',false)}
    ${seLine(9,'Insurance','SE-9',false)}
    ${seLine(10,'Legal and Other Professional Fees','SE-10',false)}
    ${seLine(11,'Management Fees','SE-11',false)}
    ${seLine(12,'Mortgage Interest Paid to Banks','SE-12',false)}
    ${seLine(13,'Other Interest','SE-13',false)}
    ${seLine(14,'Repairs','SE-14',false)}
    ${seLine(15,'Supplies','SE-15',false)}
    ${seLine(16,'Taxes','SE-16',false)}
    ${seLine(17,'Utilities','SE-17',false)}
    ${seLine(18,'Depreciation Expense or Depletion','SE-18',false,deprTotal)}
    ${seLine('19a','Other Expenses (itemized below)','SE-19a',false)}`;

  // Total expenses including depreciation from schedule
  const txnExpOnly=Object.entries(byCode).filter(([k,v])=>k!=='SE-3'&&v<0).reduce((s,[,v])=>s+v,0);
  const totalExpSched=txnExpOnly-deprTotal; // deprTotal replaces SE-18 from txns
  const totalExpForSched=Math.abs(txnExpOnly-(byCode['SE-18']||0))+deprTotal;
  const line21=inc-totalExpForSched;

  // Depreciation detail per asset for this year
  const deprDetailRows=deprByAsset.length?deprByAsset.map(x=>{
    const prop=S.properties.find(p=>p.id===x.a.propId);
    const placedYrsAgo=year-x.sy;
    return`<tr>
      <td>${esc(x.a.desc)}</td>
      <td style="color:var(--muted);font-size:10px">${prop?esc(prop.name):'‚Äî'}</td>
      <td style="color:var(--muted)">${x.a.serviceDate||'‚Äî'} (${x.a.macrsCls}-yr ${x.a.method})</td>
      <td style="color:var(--muted)">Yr ${placedYrsAgo+1} of ${x.a.macrsCls}</td>
      <td class="pos" style="text-align:right">${f$(x.d)}</td>
    </tr>`;
  }).join(''):`<tr><td colspan="5" style="color:var(--muted)">No assets with depreciation in ${year}.</td></tr>`;

  const c=document.getElementById('stmt-out');if(!c)return;
  c.innerHTML=`
  <!-- PRINT HEADER -->
  <div class="print-only" style="text-align:center;padding:20px 0 12px;border-bottom:2px solid #333;margin-bottom:20px">
    <div style="font-family:'Playfair Display',serif;font-size:22px;font-weight:300">Funded Trust</div>
    <div style="font-size:11px;color:#666;margin-top:4px">${propLabel} ¬∑ ${periodLabel} ¬∑ IRS Schedule E (Form 1040)</div>
  </div>

  <!-- SUMMARY STATS -->
  <div class="stmt-sec">
    <div class="stmt-sec-hdr"><div class="stmt-sec-hdr-title">Portfolio Summary</div><div style="font-size:9px;color:var(--muted)">${propLabel} ¬∑ ${periodLabel}</div></div>
    <div class="stmt-sec-body">
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
        <div class="stat-box"><div class="stat-lbl">Total Value</div><div class="stat-val">${f$(tv)}</div></div>
        <div class="stat-box"><div class="stat-lbl">Total Debt</div><div class="stat-val neg">${f$(td2)}</div></div>
        <div class="stat-box"><div class="stat-lbl">Net Equity</div><div class="stat-val ${tv-td2>=0?'pos':'neg'}">${f$(tv-td2)}</div></div>
        <div class="stat-box"><div class="stat-lbl">Properties</div><div class="stat-val">${props.length}</div></div>
      </div>
    </div>
  </div>

  <!-- IRS SCHEDULE E MOCK -->
  <div class="stmt-sec">
    <div class="stmt-sec-hdr">
      <div>
        <div class="stmt-sec-hdr-title">IRS Schedule E (Form 1040) ‚Äî Part I</div>
        <div style="font-size:9px;color:var(--muted);margin-top:2px">Income or Loss From Rental Real Estate and Royalties ¬∑ Tax Year ${year}</div>
      </div>
      <div style="font-size:9px;color:var(--muted)">For informational purposes ¬∑ Verify with your CPA</div>
    </div>
    <div class="stmt-sec-body" style="padding:0">

      <!-- Property header row like real Sch E -->
      <div style="background:var(--surface2);padding:10px 18px;border-bottom:1px solid var(--border);display:grid;grid-template-columns:60px 1fr 130px;font-size:9px;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted)">
        <div>Line</div><div>Description</div><div style="text-align:right">Amount</div>
      </div>

      <div class="tw" style="padding:0 18px 18px">
        <table style="margin-top:0">
          <tbody style="font-size:12px">
            ${incomeSection}
            ${expSection}
            <!-- Line 20 Totals -->
            <tr style="background:var(--bg)"><td colspan="3" style="padding:4px 0"></td></tr>
            <tr class="tr-tot">
              <td style="font-size:10px;color:var(--muted)">Line 20</td>
              <td><strong>Total Expenses</strong> <span style="font-size:9px;color:var(--muted)">(add lines 5‚Äì19)</span></td>
              <td class="neg" style="text-align:right"><strong>${f$(totalExpForSched)}</strong></td>
            </tr>
            <tr class="${line21>=0?'':''}">
              <td style="font-size:10px;color:var(--muted)">Line 21</td>
              <td>Income or <span class="${line21<0?'neg':''}">Loss</span> ‚Äî Subtract Line 20 from Line 3</td>
              <td class="${line21>=0?'pos':'neg'}" style="text-align:right"><strong>${f$(line21)}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- NET SUMMARY BAR -->
      <div style="padding:14px 18px;background:var(--bg);border-top:1px solid var(--border);display:grid;grid-template-columns:repeat(4,1fr);gap:16px">
        <div><div class="net-lbl">Gross Rents (Line 3)</div><div class="net-val pos">${f$(inc)}</div></div>
        <div><div class="net-lbl">Total Expenses (Line 20)</div><div class="net-val neg">${f$(totalExpForSched)}</div></div>
        <div><div class="net-lbl">Depreciation (Line 18)</div><div class="net-val neg">${f$(deprTotal)}</div></div>
        <div><div class="net-lbl">Net Income / Loss (Line 21)</div><div class="net-val" style="color:${line21>=0?'var(--green)':'var(--red)'}">${f$(line21)}</div></div>
      </div>
    </div>
  </div>

  <!-- DEPRECIATION DETAIL ‚Äî Line 18 source -->
  <div class="stmt-sec">
    <div class="stmt-sec-hdr">
      <div class="stmt-sec-hdr-title">Line 18 Depreciation Detail ‚Äî ${year}</div>
      <div style="font-size:9px;color:var(--muted)">All assets active in tax year ${year} ¬∑ MACRS per IRS Rev. Proc. 87-57</div>
    </div>
    <div class="stmt-sec-body">
      <div style="font-size:10px;color:var(--muted);margin-bottom:12px">
        Includes <strong style="color:var(--white)">${deprByAsset.length}</strong> asset${deprByAsset.length!==1?'s':''} placed in service in prior years still in recovery, plus any placed in service in ${year}. Each asset contributes its year-specific MACRS rate √ó depreciable basis.
      </div>
      <div class="tw"><table>
        <thead><tr><th>Asset Description</th><th>Property</th><th>Placed in Service ¬∑ Class ¬∑ Method</th><th>Recovery Year</th><th style="text-align:right">${year} Deduction</th></tr></thead>
        <tbody>${deprDetailRows}</tbody>
        <tfoot><tr class="tr-tot"><td colspan="4"><strong>Total Line 18 ‚Äî Depreciation</strong></td><td class="neg" style="text-align:right"><strong>${f$(deprTotal)}</strong></td></tr></tfoot>
      </table></div>
      ${deprByAsset.length?`<div style="margin-top:10px;font-size:9px;color:var(--muted2)">
        ‚ñ≤ To see the full multi-year schedule per asset, go to the Depreciation section in the sidebar.
        Each asset's deduction continues until its recovery period ends (5yr, 7yr, 15yr, 27.5yr, 39yr).
        Changing the tax year filter above will recalculate every line automatically.
      </div>`:''}
    </div>
  </div>

  ${monthlyHTML}

  <!-- TRANSACTION DETAIL -->
  <div class="stmt-sec">
    <div class="stmt-sec-hdr"><div class="stmt-sec-hdr-title">Transaction Detail</div><div style="font-size:9px;color:var(--muted)">${txns.length} transactions ¬∑ ${periodLabel}</div></div>
    <div class="stmt-sec-body">
      ${!txns.length
        ?`<div style="color:var(--muted);font-size:11px">No transactions for this period.</div>`
        :`<div class="tw"><table>
          <thead><tr><th>Date</th><th>Property</th><th>Description</th><th>Schedule E Line</th><th style="text-align:right">Amount</th></tr></thead>
          <tbody>${txns.sort((a,b)=>new Date(a.date)-new Date(b.date)).map(t=>{
            const prop=S.properties.find(p=>p.id===t.propId);
            const irsEntry=IRS.find(x=>x.code===t.irsCode);
            const lineNum=t.irsCode?t.irsCode.replace('SE-','Line '):'‚Äî';
            return`<tr>
              <td>${t.date||'‚Äî'}</td>
              <td style="color:var(--muted);font-size:10px">${prop?esc(prop.name):'‚Äî'}</td>
              <td>${esc(t.desc||'‚Äî')}</td>
              <td><span class="badge bg-blue">${lineNum}</span>${irsEntry?` <span style="color:var(--muted);font-size:9px">${irsEntry.label}</span>`:''}</td>
              <td class="${+t.amount>=0?'pos':'neg'}" style="text-align:right">${f$(t.amount)}</td>
            </tr>`;
          }).join('')}</tbody>
          <tfoot><tr class="tr-tot"><td colspan="4">Total</td><td class="${noi>=0?'pos':'neg'}" style="text-align:right">${f$(noi)}</td></tr></tfoot>
        </table></div>`}
    </div>
  </div>`;
}

// helper ‚Äî hide zero-value Schedule E lines when empty (light styling)
const seZeroStyle=`<style>.se-zero td{color:var(--muted2)!important;font-style:italic}.se-zero td:last-child{color:var(--muted2)!important}</style>`;
document.head.insertAdjacentHTML('beforeend',seZeroStyle);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TENANTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTenants(){
  const active=S.tenants.filter(t=>t.status==='Active').length;
  const monthly=S.tenants.filter(t=>t.status==='Active').reduce((s,t)=>s+(+t.rent||0),0);
  const m=document.getElementById('re-main');
  m.innerHTML=`
  <div class="re-summary" style="grid-template-columns:repeat(3,1fr)">
    <div class="sum-cell"><div class="sum-lbl">Total Tenants</div><div class="sum-val neu">${S.tenants.length}</div></div>
    <div class="sum-cell"><div class="sum-lbl">Active Leases</div><div class="sum-val pos">${active}</div></div>
    <div class="sum-cell"><div class="sum-lbl">Monthly Rent Roll</div><div class="sum-val">${f$(monthly)}</div></div>
  </div>
  <div class="re-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div><div class="page-title">Tenant Management</div><div class="page-sub">All Properties</div></div>
      <div style="display:flex;gap:8px" class="no-print">
        <select class="fsel" id="t-pfil" onchange="filtTenants()"><option value="">All Properties</option>${S.properties.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('')}</select>
        <select class="fsel" id="t-sfil" onchange="filtTenants()"><option value="">All Statuses</option><option>Active</option><option>Notice Given</option><option>Month-to-Month</option><option>Vacated</option></select>
        <button class="btn-a" onclick="showAddTenantModal(null)">+ Add Tenant</button>
      </div>
    </div>
    <div id="tlist"></div>
  </div>`;
  filtTenants();
}

function filtTenants(){
  const pf=document.getElementById('t-pfil')?.value||'';
  const sf=document.getElementById('t-sfil')?.value||'';
  let tenants=[...S.tenants];
  if(pf)tenants=tenants.filter(t=>t.propId===pf);
  if(sf)tenants=tenants.filter(t=>t.status===sf);
  const c=document.getElementById('tlist');if(!c)return;
  if(!tenants.length){c.innerHTML=`<div class="empty"><span class="empty-icon">üë§</span>No tenants found. Click + Add Tenant to begin.</div>`;return;}
  c.innerHTML=tenants.map(t=>tenantCardHTML(t)).join('');
}
function tenantCardHTML(t){
  const prop=S.properties.find(p=>p.id===t.propId);
  const statusC={Active:'bg-green','Notice Given':'bg-yellow','Month-to-Month':'bg-blue',Vacated:'bg-red'};
  const leaseEnd=t.leaseEnd?new Date(t.leaseEnd):null;
  const daysLeft=leaseEnd?Math.ceil((leaseEnd-new Date())/(86400000)):null;
  return `<div class="tenant-card">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px">
      <div>
        <div class="tenant-name">${esc(t.firstName||'')} ${esc(t.lastName||'')}</div>
        <div class="tenant-meta">${prop?esc(prop.name):'‚Äî'} ${t.unit?'¬∑ '+esc(t.unit):''} ${t.email?'¬∑ '+esc(t.email):''}</div>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <span class="badge ${statusC[t.status]||'bg-blue'}">${t.status||'Active'}</span>
        <button class="xbtn no-print" onclick="delTenant('${t.id}')">‚úï</button>
      </div>
    </div>
    <div class="tig">
      <div class="ti-item"><div class="ti-lbl">Monthly Rent</div><div class="ti-val pos">${f$(t.rent)}</div></div>
      <div class="ti-item"><div class="ti-lbl">Security Deposit</div><div class="ti-val">${f$(t.deposit)}</div></div>
      <div class="ti-item"><div class="ti-lbl">Phone</div><div class="ti-val">${esc(t.phone||'‚Äî')}</div></div>
      <div class="ti-item"><div class="ti-lbl">Lease Start</div><div class="ti-val">${t.leaseStart||'‚Äî'}</div></div>
      <div class="ti-item"><div class="ti-lbl">Lease End</div><div class="ti-val ${daysLeft!==null&&daysLeft<60&&daysLeft>0?'neg':''}">${t.leaseEnd||'‚Äî'}${daysLeft!==null&&daysLeft>0?` <span style="font-size:9px">(${daysLeft}d)</span>`:''}</div></div>
      <div class="ti-item"><div class="ti-lbl">Annual Rent</div><div class="ti-val">${f$(+t.rent*12)}</div></div>
    </div>
    ${t.notes?`<div style="font-size:10px;color:var(--muted);padding-top:8px;border-top:1px solid var(--border)">${esc(t.notes)}</div>`:''}
  </div>`;
}
function renderPropTenantsTab(pid){
  const c=document.getElementById('ptwrap');if(!c)return;
  const tenants=S.tenants.filter(t=>t.propId===pid);
  const monthly=tenants.filter(t=>t.status==='Active').reduce((s,t)=>s+(+t.rent||0),0);
  c.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
    <div style="font-size:9px;color:var(--muted)">Rent Roll: <span class="pos">${f$(monthly)}/mo</span></div>
    <button class="btn-a no-print" onclick="showAddTenantModal('${pid}')">+ Add Tenant</button>
  </div>
  ${!tenants.length?`<div class="empty"><span class="empty-icon">üë§</span>No tenants for this property.</div>`
  :tenants.map(t=>tenantCardHTML(t)).join('')}`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PROPERTY CRUD
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showAddPropModal(){
  ['np-name','np-addr','np-notes','np-sqft','np-units'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  ['np-val','np-debt','np-pp','np-land'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='0';});
  document.getElementById('np-date').value=td();
  document.getElementById('modal-prop-title').textContent='Add Property';
  document.getElementById('edit-prop-id').value='';
  openModal('modal-prop');
}
function saveProp(){
  const name=document.getElementById('np-name').value.trim();
  if(!name){alert('Property name required.');return;}
  const eid=document.getElementById('edit-prop-id').value;
  const data={name,type:document.getElementById('np-type').value,addr:document.getElementById('np-addr').value.trim(),value:+document.getElementById('np-val').value||0,debt:+document.getElementById('np-debt').value||0,purchasePrice:+document.getElementById('np-pp').value||0,landValue:+document.getElementById('np-land').value||0,purchaseDate:document.getElementById('np-date').value,sqft:document.getElementById('np-sqft').value,units:document.getElementById('np-units').value.trim(),notes:document.getElementById('np-notes').value.trim()};
  if(eid){const p=S.properties.find(x=>x.id===eid);if(p){Object.assign(p,data);save();closeModal('modal-prop');renderSidebar();renderPropDetail(eid);toast('Saved!');return;}}
  const p={id:'p'+Date.now(),...data};S.properties.push(p);save();closeModal('modal-prop');renderSidebar();showPanel('prop',p.id);toast('Property added!');
}
function up(id,f,v){const p=S.properties.find(x=>x.id===id);if(p){p[f]=v;save();toast('Saved');}}
function deleteProp(id){if(!confirm('Delete property and all related data?'))return;S.properties=S.properties.filter(p=>p.id!==id);S.transactions=S.transactions.filter(t=>t.propId!==id);S.assets=S.assets.filter(a=>a.propId!==id);S.tenants=S.tenants.filter(t=>t.propId!==id);save();renderSidebar();showPanel('overview');toast('Property deleted.');}

// TENANT CRUD
function showAddTenantModal(pid){
  ['nt-first','nt-last','nt-phone','nt-email','nt-unit','nt-notes'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  ['nt-rent','nt-dep'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='0';});
  document.getElementById('nt-start').value=td();document.getElementById('nt-end').value='';
  const sel=document.getElementById('nt-prop');sel.innerHTML=`<option value="">‚Äî Select Property ‚Äî</option>${S.properties.map(p=>`<option value="${p.id}" ${p.id===pid?'selected':''}>${esc(p.name)}</option>`).join('')}`;
  openModal('modal-tenant');
}
function saveTenant(){
  const first=document.getElementById('nt-first').value.trim();if(!first){alert('First name required.');return;}
  const t={id:'tn'+Date.now(),propId:document.getElementById('nt-prop').value,firstName:first,lastName:document.getElementById('nt-last').value.trim(),phone:document.getElementById('nt-phone').value.trim(),email:document.getElementById('nt-email').value.trim(),leaseStart:document.getElementById('nt-start').value,leaseEnd:document.getElementById('nt-end').value,rent:+document.getElementById('nt-rent').value||0,deposit:+document.getElementById('nt-dep').value||0,unit:document.getElementById('nt-unit').value.trim(),status:document.getElementById('nt-status').value,notes:document.getElementById('nt-notes').value.trim()};
  S.tenants.push(t);save();closeModal('modal-tenant');
  if(document.getElementById('ptwrap'))renderPropTenantsTab(t.propId);
  else renderTenants();
  toast('Tenant added!');
}
function delTenant(id){
  const t=S.tenants.find(x=>x.id===id);
  if(!confirm('Remove tenant?'))return;
  S.tenants=S.tenants.filter(x=>x.id!==id);save();
  if(document.getElementById('tlist'))filtTenants();
  else if(t&&document.getElementById('ptwrap'))renderPropTenantsTab(t.propId);
  toast('Tenant removed.');
}

// ASSET CRUD
function showAddAssetModal(pid){
  ['na-desc','na-notes'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  document.getElementById('na-cost').value='0';document.getElementById('na-date').value=td();
  const sel=document.getElementById('na-prop');sel.innerHTML=`<option value="">‚Äî Select Property ‚Äî</option>${S.properties.map(p=>`<option value="${p.id}" ${p.id===pid?'selected':''}>${esc(p.name)}</option>`).join('')}`;
  document.getElementById('asset-preview').textContent='Enter cost and date to see preview.';
  openModal('modal-asset');
}
function assetPreview(){
  const cost=+document.getElementById('na-cost').value||0;
  const date=document.getElementById('na-date').value;
  const cls=document.getElementById('na-class').value;
  const method=document.getElementById('na-method').value;
  if(!cost||!date){document.getElementById('asset-preview').textContent='Enter cost and date to see preview.';return;}
  const ty=deprYr({cost,serviceDate:date,macrsCls:cls,method},CY);
  const cl=deprThru({cost,serviceDate:date,macrsCls:cls,method},CY);
  document.getElementById('asset-preview').innerHTML=`<span style="color:var(--blue2)">Preview:</span> ${f$(cost)} basis ¬∑ ${cls}-yr ¬∑ <strong class="pos">${f$(ty)}</strong> deduction this year (${CY}) ¬∑ ${f$(cl)} total claimed ¬∑ ${f$(Math.max(0,cost-cl))} remaining basis`;
}
function saveAsset(){
  const desc=document.getElementById('na-desc').value.trim();if(!desc){alert('Asset description required.');return;}
  const a={id:'a'+Date.now(),propId:document.getElementById('na-prop').value,desc,cost:+document.getElementById('na-cost').value||0,serviceDate:document.getElementById('na-date').value,macrsCls:document.getElementById('na-class').value,method:document.getElementById('na-method').value,convention:document.getElementById('na-conv').value,notes:document.getElementById('na-notes').value.trim()};
  S.assets.push(a);save();closeModal('modal-asset');
  if(document.getElementById('pdwrap'))renderPropDeprTab(a.propId);
  else renderDepreciation();
  toast('Asset added!');
}
function delAsset(id){if(!confirm('Remove asset?'))return;S.assets=S.assets.filter(a=>a.id!==id);save();if(document.getElementById('depr-wrap'))reDeprTable();toast('Asset removed.');}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// IMPORT TRANSACTION ‚Üí DEPRECIATION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function importTxnToDepr(txnId){
  const t=S.transactions.find(x=>x.id===txnId);
  if(!t){toast('Transaction not found.');return;}

  // Pre-fill the asset modal with data from the transaction
  const amt=Math.abs(+t.amount)||0;
  const sel=document.getElementById('na-prop');
  sel.innerHTML=`<option value="">‚Äî Select Property ‚Äî</option>${S.properties.map(p=>`<option value="${p.id}" ${p.id===t.propId?'selected':''}>${esc(p.name)}</option>`).join('')}`;

  document.getElementById('na-desc').value=t.desc||'Depreciation Asset';
  document.getElementById('na-cost').value=amt;
  document.getElementById('na-date').value=t.date||td();
  document.getElementById('na-notes').value=`Imported from Finance ‚Äî ${t.date||''} ‚Äî IRS SE-18`;

  // Default to 27.5yr residential ‚Äî user can change
  document.getElementById('na-class').value='27.5';
  document.getElementById('na-method').value='MACRS';
  document.getElementById('na-conv').value='MM';

  assetPreview();
  openModal('modal-asset');

  // After modal opens, show a note
  setTimeout(()=>{
    const prev=document.getElementById('asset-preview');
    if(prev)prev.innerHTML=`<span style="color:var(--yellow)">‚ö† Imported from expense transaction (${t.date}) ‚Äî ${esc(t.desc||'')} ¬∑ ${f$(amt)}.</span> Adjust MACRS class and method as needed, then save.`;
  },50);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// UTILS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function f$(v){return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0,maximumFractionDigits:0}).format(+v||0);}
function td(){return new Date().toISOString().split('T')[0];}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function sum(arr,k){return arr.reduce((s,x)=>s+(+x[k]||0),0);}
function getYears(){const y=new Set([CY]);S.transactions.forEach(t=>{if(t.date)y.add(parseInt(t.date));});return[...y].sort((a,b)=>b-a);}
function openModal(id){document.getElementById(id)?.classList.add('open');}
function closeModal(id){document.getElementById(id)?.classList.remove('open');}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2400);}
document.querySelectorAll('.modal-ov').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));
document.getElementById('na-cost').addEventListener('input',assetPreview);
document.getElementById('na-date').addEventListener('change',assetPreview);
document.getElementById('na-class').addEventListener('change',assetPreview);
document.getElementById('na-method').addEventListener('change',assetPreview);
</script>
</body>
</html>
